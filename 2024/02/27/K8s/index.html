<!DOCTYPE html>
<html lang="zh_CN">
    <!-- title -->


    

<!-- keywords -->



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="王盛">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="王盛">
    
        <meta name="keywords" content="容器,云计算,云原生">
    
    <meta name="description" content="">
    <meta name="description" content="如果出现无法载图的情况，请检查与github的连通性 注：本文较长，建议配合右侧目录食用 关于docker的详细基础可以看另外一篇博文，这里只介绍与k8s相关的部分，以及做一些补充 k8s搭建k8s1.20搭建环境VMware Workstation 17 ProCentOS Linux release 7.9.2009 (Core)4G，8Core，100G精简置备NAT网络 192.168.8">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s基础知识">
<meta property="og:url" content="https://akemi.zj.cn/2024/02/27/K8s/index.html">
<meta property="og:site_name" content="Akemi">
<meta property="og:description" content="如果出现无法载图的情况，请检查与github的连通性 注：本文较长，建议配合右侧目录食用 关于docker的详细基础可以看另外一篇博文，这里只介绍与k8s相关的部分，以及做一些补充 k8s搭建k8s1.20搭建环境VMware Workstation 17 ProCentOS Linux release 7.9.2009 (Core)4G，8Core，100G精简置备NAT网络 192.168.8">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174238.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/image.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174754.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174831.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/Untitled.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426204105.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403170630.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403170721.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403171121.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403171510.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403171725.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419170550.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171501.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171524.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171652.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171823.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171849.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171928.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419172049.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419172243.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419172442.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161409.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161453.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161516.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161534.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161548.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419184100.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211032.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211102.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211503.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211534.png">
<meta property="article:published_time" content="2024-02-27T08:39:48.000Z">
<meta property="article:modified_time" content="2025-02-20T10:37:27.600Z">
<meta property="article:author" content="王盛">
<meta property="article:tag" content="云原生">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174238.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/akemi.ico">
    
    <title>k8s基础知识 · Akemi</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link rel="preload" href="/css/style.css?v=20211217" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/css/dark.css?v=20211217" as="style">
    <link rel="stylesheet" href="/css/dark.css">
    <link rel="stylesheet" href="/css/mobile.css?v=20211217" media="(max-width: 960px)">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js?v=20211217" as="script">
    <link rel="preload" href="/scripts/dark.js?v=20211217" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 7.2.0"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
    
        <body class="post-body">
    
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
            <div class="header-sidebar-menu">
        
            
                <div style="padding-left: 1px;">&#xe775;</div>
            
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href=/>Akemi</a>
        </span>
    </div>
    <!-- toggle banner for post layout -->
    
        
            <div class="banner banner-clean">
        
            <div class="blog-title header-element">
                <a href="/">Akemi</a>
            </div>
            <div class="post-title header-element">
                <a href="#" class="post-name">k8s基础知识</a>
            </div>
        </div>
    
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- back to top button -->
    <div class="footer-fixed-element">
        
            <div class="back-top back-top-hidden">
        
        
            <div>&#xe639;</div>
        
        </div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="







    height:50vh;

">
    
    <!-- 主页  -->
    
        
    <!-- 404页  -->
    
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
                k8s基础知识
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
                
            <!-- 404 -->
            
        </p>
        <!-- 文章页 meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
    
        <a class="post-tag" href="javascript:void(0);" data-tags="云原生">云原生</a>
    
</div>

                
                <!-- 文章字数统计 -->
                
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2024/02/27</span>
                    <!-- busuanzi -->
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <p><strong>如果出现无法载图的情况，请检查与github的连通性</strong></p>
<p>注：本文较长，建议配合右侧目录食用</p>
<p><strong>关于docker的详细基础可以看另外一篇博文，这里只介绍与k8s相关的部分，以及做一些补充</strong></p>
<h1 id="k8s搭建"><a href="#k8s搭建" class="headerlink" title="k8s搭建"></a>k8s搭建</h1><h2 id="k8s1-20搭建"><a href="#k8s1-20搭建" class="headerlink" title="k8s1.20搭建"></a>k8s1.20搭建</h2><p>环境<br>VMware Workstation 17 Pro<br>CentOS Linux release 7.9.2009 (Core)<br>4G，8Core，100G精简置备<br>NAT网络 192.168.8.0&#x2F;24<br>pod网段 10.10.0.0&#x2F;16<br>ServiceSubnet网段 10.96.0.0&#x2F;12 默认<br>ws-k8s-master1 192.168.8.151<br>ws-k8s-node1 192.168.8.152<br>ws-k8s-node2 192.168.8.153</p>
<h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master节点</span></span><br><span class="line">hostnamectl set-hostname ws-k8s-master1  &amp;&amp; bash</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">192.168.8.151 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.8.152 ws-k8s-node1 </span></span><br><span class="line"><span class="string">192.168.8.153 ws-k8s-node2 </span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="comment">#通过使用NetworkManager，或networkd调整网络配置，都可以</span></span><br><span class="line">nmcli con modify ens33 ipv4.addresses 192.168.8.151/24 ipv4.gateway 192.168.8.2 ipv4.dns 192.168.8.2 ipv4.method manual</span><br><span class="line">nmcli con up ens33</span><br><span class="line"><span class="comment">#安全相关</span></span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now <span class="comment">#不是一定要关闭</span></span><br><span class="line">yum -y update</span><br><span class="line"><span class="comment">#通过将ssh-keygen生成密钥对并将本地公钥复制到远程主机</span></span><br><span class="line"><span class="comment">#输入yes，无密码</span></span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id ws-k8s-node1</span><br><span class="line">ssh-copy-id ws-k8s-node2</span><br><span class="line"><span class="comment">#k8s默认不允许使用交换分区</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab <span class="comment">#注释掉fstab文件的最后一行swap的内容</span></span><br><span class="line"><span class="comment">#先加载br_netfilter模块，防止写入内核时报错</span></span><br><span class="line">modprobe br_netfilter <span class="comment">#暂时加载</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;modprobe br_netfilter&quot;</span> &gt;&gt; /etc/profile <span class="comment">#永久加载</span></span><br><span class="line"><span class="comment">#修改配置文件并将其载入内核，允许linux进行路由转发</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">&quot;</span>  &gt;&gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="comment">#添加阿里源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line"><span class="comment">#安装k8s组件源，并通过scp传送到node1和node2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">scp /etc/yum.repos.d/kubernetes.repo ws-k8s-node1:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/kubernetes.repo ws-k8s-node2:/etc/yum.repos.d/</span><br><span class="line"><span class="comment">#时钟同步，注释掉默认服务器，并使用cn.pool.ntp.org</span></span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line">systemctl restart chronyd</span><br><span class="line"><span class="comment">#安装docker-ce</span></span><br><span class="line">yum -y install docker-ce</span><br><span class="line">systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="comment">#配置docker镜像加速，这是我的阿里云镜像加速器，修改docker驱动为systemd</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span> &gt; /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">#node1</span></span><br><span class="line">hostnamectl set-hostname ws-k8s-node1 &amp;&amp; bash</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">192.168.8.151 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.8.152 ws-k8s-node1 </span></span><br><span class="line"><span class="string">192.168.8.153 ws-k8s-node2</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">nmcli con modify ens33 ipv4.addresses 192.168.8.152/24 ipv4.gateway 192.168.8.2 ipv4.dns 192.168.8.2 ipv4.method manual</span><br><span class="line">nmcli con up ens33</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line">yum -y update</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id ws-k8s-node2</span><br><span class="line">ssh-copy-id ws-k8s-master1</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;modprobe br_netfilter&quot;</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">&quot;</span>  &gt;&gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line">systemctl restart chronyd</span><br><span class="line">wget -O get-docker.sh https://get.docker.com</span><br><span class="line">sh get-docker.sh</span><br><span class="line">systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span> &gt; /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">#node2</span></span><br><span class="line">hostnamectl set-hostname ws-k8s-node2 &amp;&amp; bash</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">192.168.8.151 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.8.152 ws-k8s-node1 </span></span><br><span class="line"><span class="string">192.168.8.153 ws-k8s-node2</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">nmcli con modify ens33 ipv4.addresses 192.168.8.153/24 ipv4.gateway 192.168.8.2 ipv4.dns 192.168.8.2 ipv4.method manual</span><br><span class="line">nmcli con up ens33</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</span><br><span class="line">yum -y update</span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id ws-k8s-node1</span><br><span class="line">ssh-copy-id ws-k8s-master1</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;modprobe br_netfilter&quot;</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">&quot;</span>  &gt;&gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line">systemctl restart chronyd</span><br><span class="line">wget -O get-docker.sh https://get.docker.com</span><br><span class="line">sh get-docker.sh</span><br><span class="line">systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span> &gt; /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="主节点安装k8s"><a href="#主节点安装k8s" class="headerlink" title="主节点安装k8s"></a>主节点安装k8s</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master节点</span></span><br><span class="line"><span class="comment">#安装基础包，版本为1.20.6，这个版本支持docker，1.24后不支持docker支持container</span></span><br><span class="line"><span class="comment">#kubeadm用以初始化集群，这三个版本需要大于k8s版本，建议保持一致</span></span><br><span class="line"><span class="comment">#kubelet用以启动pod</span></span><br><span class="line"><span class="comment">#kubectl用以管理k8s</span></span><br><span class="line">yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成一个配置文件，并修改</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line">vim kubeadm.yaml</span><br><span class="line">advertiseAddress: 192.168.8.151 <span class="comment">#控制节点ip</span></span><br><span class="line">name: ws-k8s-master1 <span class="comment">#控制节点主机名</span></span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers <span class="comment">#a阿里云镜像仓库</span></span><br><span class="line">kubernetesVersion: v1.20.6 <span class="comment">#版本号1.20.6</span></span><br><span class="line">在networking中增加并对齐</span><br><span class="line">podSubnet: 10.10.0.0/16 <span class="comment">#指定pod网段</span></span><br><span class="line">注释criSocket这一行 <span class="comment">#这行是用containerd的</span></span><br><span class="line"><span class="comment">#ipvs表示kube-proxy代理模式为ipvs</span></span><br><span class="line"><span class="comment">#cgroup驱动使用systemd</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">mode: ipvs</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">cgroupDriver: systemd</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; kubeadm.yaml</span><br><span class="line"><span class="comment">#通过kubeadm.yaml文件初始化k8s，忽略系统验证（System Verification）的预检错误。</span></span><br><span class="line">kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#安装完成，如图</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据安装完成后的提示进行配置</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="comment">#NAME             STATUS     ROLES                  AGE     VERSION</span></span><br><span class="line"><span class="comment">#ws-k8s-master1   NotReady   control-plane,master   5m11s   v1.20.6</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174238.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/image.png"></p>
<h3 id="工作节点添加"><a href="#工作节点添加" class="headerlink" title="工作节点添加"></a>工作节点添加</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加工作节点</span></span><br><span class="line"><span class="comment">#master节点生成token</span></span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"><span class="comment">#kubeadm join 192.168.8.151:6443 --token j7k3oa.761wztev8dgrqv59     --discovery-token-ca-cert-hash sha256:800f4cd804c2e7fbcdbb3d5bc163f38368efd65043476404e578e0ffa8529bbf</span></span><br><span class="line"><span class="comment">#node1</span></span><br><span class="line">yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.151:6443 --token j7k3oa.761wztev8dgrqv59 \</span><br><span class="line">--discovery-token-ca-cert-hash \</span><br><span class="line">sha256:800f4cd804c2e7fbcdbb3d5bc163f38368efd65043476404e578e0ffa8529bbf \</span><br><span class="line">--ignore-preflight-errors=SystemVerification</span><br><span class="line"><span class="comment">#node2</span></span><br><span class="line">yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.151:6443 --token j7k3oa.761wztev8dgrqv59 \</span><br><span class="line">--discovery-token-ca-cert-hash \</span><br><span class="line">sha256:800f4cd804c2e7fbcdbb3d5bc163f38368efd65043476404e578e0ffa8529bbf \</span><br><span class="line">--ignore-preflight-errors=SystemVerification</span><br><span class="line"><span class="comment">#master</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME             STATUS     ROLES                  AGE   VERSION</span><br><span class="line">ws-k8s-master1   NotReady   control-plane,master   21m   v1.20.6</span><br><span class="line">ws-k8s-node1     NotReady   &lt;none&gt;                 98s   v1.20.6</span><br><span class="line">ws-k8s-node2     NotReady   &lt;none&gt;                 60s   v1.20.6</span><br><span class="line"><span class="comment">#添加完成，但是NotReady</span></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7f89b7bc75-6ntkb                 0/1     Pending   0          12m</span><br><span class="line">coredns-7f89b7bc75-cph9t                 0/1     Pending   0          12m</span><br><span class="line">etcd-ws-k8s-master1                      1/1     Running   0          12m</span><br><span class="line">kube-apiserver-ws-k8s-master1            1/1     Running   1          12m</span><br><span class="line">kube-controller-manager-ws-k8s-master1   1/1     Running   0          12m</span><br><span class="line">kube-proxy-2sltc                         1/1     Running   0          12m</span><br><span class="line">kube-scheduler-ws-k8s-master1            1/1     Running   0          12m</span><br><span class="line"><span class="comment">#安装完成后coredns服务由于没有网络插件，没有ip，所以显示离线pending </span></span><br></pre></td></tr></table></figure>

<h3 id="calico网络插件"><a href="#calico网络插件" class="headerlink" title="calico网络插件"></a>calico网络插件</h3><p>Calico通过calico.yaml配置文件<br>通过kubectl apply -f calico.yaml进行安装<br>#<a target="_blank" rel="noopener" href="https://docs.projectcalico.org/manifests/calico.yaml">https://docs.projectcalico.org/manifests/calico.yaml</a></p>
<h4 id="一些参数"><a href="#一些参数" class="headerlink" title="一些参数"></a>一些参数</h4><p>CALICO_IPV4POOL_IPIP：是否启用IPIP模式，默认采用IPIP<br>使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Always”，IPIP模式，封装隧道<br>不使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Off”，BGP模式，使用物理机作为vRouter，需要二层互通</p>
<p>IP_AUTODETECTION_METHOD：获取Node IP地址的方式，默认使用第1个网络接口的IP地址<br>对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如”interface&#x3D;eth.*”表示选择名称以eth开头的网卡的IP地址。</p>
<ul>
<li>name: IP_AUTODETECTION_METHOD<br> value: “interface&#x3D;ens33”</li>
</ul>
<h4 id="Calico组件"><a href="#Calico组件" class="headerlink" title="Calico组件"></a>Calico组件</h4><p>1、felix<br>每个host会有agent，负责互通，接口管理与监听等<br>2、etcd<br>分布式数据库，负责数据同步<br>3、BGP client（BIRD）<br>每个host会有一个BIRD，负责分发信息<br>4、BGP Route Rreflector<br>网络的镜像转发器，用于大规模网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME             STATUS     ROLES                  AGE   VERSION</span><br><span class="line">ws-k8s-master1   NotReady   control-plane,master   21m   v1.20.6</span><br><span class="line">ws-k8s-node1     NotReady   &lt;none&gt;                 98s   v1.20.6</span><br><span class="line">ws-k8s-node2     NotReady   &lt;none&gt;                 60s   v1.20.6</span><br><span class="line"><span class="comment">#添加完成，但是NotReady</span></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7f89b7bc75-6ntkb                 0/1     Pending   0          12m</span><br><span class="line">coredns-7f89b7bc75-cph9t                 0/1     Pending   0          12m</span><br><span class="line">etcd-ws-k8s-master1                      1/1     Running   0          12m</span><br><span class="line">kube-apiserver-ws-k8s-master1            1/1     Running   1          12m</span><br><span class="line">kube-controller-manager-ws-k8s-master1   1/1     Running   0          12m</span><br><span class="line">kube-proxy-2sltc                         1/1     Running   0          12m</span><br><span class="line">kube-scheduler-ws-k8s-master1            1/1     Running   0          12m</span><br><span class="line"><span class="comment">#安装完成后coredns服务由于没有网络插件，没有ip，所以显示离线pending </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master添加k8s网络组件Calico</span></span><br><span class="line"><span class="comment">#https://docs.projectcalico.org/manifests/calico.yaml</span></span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME             STATUS   ROLES                  AGE   VERSION</span><br><span class="line">ws-k8s-master1   Ready    control-plane,master   34m   v1.20.6</span><br><span class="line">ws-k8s-node1     Ready    &lt;none&gt;                 14m   v1.20.6</span><br><span class="line">ws-k8s-node2     Ready    &lt;none&gt;                 13m   v1.20</span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-z9gk4   1/1     Running   0          4m15s</span><br><span class="line">calico-node-d6mvs                          1/1     Running   0          4m15s</span><br><span class="line">calico-node-sx4t8                          1/1     Running   0          4m15s</span><br><span class="line">calico-node-vdxvc                          1/1     Running   0          4m15s</span><br><span class="line">coredns-7f89b7bc75-6ntkb                   1/1     Running   0          35m</span><br><span class="line">coredns-7f89b7bc75-cph9t                   1/1     Running   0          35m</span><br><span class="line">etcd-ws-k8s-master1                        1/1     Running   0          36m</span><br><span class="line">kube-apiserver-ws-k8s-master1              1/1     Running   1          36m</span><br><span class="line">kube-controller-manager-ws-k8s-master1     1/1     Running   0          36m</span><br><span class="line">kube-proxy-2sltc                           1/1     Running   0          35m</span><br><span class="line">kube-proxy-ndfn7                           1/1     Running   0          15m</span><br><span class="line">kube-proxy-rmdfb                           1/1     Running   0          16m</span><br><span class="line">kube-scheduler-ws-k8s-master1              1/1     Running   0          36m</span><br><span class="line"><span class="comment">#全部在线</span></span><br></pre></td></tr></table></figure>

<h2 id="k8s1-26搭建"><a href="#k8s1-26搭建" class="headerlink" title="k8s1.26搭建"></a>k8s1.26搭建</h2><p>环境<br>VMware Workstation 17 Pro<br>CentOS Linux release 7.9.2009 (Core)<br>4G，8Core，100G精简置备<br>NAT网络 192.168.8.0&#x2F;24<br>pod网段 10.10.0.0&#x2F;16<br>ServiceSubnet网段 10.96.0.0&#x2F;12 默认<br>ws-k8s-master1 192.168.8.160<br>ws-k8s-master2 192.168.8.159<br>ws-k8s-node1 192.168.8.161<br>ws-k8s-node2 192.168.8.162</p>
<h3 id="环境初始化-1"><a href="#环境初始化-1" class="headerlink" title="环境初始化"></a>环境初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master节点</span></span><br><span class="line">hostnamectl set-hostname ws-k8s-master1  &amp;&amp; bash</span><br><span class="line">nmcli con modify ens33 ipv4.addresses 192.168.8.160/24 ipv4.gateway 192.168.8.2 ipv4.dns 192.168.8.2 ipv4.method manual</span><br><span class="line">nmcli con up ens33</span><br><span class="line">yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm</span><br><span class="line">yum -y update</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">192.168.8.160 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.8.161 ws-k8s-node1 </span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id ws-k8s-node1</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">#node节点</span></span><br><span class="line">hostnamectl set-hostname ws-k8s-node1 &amp;&amp; bash</span><br><span class="line">nmcli con modify ens33 ipv4.addresses 192.168.8.161/24 ipv4.gateway 192.168.8.2 ipv4.dns 192.168.8.2 ipv4.method manual</span><br><span class="line">nmcli con up ens33</span><br><span class="line">yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm</span><br><span class="line">yum -y update</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">192.168.8.160 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.8.161 ws-k8s-node1 </span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="安装containerd"><a href="#安装containerd" class="headerlink" title="安装containerd"></a>安装containerd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master</span></span><br><span class="line">yum install -y containerd.io-1.6.6</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line"><span class="comment">#配置镜像加速器</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[host.&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;]</span></span><br><span class="line"><span class="string"> &#x27;</span>&gt;&gt; /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line"><span class="comment">#生成containerd配置文件</span></span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">修改</span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">SystemdCgroup = True</span><br><span class="line">sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line">config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span> <span class="comment">#配置镜像加速器</span></span><br><span class="line">systemctl <span class="built_in">enable</span> containerd.service --now</span><br><span class="line"><span class="comment">#创建crictl.yaml，指定创建pod与调用容器的时候使用containerd</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#重启服务加载文件</span></span><br><span class="line">systemctl restart containerd</span><br><span class="line"><span class="comment">#安装docker，要使用docker的build制作镜像功能</span></span><br><span class="line">yum install -y docker-ce &amp;&amp; systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="comment">#配置docker镜像加速器</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;&quot;registry-mirrors&quot;: [&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> &gt; /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#node1</span></span><br><span class="line">yum install -y containerd.io-1.6.6</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">修改 </span><br><span class="line">SystemdCgroup = True</span><br><span class="line">sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line">config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[host.&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;]</span></span><br><span class="line"><span class="string"> &#x27;</span>&gt;&gt; /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line">systemctl <span class="built_in">enable</span> containerd.service --now</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl restart containerd</span><br><span class="line">yum install -y docker-ce &amp;&amp; systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;&quot;registry-mirrors&quot;: [&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> &gt; /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="安装k8s"><a href="#安装k8s" class="headerlink" title="安装k8s"></a>安装k8s</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master、node</span></span><br><span class="line"><span class="comment">#安装管理工具126版本</span></span><br><span class="line">yum install -y kubelet-1.26.0 <span class="comment">#用于启动Pod</span></span><br><span class="line">yum install -y kubeadm-1.26.0 <span class="comment">#初始化工具</span></span><br><span class="line">yum install -y kubectl-1.26.0 <span class="comment">#管理的命令行工具</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"><span class="comment">#设置容器运行时，指定了容器运行时的通信端点地址，指定Unix域套接字协议和路径</span></span><br><span class="line">crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line"><span class="comment">#master</span></span><br><span class="line"><span class="comment">#创建配置文件，修改，并根据配置文件安装k8s</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line">vim kubeadm.yaml</span><br><span class="line">修改：</span><br><span class="line">advertiseAddress: 192.168.8.160 <span class="comment">#master IP</span></span><br><span class="line">criSocket: unix:///run/containerd/containerd.sock</span><br><span class="line">name: ws-k8s-master1 <span class="comment">#主机名</span></span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers <span class="comment">#换源k8s</span></span><br><span class="line">kubernetesVersion: 1.26.0 <span class="comment">#版本</span></span><br><span class="line">在networking下添加：</span><br><span class="line">podSubnet: 10.10.0.0/16 <span class="comment">#添加pod网段</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;---</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">mode: ipvs                   #kube代理模式为ipvs</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration   #cgroup驱动使用systemd</span></span><br><span class="line"><span class="string">cgroupDriver: systemd&#x27;</span> &gt;&gt; kubeadm.yaml</span><br><span class="line"><span class="comment">#通过kebeadm.yaml初始化k8s集群，且忽略系统预检错误</span></span><br><span class="line">kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification</span><br><span class="line"><span class="comment">#对kubectl进行授权</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube </span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl get nodes</span><br><span class="line">kubeadm token create --print-join-command <span class="comment">#生成token</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用token在node1上把node1加入集群</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.160:6443 --token oa7h1w.79oq2ol0w3jqcgud \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:d1a70285365b4769a7b8527bb426039010c615e2c96410bbef88656103246362 \</span><br><span class="line">--ignore-preflight-errors=SystemVerification</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174754.png"></p>
<h3 id="安装Calico"><a href="#安装Calico" class="headerlink" title="安装Calico"></a>安装Calico</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master</span></span><br><span class="line">kubectl get node</span><br><span class="line">NAME             STATUS     ROLES           AGE   VERSION</span><br><span class="line">ws-k8s-master1   NotReady   control-plane   30m   v1.26.0</span><br><span class="line">ws-k8s-node1     NotReady   &lt;none&gt;          28m   v1.26.0</span><br><span class="line">kubectl get pods -n kube-system -owide</span><br><span class="line">NAME                                      READY   STATUS     RESTARTS   AGE    IP              NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-567c556887-9v7nk                  0/1     Pending    0          29m    &lt;none&gt;          &lt;none&gt;           &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-567c556887-z7b9x                  0/1     Pending    0          29m    &lt;none&gt;          &lt;none&gt;           &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-ws-k8s-master1                       1/1     Running    0          29m    192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-ws-k8s-master1             1/1     Running    0          29m    192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-ws-k8s-master1    1/1     Running    0          29m    192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-bg7ck                          1/1     Running    0          29m    192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-s22ng                          1/1     Running    1          28m    192.168.8.161   ws-k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-ws-k8s-master1             1/1     Running    0          29m    192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment">#需要Calico插件，来让coredns获得IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装Calico</span></span><br><span class="line"><span class="comment">#https://docs.tigera.io/calico/latest/manifests/calico.yaml</span></span><br><span class="line"><span class="comment">#calico配置文件- name: CALICO_IPV4POOL_IPIP ——选择IPIP或BGP模式</span></span><br><span class="line"><span class="comment">#calico配置文件- name: IP_AUTODETECTION_METHOD ——选择能联网的首块网卡</span></span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"><span class="comment">#一直处于初始化状态，卡住了</span></span><br><span class="line">kubectl get pods -n kube-system -owide</span><br><span class="line">NAME                                      READY   STATUS     RESTARTS   AGE     IP              NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-d886b8fff-795k8   0/1     Pending    0          4m33s   &lt;none&gt;          &lt;none&gt;           &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-hcfmw                         0/1     Init:0/3   0          4m32s   192.168.8.161   ws-k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-vds28                         0/1     Init:0/3   0          4m33s   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment">#重新删除pods</span></span><br><span class="line">kubectl delete -f  calico.yaml</span><br><span class="line"><span class="comment">#使用离线calico镜像包,https://github.com/projectcalico/calico/releases/tag/v3.27.0/release-v3.27.0.tgz</span></span><br><span class="line">ctr -n=k8s.io images import calico.tar.gz</span><br><span class="line">kubectl apply -f  calico.yaml</span><br><span class="line"><span class="comment">#但node1一直有问题无法连接，尝试从头开始安装node1</span></span><br><span class="line"><span class="comment">#重装node1后成功</span></span><br><span class="line">kubectl get pods -n kube-system -owide</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE   IP              NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-d886b8fff-nc6mm   1/1     Running   0          21s   10.10.179.1     ws-k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-4rj9m                         1/1     Running   0          21s   192.168.8.161   ws-k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-gn6gm                         1/1     Running   0          21s   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-567c556887-9v7nk                  1/1     Running   0          77m   10.10.189.193   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-567c556887-z7b9x                  1/1     Running   0          77m   10.10.189.194   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-ws-k8s-master1                       1/1     Running   0          77m   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-ws-k8s-master1             1/1     Running   0          77m   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-ws-k8s-master1    1/1     Running   0          77m   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-bg7ck                          1/1     Running   0          77m   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-s22ng                          1/1     Running   0          75m   192.168.8.161   ws-k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-ws-k8s-master1             1/1     Running   0          77m   192.168.8.160   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@ws-k8s-master1 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME             STATUS   ROLES           AGE   VERSION</span><br><span class="line">ws-k8s-master1   Ready    control-plane   77m   v1.26.0</span><br><span class="line">ws-k8s-node1     Ready    &lt;none&gt;          76m   v1.26.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="comment">#node，从dockerhub拉取busybox的镜像</span></span><br><span class="line">ctr -n k8s.io images pull docker.io/library/busybox:1.28</span><br><span class="line"><span class="comment">#mastaer，启动pod</span></span><br><span class="line">kubectl run busybox --image docker.io/library/busybox:1.28 \</span><br><span class="line">--image-pull-policy=IfNotPresent --restart=Never --<span class="built_in">rm</span> -it busybox -- sh</span><br><span class="line">ping www.baidu.com <span class="comment">#能连外网</span></span><br><span class="line">64 bytes from 180.101.50.188: <span class="built_in">seq</span>=0 ttl=127 time=22.460 ms</span><br><span class="line">64 bytes from 180.101.50.188: <span class="built_in">seq</span>=1 ttl=127 time=16.696 ms</span><br><span class="line"></span><br><span class="line">nslookup kubernetes.default.svc.cluster.local  <span class="comment">#解析域名</span></span><br><span class="line">Server:    10.96.0.10    <span class="comment">#dns服务器</span></span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default.svc.cluster.local</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240227174831.png"></p>
<h3 id="ctr和crictl的区别"><a href="#ctr和crictl的区别" class="headerlink" title="ctr和crictl的区别"></a>ctr和crictl的区别</h3><p>ctr是containerd自带的CLI命令行工具<br>crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互；<br>ctr拉取镜像需要指定-n k8s.io中，创建pod时就可以调用镜像</p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/Untitled.png"></p>
<h3 id="扩容k8s集群"><a href="#扩容k8s集群" class="headerlink" title="扩容k8s集群"></a>扩容k8s集群</h3><h4 id="添加工作节点"><a href="#添加工作节点" class="headerlink" title="添加工作节点"></a>添加工作节点</h4><p>192.168.8.162 ws-k8s-node2 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;192.168.8.161 ws-k8s-node2</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">ssh-copy-id ws-k8s-node2</span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"><span class="comment">#kubeadm join 192.168.8.160:6443 --token h5lkkm.dsybifhcfj9okvbj \</span></span><br><span class="line"><span class="comment">#--discovery-token-ca-cert-hash sha256:d1a70285365b4769a7b8527bb426039010c615e2c96410bbef88656103246362 \</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;192.168.8.161 ws-k8s-node2</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">#node2</span></span><br><span class="line">hostnamectl set-hostname ws-k8s-node2 &amp;&amp; bash</span><br><span class="line">nmcli con modify ens33 ipv4.addresses 192.168.8.162/24 ipv4.gateway 192.168.8.2 ipv4.dns 192.168.8.2 ipv4.method manual</span><br><span class="line">nmcli con up ens33</span><br><span class="line">yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm</span><br><span class="line">yum -y update</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">192.168.8.160 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.8.161 ws-k8s-node1</span></span><br><span class="line"><span class="string">192.168.8.161 ws-k8s-node2</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line"></span><br><span class="line">yum install -y containerd.io-1.6.6</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">修改 </span><br><span class="line">SystemdCgroup = True</span><br><span class="line">sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line">config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[host.&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;]</span></span><br><span class="line"><span class="string"> &#x27;</span>&gt;&gt; /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line">systemctl <span class="built_in">enable</span> containerd.service --now</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl restart containerd</span><br><span class="line">yum install -y docker-ce &amp;&amp; systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;&quot;registry-mirrors&quot;: [&quot;https://bsx9xf1d.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> &gt; /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">yum install -y kubelet-1.26.0 kubeadm-1.26.0 kubectl-1.26.0</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">reboot</span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.160:6443 --token h5lkkm.dsybifhcfj9okvbj \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:d1a70285365b4769a7b8527bb426039010c615e2c96410bbef88656103246362 \</span><br></pre></td></tr></table></figure>

<h2 id="k8s1-28高可用搭建"><a href="#k8s1-28高可用搭建" class="headerlink" title="k8s1.28高可用搭建"></a>k8s1.28高可用搭建</h2><h3 id="master1"><a href="#master1" class="headerlink" title="master1"></a>master1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname ws-k8s-master1  &amp;&amp; bash</span><br><span class="line">nmcli con modify ens18 ipv4.addresses 192.168.10.121/24 ipv4.gateway 192.168.10.1 ipv4.dns 192.168.1.1 ipv4.method manual</span><br><span class="line">nmcli con up ens18</span><br><span class="line">yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm</span><br><span class="line">yum -y update</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span></span><br><span class="line"><span class="string">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span></span><br><span class="line"><span class="string">192.168.10.100 1panel</span></span><br><span class="line"><span class="string">192.168.10.120 pve</span></span><br><span class="line"><span class="string">192.168.10.121 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.10.122 ws-k8s-master2</span></span><br><span class="line"><span class="string">192.168.10.123 ws-k8s-master3</span></span><br><span class="line"><span class="string">192.168.10.130 harbor</span></span><br><span class="line"><span class="string">192.168.10.131 ws-k8s-node1</span></span><br><span class="line"><span class="string">192.168.10.132 ws-k8s-node2</span></span><br><span class="line"><span class="string">192.168.10.133 ws-k8s-node3</span></span><br><span class="line"><span class="string">192.168.10.140 docker-host</span></span><br><span class="line"><span class="string">192.168.10.141 ceph-node1</span></span><br><span class="line"><span class="string">192.168.10.142 ceph-node2</span></span><br><span class="line"><span class="string">192.168.10.143 ceph-node3</span></span><br><span class="line"><span class="string">&quot;</span> &gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line">yum -y install yum-utils</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">yum -y install chrony</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line"></span><br><span class="line">yum install -y containerd.io-1.6.6</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line"><span class="comment">#配置镜像加速器</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[host.&quot;https://hub-mirror.c.163.com&quot;,host.&quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">host.&quot;https://ghcr.io&quot;,host.&quot;https://mirror.baidubce.com&quot;,host.&quot;https://docker.nju.edu.cn&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;]</span></span><br><span class="line"><span class="string"> &#x27;</span>&gt; /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line"><span class="comment">#生成containerd配置文件</span></span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">修改</span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">SystemdCgroup = <span class="literal">true</span></span><br><span class="line">sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line">config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span> <span class="comment">#配置镜像加速器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建crictl.yaml，指定创建pod与调用容器的时候使用containerd</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#重启服务加载文件</span></span><br><span class="line">systemctl <span class="built_in">enable</span> containerd.service --now</span><br><span class="line">systemctl restart containerd</span><br><span class="line"><span class="comment">#安装docker，要使用docker的build制作镜像功能</span></span><br><span class="line">yum install -y docker-ce &amp;&amp; systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="comment">#配置docker镜像加速器</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">		&quot;https://hub-mirror.c.163.com&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://ghcr.io&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://mirror.baidubce.com&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://docker.nju.edu.cn&quot;</span></span><br><span class="line"><span class="string">	]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.28.1 kubeadm-1.28.1 kubectl-1.28.1</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"><span class="comment">#yum install -y kubelet-1.26.0 #用于启动Pod</span></span><br><span class="line"><span class="comment">#yum install -y kubeadm-1.26.0 #初始化工具</span></span><br><span class="line"><span class="comment">#yum install -y kubectl-1.26.0 #管理的命令行工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置容器运行时，指定了容器运行时的通信端点地址，指定Unix域套接字协议和路径</span></span><br><span class="line"><span class="comment">#crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建配置文件，修改，并根据配置文件安装k8s</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line">vim kubeadm.yaml</span><br><span class="line">修改：</span><br><span class="line">advertiseAddress: 192.168.10.121 <span class="comment">#master IP</span></span><br><span class="line">criSocket: unix:///run/containerd/containerd.sock</span><br><span class="line">name: ws-k8s-master1 <span class="comment">#主机名</span></span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers <span class="comment">#换源k8s</span></span><br><span class="line">kubernetesVersion: 1.28.0 <span class="comment">#版本</span></span><br><span class="line">在networking下添加：</span><br><span class="line">podSubnet: 10.244.0.0/16 <span class="comment">#添加pod网段</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;---</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">mode: ipvs                   #kube代理模式为ipvs</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration   #cgroup驱动使用systemd</span></span><br><span class="line"><span class="string">cgroupDriver: systemd&#x27;</span> &gt;&gt; kubeadm.yaml</span><br><span class="line"><span class="comment">#通过kebeadm.yaml初始化k8s集群，且忽略系统预检错误</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification</span><br><span class="line"><span class="comment">#此时可能会出问题，重启即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#对kubectl进行授权</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube </span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl get nodes</span><br><span class="line">kubeadm token create --print-join-command <span class="comment">#生成token</span></span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.10.121:6443 --token fz8d9z.o5csc8a17ilub13g --discovery-token-ca-cert-hash sha256:c6fe90eb5632c6e422b694d1392722bed65fd768497a98cc75dcab8589ad35a7</span><br></pre></td></tr></table></figure>

<h3 id="master节点加入"><a href="#master节点加入" class="headerlink" title="master节点加入"></a>master节点加入</h3><p>#证书<br>#master2创建证书目录<br>mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd &amp;&amp; mkdir -p ~&#x2F;.kube&#x2F;</p>
<p>#把master1的证书放到master2上<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.* ws-k8s-master2:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.* ws-k8s-master2:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.* ws-k8s-master2:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.* ws-k8s-master2:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;</p>
<p>#master1：检查kubeadm-config ConfigMap<br>kubectl -n kube-system edit cm kubeadm-config -o yaml<br>修改，在ClusterConfiguration:下增加字段<br>controlPlaneEndpoint: “192.168.10.121:6443”<br>systemctl restart kubelet</p>
<p>#master2加入集群，–control-plane表示添加控制节点<br>kubeadm join 192.168.10.121:6443 –token dvgzo5.gs89gubi9zhfrwi3 –discovery-token-ca-cert-hash sha256:c6fe90eb5632c6e422b694d1392722bed65fd768497a98cc75dcab8589ad35a7 <br>–control-plane –ignore-preflight-errors&#x3D;SystemVerification</p>
<p>kubeadm join 192.168.10.121:6443 –token 3cux79.jadpr1rx79h85er5 –discovery-token-ca-cert-hash sha256:bc2f349ee80ea509d925320d3fa7121b32f978071f9d0d3e612b4a3aff311664 <br>–control-plane –ignore-preflight-errors&#x3D;SystemVerification</p>
<p>#master3<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.* ws-k8s-master3:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.* ws-k8s-master3:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.* ws-k8s-master3:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;<br>scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.* ws-k8s-master3:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;<br>kubeadm join 192.168.10.121:6443 –token 889fbg.b4zqb9w6srofhe66 –discovery-token-ca-cert-hash sha256:bc2f349ee80ea509d925320d3fa7121b32f978071f9d0d3e612b4a3aff311664 <br>–control-plane –ignore-preflight-errors&#x3D;SystemVerification</p>
<h3 id="node与节点加入"><a href="#node与节点加入" class="headerlink" title="node与节点加入"></a>node与节点加入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname ws-k8s-node1 &amp;&amp; bash</span><br><span class="line">nmcli con modify ens18 ipv4.addresses 192.168.10.131/24 ipv4.gateway 192.168.10.1 ipv4.dns 192.168.1.1 ipv4.method manual</span><br><span class="line">nmcli con up ens18</span><br><span class="line">yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm</span><br><span class="line">yum -y update</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service --now</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span></span><br><span class="line"><span class="string">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span></span><br><span class="line"><span class="string">192.168.10.100 1panel</span></span><br><span class="line"><span class="string">192.168.10.120 pve</span></span><br><span class="line"><span class="string">192.168.10.121 ws-k8s-master1</span></span><br><span class="line"><span class="string">192.168.10.122 ws-k8s-master2</span></span><br><span class="line"><span class="string">192.168.10.123 ws-k8s-master3</span></span><br><span class="line"><span class="string">192.168.10.130 harbor</span></span><br><span class="line"><span class="string">192.168.10.131 ws-k8s-node1</span></span><br><span class="line"><span class="string">192.168.10.132 ws-k8s-node2</span></span><br><span class="line"><span class="string">192.168.10.133 ws-k8s-node3</span></span><br><span class="line"><span class="string">192.168.10.140 docker-host&quot;</span> &gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;$ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">yum -y install yum-utils</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">yum -y install chrony</span><br><span class="line">sed -i <span class="string">&#x27;s/^server/#server/g&#x27;</span> /etc/chrony.conf</span><br><span class="line">sed -i <span class="string">&#x27;1s/^/server cn.pool.ntp.org iburst\n/&#x27;</span> /etc/chrony.conf</span><br><span class="line"></span><br><span class="line">yum install -y containerd.io-1.6.6</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">修改 </span><br><span class="line">SystemdCgroup = <span class="literal">true</span></span><br><span class="line">sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line">config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[host.&quot;https://hub-mirror.c.163.com&quot;,host.&quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">host.&quot;https://ghcr.io&quot;,host.&quot;https://mirror.baidubce.com&quot;,host.&quot;https://docker.nju.edu.cn&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;]</span></span><br><span class="line"><span class="string"> &#x27;</span>&gt; /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line">systemctl <span class="built_in">enable</span> containerd.service --now</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl restart containerd</span><br><span class="line">yum install -y docker-ce &amp;&amp; systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">		&quot;https://hub-mirror.c.163.com&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://ghcr.io&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://mirror.baidubce.com&quot;,</span></span><br><span class="line"><span class="string">		&quot;https://docker.nju.edu.cn&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.28.1 kubeadm-1.28.1 kubectl-1.28.1</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line">reboot</span><br><span class="line"><span class="comment">#加入集群</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.10.121:6443 --token 2x0xe5.erf0z44xtaciwbh7 --discovery-token-ca-cert-hash sha256:c6fe90eb5632c6e422b694d1392722bed65fd768497a98cc75dcab8589ad35a7</span><br></pre></td></tr></table></figure>

<h3 id="calico"><a href="#calico" class="headerlink" title="calico"></a>calico</h3><p>calico的yaml在github有<br>calico版本与kubernetes版本的对应关系：<br><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/requirements">https://docs.tigera.io/calico/latest/getting-started/kubernetes/requirements</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctr -n k8s.io images import calico.tar.gz</span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>

<h3 id="高可用部分"><a href="#高可用部分" class="headerlink" title="高可用部分"></a>高可用部分</h3><h4 id="keepalive-nginx做apiserver高可用"><a href="#keepalive-nginx做apiserver高可用" class="headerlink" title="keepalive+nginx做apiserver高可用"></a>keepalive+nginx做apiserver高可用</h4><p>配置文件在后面</p>
<p>master1与master2安装nginx和keepalive，且调整配置文件<br>yum -y install nginx keepalived  nginx-mod-stream</p>
<p>systemctl daemon-reload<br>systemctl enable nginx.service keepalived.service –now<br>systemctl restart nginx.service keepalived.service<br>chmod +x &#x2F;etc&#x2F;keepalived&#x2F;check_nginx.sh</p>
<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ip a | grep 192.168</span><br><span class="line">    inet 192.168.10.121/24 brd 192.168.10.255 scope global noprefixroute ens18</span><br><span class="line">    inet 192.168.10.200/24 scope global secondary ens18</span><br><span class="line">    </span><br><span class="line">systemctl stop keepalived.service</span><br><span class="line"></span><br><span class="line">ip a | grep 192.168</span><br><span class="line">    inet 192.168.10.122/24 brd 192.168.10.255 scope global noprefixroute ens18</span><br><span class="line">    inet 192.168.10.200/24 scope global secondary ens18</span><br><span class="line"></span><br><span class="line">systemctl start keepalived.service</span><br><span class="line"></span><br><span class="line">ip a | grep 192.168</span><br><span class="line">    inet 192.168.10.121/24 brd 192.168.10.255 scope global noprefixroute ens18</span><br><span class="line">    inet 192.168.10.200/24 scope global secondary ens18</span><br></pre></td></tr></table></figure>



<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>nginx:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class="line"></span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">            server 192.168.10.121:6443 weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line">            server 192.168.10.122:6443 weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line">            server 192.168.10.123:6443 weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">       listen 16443; <span class="comment"># 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突</span></span><br><span class="line">       proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主keepalive</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_MASTER</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens18  <span class="comment"># 修改为实际网卡名</span></span><br><span class="line">    virtual_router_id 51 <span class="comment"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class="line">    priority 100    <span class="comment"># 优先级，备服务器设置 90 </span></span><br><span class="line">    advert_int 1    <span class="comment"># 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment"># 虚拟IP</span></span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.10.200/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>备keepalive</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_MASTER</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens18  <span class="comment"># 修改为实际网卡名</span></span><br><span class="line">    virtual_router_id 51 <span class="comment"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class="line">    priority 90    <span class="comment"># 优先级，备服务器设置 90 </span></span><br><span class="line">    advert_int 1    <span class="comment"># 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment"># 虚拟IP</span></span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.10.200/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>check_nginx.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#1、判断Nginx是否存活</span></span><br><span class="line">counter=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class="string">&quot;grep|$$&quot;</span> )</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$counter</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment">#2、如果不存活则尝试启动Nginx</span></span><br><span class="line">    service nginx start</span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    <span class="comment">#3、等待2秒后再次获取一次Nginx状态</span></span><br><span class="line">    counter=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class="string">&quot;grep|$$&quot;</span> )</span><br><span class="line">    <span class="comment">#4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$counter</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        service  keepalived stop</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h4 id="etcd数据库高可用"><a href="#etcd数据库高可用" class="headerlink" title="etcd数据库高可用"></a>etcd数据库高可用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改所有master节点的etcd.yaml</span><br><span class="line">vim /etc/kubernetes/manifests/etcd.yaml</span><br><span class="line"></span><br><span class="line">--initial-cluster=ws-k8s-master1=https://192.168.10.121:2380,ws-k8s-master2=https://192.168.10.122:2380,ws-k8s-master3=https://192.168.10.123:2380</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><ol>
<li><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --net host -v /etc/kubernetes:/etc/kubernetes  \</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.4-0 etcdctl \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/peer.crt --key /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt member list</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426204105.png"></p>
<ol start="2">
<li><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --net host -v /etc/kubernetes:/etc/kubernetes \</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.4-0 etcdctl \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/peer.crt --key /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--endpoints=https://192.168.10.121:2379,https://192.168.10.122:2379,https://192.168.10.123:2379 endpoint health  --cluster</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403170630.png"></p>
</li>
<li><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --net host -v /etc/kubernetes:/etc/kubernetes \</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.4-0 etcdctl \</span><br><span class="line">-w table --cert /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/peer.key --cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--endpoints=https://192.168.10.121:2379,https://192.168.10.122:2379,https://192.168.10.123:2379 endpoint status --cluster</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403170721.png"></p>
</li>
</ol>
<h1 id="k8s概述"><a href="#k8s概述" class="headerlink" title="k8s概述"></a>k8s概述</h1><p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403171121.png"></p>
<p>pod是k8s的最小单位</p>
<p>HPA自动扩容与缩容</p>
<p>VPA自动调节pod的资源请求</p>
<p>高可用架构：使用keepalive+lvs对API server做高可用</p>
<p>K8s集群至少需要一个主节点(Master)和多个工作节点(Worker)<br>master节点：kubectl apiserver scheduler controller-manager Calico coredns<br>worker节点：kubelet kube-proxy</p>
<p>常用组件：<br>kubectl：管理K8s的命令行工具，可以操作K8s中的资源对象。<br>etcd： 是一个高可用的键值数据库，存储K8s信息，通过api server来修改<br>apiserver:  提供K8s api，是整个系统的对外接口，提供资源操作的唯一入口，提供认证、授权、访问控制、API注册和发现等机制<br>scheduler：负责K8s集群中pod的调度<br>Calico：网络插件，为pod提供IP，并做网络策略<br>controller-manager：与apiserver交互，实时监控和维护K8s集群的控制器的健康情况，对有故障的进行处理和恢复，相当于“大总管”。<br>kubelet：和api交互，报告pod状态信息，能操作pod<br>kube-proxy：提供网络代理和负载均衡，是实现service的通信与负载均衡机制的重要组件<br>coredns：域名解析服务</p>
<p>k8s的资源对象</p>
<p>1.pod<br>Pod是Kubernetes中的最小调度单元，当指派容器时，容器实际上并不会指派到物理硬件上，容器会被分配到一个Pod里</p>
<p>2.Replicaset<br>管理pod的副本控制器</p>
<p>3.Deployment<br>管理Replicaset和pod的副本控制器，比Replicaset更高级</p>
<p>4.Service<br>是一个四层代理，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例</p>
<p>6.Statefulset<br>提供了在 Kubernetes 中管理有状态应用程序所需的功能，包括稳定的网络标识、有序的部署与伸缩、持久化存储和有序删除</p>
<p>7.Job &amp; CronJob<br>8.Ingress<br>9.Configmap和Secret</p>
<h1 id="pod资源"><a href="#pod资源" class="headerlink" title="pod资源"></a>pod资源</h1><h2 id="pod概述"><a href="#pod概述" class="headerlink" title="pod概述"></a>pod概述</h2><p><strong><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/">https://kubernetes.io/zh/</a></strong></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/</a></p>
<p>Pod是Kubernetes中的最小调度单元，k8s都是以pod的方式运行服务的<br>****一个pod可以指定镜像，封装一个或多个容器</p>
<p>pod需要调度到工作节点运行，节点的选择由scheduler调度器实现</p>
<p>pod定义时，会定义init容器、应用容器与业务容器</p>
<p>init用以对主容器做初始化操作，查看服务是否正常</p>
<p><strong>pod网络</strong></p>
<p>kubectl get pods -n kube-system -owide #查看kube-system命名空间中的pod</p>
<p>部分控制节点组件是和管理节点共享ip地址，除此之外的pod都是唯一地址，通过calico网络插件分配</p>
<p>启动Pod时，会先启动⼀个pause 的容器，然后将后续的所有容器都 “link 到这个pause 的容器，以实现⽹络共享。</p>
<p>同一个pod内的容器会在共享环境中运行，共享同一个IP和端口</p>
<p><strong>pod存储</strong></p>
<p>通过挂在存储卷，可以让所有容器访问共享卷，允许共享数据</p>
<p><em>pod和容器对比</em></p>
<p>pod是容器组成的集合，可以作为一个或多个容器的载体<br>以pod为单位进行调度</p>
<p><strong>创建pod的方式</strong></p>
<p>1.使用yaml文件来创建</p>
<p>2.使用kubectl run创建pod</p>
<p><strong>pod运行方式</strong></p>
<p>1、自主式pod：直接定义一个pod资源</p>
<p>kubectl apply -f pod-tomcat.yaml</p>
<p>kubectl get pods -o wide</p>
<p>kubectl delete pods tomcat-test</p>
<p>2、控制器管理的Pod</p>
<p>常见的管理Pod的控制器：Replicaset、Deployment、Job、CronJob、Daemonset、Statefulset。<br>控制器管理的Pod可以确保Pod始终维持在指定的副本数运行。可以防止误删除</p>
<p>以下是一个举例的yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment    <span class="comment">#使用deployment资源控制器</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 2         <span class="comment">#副本数2</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: xianchao/nginx:v1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<p><strong>pod创建的步骤</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kubectl会寻找环境变量kubeconfig</span><br><span class="line">如果没有这个环境变量，会找/root/.kube/config文件</span><br><span class="line">可以通过kubectl config view查看/root/.kube/config内容</span><br><span class="line">kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters: <span class="comment">#集群</span></span><br><span class="line">- cluster: </span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.8.160:6443 <span class="comment">#集群控制节点server地址</span></span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts: <span class="comment">#当前环境</span></span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes      <span class="comment">#有一个集群kubernetes</span></span><br><span class="line">    user: kubernetes-admin   <span class="comment">#系统用户</span></span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes <span class="comment">#用kubernetes-admin访问kubernetes</span></span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line"><span class="built_in">users</span>:</span><br><span class="line">- name: kubernetes-admin  <span class="comment">#k8s的系统用户，可以访问api-server</span></span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pod创建过程</span><br><span class="line">1.**kubectl apply -f nginx-deploy.yaml**</span><br><span class="line">找config文件，基于config文件访问指定的集群，找到api-server，把信息给api-server</span><br><span class="line"></span><br><span class="line">2.api-server把kubectl的参数或者yaml的参数，写入etcd</span><br><span class="line">api-server把pod信息给scheduler调度器，调度器进行调度，并且把调度节点的信息写到etcd</span><br><span class="line"></span><br><span class="line">3.api-server调用kubelet，kubelet调用容器运行时docker/container</span><br><span class="line"></span><br><span class="line">4.容器运行时把pod信息返回给api-server，写入etcd</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403171510.png"></p>
<h2 id="pod的创建"><a href="#pod的创建" class="headerlink" title="pod的创建"></a>pod的创建</h2><h3 id="通过kubectl-run来创建pod"><a href="#通过kubectl-run来创建pod" class="headerlink" title="通过kubectl run来创建pod"></a>通过kubectl run来创建pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">run</span> <span class="string">--help</span></span><br><span class="line"><span class="attr">Usage:</span></span><br><span class="line">  <span class="string">kubectl</span> <span class="string">run</span> <span class="string">NAME</span> <span class="string">--image=image</span> [<span class="string">--env=&quot;key=value&quot;</span>] [<span class="string">--port=port</span>]</span><br><span class="line">[<span class="string">--dry-run=server|client</span>] [<span class="string">--overrides=inline-json</span>] [<span class="string">--command</span>] <span class="string">--</span> [<span class="string">COMMAND</span>]</span><br><span class="line">[<span class="string">args...</span>] [<span class="string">options</span>]</span><br><span class="line"><span class="string">kubectl</span> <span class="string">run</span> <span class="string">tomcat</span> <span class="string">--image=ws/tomcat</span> <span class="string">--image-pull-policy=&#x27;IfNotPresent&#x27;</span> <span class="string">\</span></span><br><span class="line"><span class="string">--port=8080</span></span><br></pre></td></tr></table></figure>

<h3 id="通过yaml文件创建，yaml文件简单写法"><a href="#通过yaml文件创建，yaml文件简单写法" class="headerlink" title="通过yaml文件创建，yaml文件简单写法"></a>通过yaml文件创建，yaml文件简单写法</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yaml的帮助命令</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod</span></span><br><span class="line"><span class="comment">#查看metadata下的字段可写的选项</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod.metadata</span></span><br><span class="line"><span class="comment">#底下还有网址，可以找到更多信息</span></span><br><span class="line"></span><br><span class="line"><span class="string">yaml的格式：每个字段都比上级字段多空两格，加短横-可以表示以下同级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#first-pod</span></span><br><span class="line"><span class="string">vim</span> <span class="string">first-pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  <span class="comment">#api版本-v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>       <span class="comment">#类型为Pod，必须大写</span></span><br><span class="line"><span class="attr">metadata:</span>       <span class="comment">#类型是object，对象类型，说明底下还有另外字段</span></span><br><span class="line">	<span class="attr">annotations:</span>  <span class="comment">#是注释，用以说明，没有实质意义，&lt;map[string]string&gt; 形式为键值对且都是字符串</span></span><br><span class="line">		<span class="attr">worker:</span> <span class="string">&quot;ws&quot;</span></span><br><span class="line">	<span class="attr">labels:</span>       <span class="comment">#标签，字符串键值对</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">ws-tomcat</span> <span class="comment">#pod的名字，最好带有功能描述</span></span><br><span class="line">	<span class="attr">namespace:</span> <span class="string">default</span> <span class="comment">#ns，命名空间归属，不同环境的资源放入不同的ns内，kubectl get ns</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment">#对象类型，有另外字段</span></span><br><span class="line">	<span class="attr">activeDeadlineSeconds:</span> <span class="comment">#pod存活的最长时间段，可选</span></span><br><span class="line">	<span class="attr">containers:</span> <span class="comment">#kubectl explain pod.spec.containers，带有required就是必选</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span> <span class="comment">#容器名</span></span><br><span class="line">		  <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span> <span class="comment">#镜像名称</span></span><br><span class="line">		  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment">#镜像拉取策略</span></span><br><span class="line"><span class="comment">#Always只在公网上拉取</span></span><br><span class="line"><span class="comment">#IfNotPresent先本地，再公网</span></span><br><span class="line"><span class="comment">#Never只用本地</span></span><br><span class="line">		  <span class="attr">ports:</span>  <span class="comment">#kubectl explain pod.spec.containers.ports</span></span><br><span class="line">			  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">			    <span class="attr">hostPort:</span> <span class="comment">#映射到物理机的端口</span></span><br><span class="line">			    <span class="attr">hostIP:</span> <span class="comment">#映射到物理机的IP</span></span><br><span class="line"><span class="comment">#应用</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-first.yaml</span></span><br><span class="line"><span class="comment">#pod/ws-tomcat created</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                          <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx-test-5b48846ff4-7n4f6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">122m</span></span><br><span class="line"><span class="string">nginx-test-5b48846ff4-mq5tm</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">122m</span></span><br><span class="line"><span class="string">ws-tomcat</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">50s</span></span><br></pre></td></tr></table></figure>

<h2 id="pod简单操作"><a href="#pod简单操作" class="headerlink" title="pod简单操作"></a>pod简单操作</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">ws-tomcat</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="comment">#进入pod中的指定容器，-c指定容器</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">ws-tomcat</span> <span class="string">-c</span> <span class="string">tomcat</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="comment">#看所有pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="comment">#看所有pod带IP</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-owide</span></span><br><span class="line"><span class="comment">#在k8s集群内都可以访问pod，同网段的非k8s集群主机就不行</span></span><br><span class="line"><span class="string">master1</span> <span class="number">2</span> <span class="string">node1</span> <span class="number">2</span><span class="string">都可以访问pod</span></span><br><span class="line"><span class="comment">#指定podIP与端口就能访问到容器的指定端口</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.68</span><span class="string">:8080</span></span><br><span class="line"><span class="comment">#指定pod的label查找</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-l</span> <span class="string">app=tomcat</span></span><br><span class="line"><span class="comment">#查看pod日志</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">logs</span> <span class="string">ws-tomcat</span></span><br><span class="line"><span class="comment">#查看pod详细信息</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">pods</span>  <span class="string">ws-tomcat</span></span><br><span class="line"><span class="comment">#删除pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pods</span> <span class="string">ws-tomcat</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pod-first.yaml</span></span><br><span class="line"><span class="comment">#pod可以通过kubectl apply -f进行pod的动态更新</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-first.yaml</span></span><br><span class="line"><span class="comment">#展示默认命名空间下pod的标签</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">--show-labels</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="命名空间与资源配额"><a href="#命名空间与资源配额" class="headerlink" title="命名空间与资源配额"></a>命名空间与资源配额</h2><p>命名空间（Namespace）是Kubernetes中用于隔离和组织资源的一种机制。它可以将集群中的资源划分为逻辑上独立的单元，使不同的团队、项目或应用程序可以在同一个集群中共享底层基础设施，同时保持彼此之间的隔离性。</p>
<p>通过使用命名空间，将不同的资源（如Pod、Service、Deployment等）组织在一起，并为它们提供唯一的名称。这样可以避免资源名称的冲突，并提供更好的资源管理和权限控制。</p>
<p>简单一句话：进行各种的资源隔离</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建命名空间，名为ws</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#查看命名空间</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">ns</span></span><br><span class="line"><span class="string">NAME</span>              <span class="string">STATUS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">default</span>           <span class="string">Active</span>   <span class="string">18h</span></span><br><span class="line"><span class="string">kube-node-lease</span>   <span class="string">Active</span>   <span class="string">18h</span></span><br><span class="line"><span class="string">kube-public</span>       <span class="string">Active</span>   <span class="string">18h</span></span><br><span class="line"><span class="string">kube-system</span>       <span class="string">Active</span>   <span class="string">18h</span></span><br><span class="line"><span class="string">ws</span>                <span class="string">Active</span>   <span class="string">7s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建命名空间资源配额，可以限制pod资源的总和</span></span><br><span class="line"><span class="comment">#帮助文件</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">resourcequota</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">resourcequota.metadata</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">resourcequota.spec</span></span><br><span class="line"><span class="comment">#创建限制yaml文件</span></span><br><span class="line"><span class="string">vim</span> <span class="string">ns-quota.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">KIND:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span>    <span class="comment">#指定要进行限制的pod</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment">#https://kubernetes.io/docs/concepts/policy/resource-quotas/</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">		<span class="attr">limits.cpu:</span> <span class="string">&quot;4&quot;</span>        <span class="comment">#最多用4核</span></span><br><span class="line">		<span class="attr">limits.memory:</span> <span class="string">4Gi</span>     <span class="comment">#最多用4G </span></span><br><span class="line">		<span class="attr">requests.cpu:</span> <span class="string">&quot;2&quot;</span>      <span class="comment">#需要至少2核</span></span><br><span class="line">		<span class="attr">requests.memory:</span> <span class="string">2Gi</span>   <span class="comment">#需要至少2G</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ns-quota.yaml</span></span><br><span class="line"><span class="comment">#查看资源配额</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">resourcequota</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="string">NAME</span>        <span class="string">AGE</span>   <span class="string">REQUEST</span>             <span class="string">LIMIT</span></span><br><span class="line"><span class="attr">cpu-quota   75s   requests.cpu: 0/2   limits.cpu:</span> <span class="number">0</span><span class="string">/4</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240403171725.png"></p>
<h2 id="pod的标签"><a href="#pod的标签" class="headerlink" title="pod的标签"></a>pod的标签</h2><p>标签label是一个键值对，能够通过标判断对象的特点，可以一开始创建pod的时候打标签，也可以创建之后打，大部分资源都可以打标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过也可以yaml文件创建labels</span></span><br><span class="line"><span class="comment">#命令行打标签</span></span><br><span class="line">kubectl label pods ws-tomcat user=ws</span><br><span class="line"><span class="comment">#查看默认命名空间下的pod的标签</span></span><br><span class="line">kubectl get pods --show-labels</span><br><span class="line"><span class="comment">#指定pod查看标签</span></span><br><span class="line">kubectl get pods ws --show-labels</span><br><span class="line"><span class="comment">#查找key是user的pod</span></span><br><span class="line">kubectl get pods -l user</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">ws-tomcat   1/1     Running   0          5m</span><br><span class="line"><span class="comment">#查找key是user，值是ws的pod</span></span><br><span class="line">kubectl get pods -l user=ws</span><br><span class="line"><span class="comment">#查找key是userd的pod，显示标签</span></span><br><span class="line">kubectl get pods -L user</span><br><span class="line">NAME                          READY   STATUS    RESTARTS      AGE     USER</span><br><span class="line">nginx-test-5b48846ff4-7n4f6   1/1     Running   1 (68m ago)   28h</span><br><span class="line">nginx-test-5b48846ff4-mq5tm   1/1     Running   1 (68m ago)   28h</span><br><span class="line">tomcat-test                   1/1     Running   0             7m3s</span><br><span class="line">ws-tomcat                     1/1     Running   0             6m49s   ws</span><br><span class="line"><span class="comment">#查找所有ns下所有pod的标签</span></span><br><span class="line">kubectl get pods --all-namespaces --show-labels</span><br></pre></td></tr></table></figure>

<h1 id="pod资源亲和性"><a href="#pod资源亲和性" class="headerlink" title="pod资源亲和性"></a>pod资源亲和性</h1><h2 id="node调度策略nodeName和nodeSelector"><a href="#node调度策略nodeName和nodeSelector" class="headerlink" title="node调度策略nodeName和nodeSelector"></a>node调度策略nodeName和nodeSelector</h2><p>在创建pod等资源时，可以通过调整字段进行node调度，指定资源调度到满足何种条件的node</p>
<h3 id="指定nodeName"><a href="#指定nodeName" class="headerlink" title="指定nodeName"></a>指定nodeName</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">testpod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">testpod1</span></span><br><span class="line">	<span class="attr">namespace:</span> <span class="string">default</span> </span><br><span class="line">	<span class="attr">labels:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">nodeName:</span> <span class="string">ws-k8s-node1</span> <span class="comment">#增加字段，将这个pod调度到node1</span></span><br><span class="line">	<span class="attr">containers:</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">		  <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">			<span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">testpod1.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="comment">#可以看到已经调度到node1上了</span></span><br><span class="line"><span class="string">testpod1</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>    <span class="string">116s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.9</span>    <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="指定nodeSelector"><a href="#指定nodeSelector" class="headerlink" title="指定nodeSelector"></a>指定nodeSelector</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">testpod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">testpod2</span></span><br><span class="line">	<span class="attr">namespace:</span> <span class="string">default</span> </span><br><span class="line">	<span class="attr">labels:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">nodeSelector:</span> <span class="comment">#添加nodeSelector选项，</span></span><br><span class="line">		<span class="attr">admin:</span> <span class="string">ws</span>  <span class="comment">#调度到具有admin=ws标签的node上</span></span><br><span class="line">	<span class="attr">containers:</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">		  <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">			<span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">testpod2.yaml</span></span><br><span class="line"><span class="string">但因为我没有admin=ws标签的node，所以应用后pod处于pending状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#现在我给node1的节点打个标签</span></span><br><span class="line"><span class="comment">#kubectl --help | grep -i label</span></span><br><span class="line"><span class="comment">#kubectl label --help</span></span><br><span class="line"><span class="attr">Examples:</span></span><br><span class="line">  <span class="comment"># Update pod &#x27;foo&#x27; with the label &#x27;unhealthy&#x27; and the value &#x27;true&#x27;</span></span><br><span class="line">  <span class="comment">#kubectl label pods foo unhealthy=true</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node1</span> <span class="string">admin=ws</span></span><br><span class="line"><span class="comment">#node/ws-k8s-node1 labeled</span></span><br><span class="line"><span class="comment">#调度情况恢复正常</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">testpod2</span></span><br><span class="line"><span class="string">testpod2</span>                      <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>              <span class="string">11m</span></span><br><span class="line"><span class="comment">#删除node标签</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node1</span> <span class="string">admin-</span></span><br><span class="line"><span class="comment">#删除testpod2</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pods</span> <span class="string">testpod2</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419170550.png"></p>
<p>如果同时使用nodeName和nodeSelector，则会报错亲和性错误，无法正常部署；<br>如果nodeName和nodeSelector指定的node同时满足这两项的条件，就可以部署</p>
<h2 id="node亲和性、pod亲和性、pod反亲和性"><a href="#node亲和性、pod亲和性、pod反亲和性" class="headerlink" title="node亲和性、pod亲和性、pod反亲和性"></a>node亲和性、pod亲和性、pod反亲和性</h2><p>亲和性在Kubernetes中起着重要作用，通过定义规则和条件，它允许我们实现精确的Pod调度、资源优化、高性能计算以及容错性和可用性的增强。通过利用亲和性，我们可以更好地管理和控制集群中的工作负载，并满足特定的业务需求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pods.spec.affinity</span></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">affinity</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">If</span> <span class="string">specified,</span> <span class="string">the</span> <span class="string">pod&#x27;s</span> <span class="string">scheduling</span> <span class="string">constraints</span></span><br><span class="line">     <span class="string">Affinity</span> <span class="string">is</span> <span class="string">a</span> <span class="string">group</span> <span class="string">of</span> <span class="string">affinity</span> <span class="string">scheduling</span> <span class="string">rules.</span></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">nodeAffinity</span> <span class="string">&lt;Object&gt;</span> <span class="comment">#node亲和性</span></span><br><span class="line">     <span class="string">Describes</span> <span class="string">node</span> <span class="string">affinity</span> <span class="string">scheduling</span> <span class="string">rules</span> <span class="string">for</span> <span class="string">the</span> <span class="string">pod.</span></span><br><span class="line"></span><br><span class="line">   <span class="string">podAffinity</span>  <span class="string">&lt;Object&gt;</span> <span class="comment">#pod亲和性</span></span><br><span class="line">     <span class="string">Describes</span> <span class="string">pod</span> <span class="string">affinity</span> <span class="string">scheduling</span> <span class="string">rules</span> <span class="string">(e.g.</span> <span class="string">co-locate</span> <span class="string">this</span> <span class="string">pod</span> <span class="string">in</span> <span class="string">the</span></span><br><span class="line">     <span class="string">same</span> <span class="string">node,</span> <span class="string">zone,</span> <span class="string">etc.</span> <span class="string">as</span> <span class="string">some</span> <span class="string">other</span> <span class="string">pod(s)).</span></span><br><span class="line"></span><br><span class="line">   <span class="string">podAntiAffinity</span>      <span class="string">&lt;Object&gt;</span> <span class="comment">#pod反亲和性</span></span><br><span class="line">     <span class="string">Describes</span> <span class="string">pod</span> <span class="string">anti-affinity</span> <span class="string">scheduling</span> <span class="string">rules</span> <span class="string">(e.g.</span> <span class="string">avoid</span> <span class="string">putting</span> <span class="string">this</span> <span class="string">pod</span></span><br><span class="line">     <span class="string">in</span> <span class="string">the</span> <span class="string">same</span> <span class="string">node,</span> <span class="string">zone,</span> <span class="string">etc.</span> <span class="string">as</span> <span class="string">some</span> <span class="string">other</span> <span class="string">pod(s)).</span></span><br></pre></td></tr></table></figure>

<h3 id="node节点亲和性"><a href="#node节点亲和性" class="headerlink" title="node节点亲和性"></a>node节点亲和性</h3><p>在创建pod时，会根据nodeaffinity来寻找最适合该pod的条件的node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查找帮助</span></span><br><span class="line">kubectl explain pods.spec.affinity.nodeAffinity</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: nodeAffinity &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Describes node affinity scheduling rules <span class="keyword">for</span> the pod.</span><br><span class="line">     Node affinity is a group of node affinity scheduling rules.</span><br><span class="line">FIELDS:</span><br><span class="line">   preferredDuringSchedulingIgnoredDuringExecution      &lt;[]Object&gt;</span><br><span class="line">   requiredDuringSchedulingIgnoredDuringExecution       &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#软亲和性，如果所有都不满足条件，也会找一个节点，将就将就</span></span><br><span class="line">preferredDuringSchedulingIgnoredDuringExecution </span><br><span class="line"><span class="comment">#硬亲和性，必须满足，如果不满足则不找节点，宁缺毋滥</span></span><br><span class="line">requiredDuringSchedulingIgnoredDuringExecution</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="硬亲和性"><a href="#硬亲和性" class="headerlink" title="硬亲和性"></a>硬亲和性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution</span><br><span class="line"><span class="comment">#nodeSelectorTerms    &lt;[]Object&gt; -required-</span></span><br><span class="line"><span class="comment">#     Required. A list of node selector terms. The terms are ORed.</span></span><br><span class="line">kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms</span><br><span class="line">FIELDS:</span><br><span class="line">   matchExpressions     &lt;[]Object&gt; <span class="comment">#匹配表达式</span></span><br><span class="line">     A list of node selector requirements by node<span class="string">&#x27;s labels.</span></span><br><span class="line"><span class="string">   matchFields  &lt;[]Object&gt;         #匹配字段</span></span><br><span class="line"><span class="string">     A list of node selector requirements by node&#x27;</span>s fields.</span><br><span class="line"><span class="comment">#匹配表达式</span></span><br><span class="line">kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressions</span><br><span class="line">key  &lt;string&gt; -required-</span><br><span class="line">operator     &lt;string&gt; -required-</span><br><span class="line">values       &lt;[]string&gt;</span><br><span class="line"><span class="comment">#可用operator</span></span><br><span class="line">     - `<span class="string">&quot;DoesNotExist&quot;</span>`</span><br><span class="line">     - `<span class="string">&quot;Exists&quot;</span>`</span><br><span class="line">     - `<span class="string">&quot;Gt&quot;</span>`</span><br><span class="line">     - `<span class="string">&quot;In&quot;</span>`</span><br><span class="line">     - `<span class="string">&quot;Lt&quot;</span>`</span><br><span class="line">     - `<span class="string">&quot;NotIn&quot;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">vim ying-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ying-pod</span><br><span class="line">	labels:</span><br><span class="line">		app: tomcat</span><br><span class="line">		user: ws</span><br><span class="line">spec:</span><br><span class="line">	affinity:</span><br><span class="line">		nodeAffinity:</span><br><span class="line">			requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">				nodeSelectorTerms:</span><br><span class="line">				- matchExpressions:</span><br><span class="line">					- key: name         <span class="comment">#去找key=name</span></span><br><span class="line">						opertor: In       <span class="comment"># name = ws或=wws       </span></span><br><span class="line">						values:</span><br><span class="line">							- ws</span><br><span class="line">							- wss			</span><br><span class="line">	containers:</span><br><span class="line">		- name: test1</span><br><span class="line">			namespace: default</span><br><span class="line">			image: docker.io/library/tomcat</span><br><span class="line">		  imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">kubectl apply -f ying-pod.yaml</span><br><span class="line"><span class="comment">#需要name=ws或name=wws，但是没有节点有标签，而且是硬亲和</span></span><br><span class="line"><span class="comment">#所以pod会处于pending状态</span></span><br><span class="line">kubectl get pods | grep ying</span><br><span class="line">ying-pod                      0/1     Pending       0          15m</span><br><span class="line"><span class="comment">#修改node标签</span></span><br><span class="line">kubectl label nodes ws-k8s-node1 name=ws</span><br><span class="line"><span class="comment">#开始构建，并且已经到node1节点了</span></span><br><span class="line">kubectl get pod -owide | grep ying</span><br><span class="line">ying-pod      0/1     ContainerCreating   0       80s     &lt;none&gt;    ws-k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment">#删除标签</span></span><br><span class="line">kubectl label nodes ws-k8s-node1 name-</span><br></pre></td></tr></table></figure>

<h3 id="软亲和性"><a href="#软亲和性" class="headerlink" title="软亲和性"></a>软亲和性</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">ruan-pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">ruan-pod</span></span><br><span class="line">	<span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">			<span class="attr">image:</span> <span class="string">docker.io/library/alpine</span></span><br><span class="line">			<span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">	<span class="attr">affinity:</span></span><br><span class="line">		<span class="attr">nodeAffinity:</span></span><br><span class="line">			<span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment">#必选preference和weight</span></span><br><span class="line">			 <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">					<span class="attr">matchExpressions:</span></span><br><span class="line">						<span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">							<span class="attr">operate:</span> <span class="string">In</span> <span class="comment">#还有Exists，Gt，Lt，NotIn等</span></span><br><span class="line">							<span class="attr">values:</span></span><br><span class="line">								<span class="bullet">-</span> <span class="string">ws</span></span><br><span class="line">					<span class="attr">weight:</span> <span class="number">50</span> <span class="comment">#软亲和性有“权重”说法，权重更高的更优先，范围1-100</span></span><br><span class="line">			 <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">					<span class="attr">matchExpressions:</span></span><br><span class="line">						<span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">							<span class="attr">operate:</span> <span class="string">In</span></span><br><span class="line">							<span class="attr">values:</span></span><br><span class="line">								<span class="bullet">-</span> <span class="string">wws</span></span><br><span class="line">					<span class="attr">weight:</span> <span class="number">70</span> <span class="comment">#设置的比上面的高，用以做测试</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#不满足条件，所以随机找一个进行调度，能看到调度到了node2上</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-owide</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">ruan</span></span><br><span class="line"><span class="string">ruan-pod</span>                      <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">3m24s</span>   <span class="string">&lt;none&gt;</span>         <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改node1的标签name=ws</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node1</span> <span class="string">name=ws</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span>  <span class="comment">#删除再重新创建</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">ruan</span> <span class="comment">#调整到了node1上</span></span><br><span class="line"><span class="string">ruan-pod</span>          <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>       <span class="string">2s</span>      <span class="string">&lt;none&gt;</span>         <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改node2的标签name=wws，此时node2权重比node1高</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node2</span> <span class="string">name=wss</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span> </span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">ruan</span> <span class="comment">#没有变化，还在node1</span></span><br><span class="line"><span class="string">ruan-pod</span>       <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>       <span class="string">4m29s</span>   <span class="string">&lt;none&gt;</span>      <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment">#因为yaml的匹配顺序，已经匹配到了name=ws，如果没有另外标签不同的则不会变化</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改ruan-pod.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">					<span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ws</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">50</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">names</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">wws</span></span><br><span class="line">				<span class="attr">weight:</span> <span class="number">70</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment">#添加node2标签name1=wws，权重比node1高，且标签key不同</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node2</span> <span class="string">names=wws</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span> </span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> <span class="string">-owide</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">ruan</span> <span class="comment">#可以看到ruan-pod已经回到了node2上</span></span><br><span class="line"><span class="string">ruan-pod</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>    <span class="string">3m47s</span>   <span class="string">&lt;none&gt;</span>      <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理环境</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node1</span> <span class="string">name-</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">ws-k8s-node2</span> <span class="string">names-</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">ruan-pod.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">ying-pod.yaml</span> <span class="string">--fore</span> <span class="string">--grace-period=0</span> <span class="comment">#强制删除</span></span><br></pre></td></tr></table></figure>

<h3 id="pod亲和性与反亲和性"><a href="#pod亲和性与反亲和性" class="headerlink" title="pod亲和性与反亲和性"></a>pod亲和性与反亲和性</h3><p>pod亲和性（podAffinity）有两种<br>1.podaffinity，即联系比较紧密的pod更倾向于使用同一个区域<br>比如tomcat和nginx这样资源的利用效率更高</p>
<p>2.podunaffinity，即两套完全相同，或两套完全不同功能的服务<br>为了不互相影响容灾效果，或者让服务之间不会互相影响，更倾向于不适用同一个区域</p>
<p>那么如何判断是不是“同一个区域”就非常重要</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pods.spec.affinity.podAffinity</span></span><br><span class="line"><span class="string">preferredDuringSchedulingIgnoredDuringExecution</span> <span class="comment">#软亲和性，尽可能在一起</span></span><br><span class="line"><span class="string">requiredDuringSchedulingIgnoredDuringExecution</span>  <span class="comment">#硬亲和性，一定要在一起</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>pod亲和性</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#硬亲和性</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution</span></span><br><span class="line">	 <span class="string">labelSelector</span>        <span class="string">&lt;Object&gt;</span>     <span class="comment">#以标签为筛选条件，选择一组亲和的pod</span></span><br><span class="line">   <span class="string">namespaceSelector</span>    <span class="string">&lt;Object&gt;</span>     <span class="comment">#以命名空间为筛选条件，选择一组亲和的pod</span></span><br><span class="line">   <span class="string">namespaces</span>   <span class="string">&lt;[]string&gt;</span>           <span class="comment">#确定命名空间的位置</span></span><br><span class="line">   <span class="string">topologyKey</span>  <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>  <span class="comment">#拓扑逻辑键，根据xx判断是否是同一位置</span></span><br><span class="line"></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">qinhe-pod1.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qinhe1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qinhe1</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">qinhe-pod1.yaml</span>    <span class="comment">#定义一个初始的pod，后面的pod可以依次为参照</span></span><br><span class="line"></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: qinhe2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: app1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: qinhe2</span></span><br><span class="line"><span class="string">      image: docker.io/library/nginx</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    podAffinity:  # 和pod亲和性</span></span><br><span class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">        - labelSelector:  # 以标签为筛选条件</span></span><br><span class="line"><span class="string">            matchExpressions:  # 以表达式进行匹配</span></span><br><span class="line"><span class="string">             - &#123;key: user, operator: In, values: [&quot;</span><span class="string">ws&quot;]&#125;</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="comment">#带有kubernetes.io/hostname标签相同的被认为是同一个区域，即以主机名区分</span></span><br><span class="line"><span class="comment">#标签的node被认为是统一位置</span></span><br><span class="line"><span class="string">&quot; &gt; qinhe-pod2.yaml</span></span><br><span class="line"><span class="string">kubectl apply -f qinhe-pod2.yaml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kubectl get pods -owide #因为hostname node1和node2不同，所以只会调度到node1</span></span><br><span class="line"><span class="string">NAME     READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="string">qinhe1   1/1     Running   0          68s   10.10.179.9    ws-k8s-node1   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string">qinhe2   1/1     Running   0          21s   10.10.179.10   ws-k8s-node1   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#修改</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">  topologyKey: beta.kubernetes.io/arch</span></span><br><span class="line"><span class="string">... #node1和node2这两个标签都相同</span></span><br><span class="line"><span class="string">kubectl delete -f qinhe-pod2.yaml</span></span><br><span class="line"><span class="string">kubectl apply -f qinhe-pod2.yaml</span></span><br><span class="line"><span class="string">kubectl get pods -owide #再查看时会发现qinhe2分到了node2</span></span><br><span class="line"><span class="string">NAME     READY   STATUS    RESTARTS   AGE     IP             NODE           NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="string">qinhe1   1/1     Running   0          4m55s   10.10.179.9    ws-k8s-node1   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string">qinhe2   1/1     Running   0          15s     10.10.234.68   ws-k8s-node2   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#清理环境</span></span><br><span class="line"><span class="string">kubectl delete -f qinhe-pod1.yaml</span></span><br><span class="line"><span class="string">kubectl delete -f qinhe-pod2.yaml</span></span><br></pre></td></tr></table></figure>

<p><strong>pod反亲和性</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pods.spec.affinity.podAntiAffinity</span><br><span class="line">preferredDuringSchedulingIgnoredDuringExecution      &lt;[]Object&gt;</span><br><span class="line">requiredDuringSchedulingIgnoredDuringExecution       &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#硬亲和性</span></span><br><span class="line"><span class="comment">#创建qinhe-pod3.yaml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; qinhe-pod3.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1 </span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: qinhe3</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    user: ws</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">   - name: qinhe3</span></span><br><span class="line"><span class="string">     image: docker.io/library/nginx</span></span><br><span class="line"><span class="string">     imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建qinhe-pod4.yaml</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: qinhe4</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: app1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: qinhe4</span></span><br><span class="line"><span class="string">      image: docker.io/library/nginx</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    podAntiAffinity:  # 和pod亲和性</span></span><br><span class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">        - labelSelector:  # 以标签为筛选条件</span></span><br><span class="line"><span class="string">            matchExpressions:  # 以表达式进行匹配</span></span><br><span class="line"><span class="string">             - &#123;key: user, operator: In, values: [&quot;</span>ws<span class="string">&quot;]&#125;  #表达式user=ws</span></span><br><span class="line"><span class="string">          topologyKey: kubernetes.io/hostname  #以hostname作为区分是否同个区域</span></span><br><span class="line"><span class="string">&quot;</span> &gt; qinhe-pod4.yaml</span><br><span class="line">kubectl apply -f qinhe-pod3.yaml</span><br><span class="line">kubectl apply -f qinhe-pod4.yaml</span><br><span class="line"><span class="comment">#分配到了不同的node</span></span><br><span class="line">kubectl get pods -owide</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">qinhe3   1/1     Running   0          9s    10.10.179.11   ws-k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">qinhe4   1/1     Running   0          8s    10.10.234.70   ws-k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改topologyKey</span></span><br><span class="line">pod4修改为topologyKey: user</span><br><span class="line">kubectl label nodes ws-k8s-node1 user=xhy</span><br><span class="line">kubectl label nodes ws-k8s-node2 user=xhy</span><br><span class="line"><span class="comment">#现在node1和node2都会被pod4识别为同一位置，因为node的label中user值相同</span></span><br><span class="line"></span><br><span class="line">kubectl delete -f qinhe-pod4.yaml</span><br><span class="line">kubectl apply -f qinhe-pod4.yaml</span><br><span class="line"><span class="comment">#直接显示离线</span></span><br><span class="line">kubectl get pods -owide</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE     IP             NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">qinhe3   1/1     Running   0          9m59s   10.10.179.12   ws-k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">qinhe4   0/1     Pending   0          2s      &lt;none&gt;         &lt;none&gt;         &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">Warning  FailedScheduling  74s   default-scheduler  0/4 nodes are available: 2 node(s) didn<span class="string">&#x27;t match pod anti-affinity rules, 2 node(s) had untolerated taint &#123;node-role.kubernetes.io/control-plane: &#125;. preemption: 0/4 nodes are available: 2 No preemption victims found for incoming pod, 2 Preemption is not helpful for scheduling..</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#pod反亲和性的软亲和性与node亲和性的软亲和性同理</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#清理环境</span></span><br><span class="line"><span class="string">kubectl label nodes ws-k8s-node1 user-</span></span><br><span class="line"><span class="string">kubectl label nodes ws-k8s-node2 user-</span></span><br><span class="line"><span class="string">kubectl delete -f qinhe-pod3.yaml</span></span><br><span class="line"><span class="string">kubectl delete -f qinhe-pod4.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="污点与容忍度"><a href="#污点与容忍度" class="headerlink" title="污点与容忍度"></a>污点与容忍度</h2><p>污点类似于标签，可以给node打taints，在创建pod时可以通过tolerations来定义pod对于污点的容忍度</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看node上的污点</span></span><br><span class="line"><span class="comment">#master节点是默认有污点</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">node</span> <span class="string">ws-k8s-master1</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">taint</span></span><br><span class="line"><span class="attr">Taints:</span>             <span class="string">node-role.kubernetes.io/control-plane:NoSchedule</span></span><br><span class="line"><span class="comment">#node默认没有污点</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">node</span> <span class="string">ws-k8s-node1</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">taint</span></span><br><span class="line"><span class="attr">Taints:</span>             <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#kubectl explain nodes.spec.taints查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">nodes.spec.taints.effect</span></span><br><span class="line"><span class="number">1.</span><span class="string">NoExecute</span></span><br><span class="line"><span class="string">对已调度的pod不影响，仅对新需要调度的pod进行影响</span></span><br><span class="line"><span class="number">2.</span><span class="string">NoSchedule</span></span><br><span class="line"><span class="string">对已调度和新调度的pod都会有影响</span></span><br><span class="line"><span class="number">3.</span><span class="string">PreferNoSchedule</span></span><br><span class="line"><span class="string">软性的NoSchedule，就算不满足条件也可以调度到不容忍的node上</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前master节点pod容忍情况</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">pods</span> <span class="string">kube-proxy-bg7ck</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">tolerations</span> <span class="string">-A</span> <span class="number">10</span></span><br><span class="line"><span class="attr">Tolerations:</span>                 <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/disk-pressure:NoSchedule</span> <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/memory-pressure:NoSchedule</span> <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/network-unavailable:NoSchedule</span> <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/not-ready:NoExecute</span> <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/pid-pressure:NoSchedule</span> <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/unreachable:NoExecute</span> <span class="string">op=Exists</span></span><br><span class="line">                             <span class="string">node.kubernetes.io/unschedulable:NoSchedule</span> <span class="string">op=Exists</span></span><br><span class="line"><span class="attr">Events:</span>                      <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#给node1打一个污点，使其不接受</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">taint</span> <span class="string">node</span> <span class="string">ws-k8s-node1</span> <span class="string">user=ws:NoSchedule</span></span><br><span class="line"><span class="comment">#创建wudian.yaml进行测试</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">wudian.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wudain-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">app1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wudian-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">wudian.yaml</span></span><br><span class="line"><span class="comment">#wudian-pod调度到了node2</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">wudain-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">18s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.72</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment">#给node2添加污点</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">taint</span> <span class="string">node</span> <span class="string">ws-k8s-node2</span> <span class="string">user=xhy:NoExecute</span></span><br><span class="line"><span class="comment">#再查看发现wudain-pood已经被删除</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="literal">No</span> <span class="string">resources</span> <span class="string">found</span> <span class="string">in</span> <span class="string">default</span> <span class="string">namespace.</span></span><br><span class="line"><span class="comment">#再次创建变成离线状态</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">wudian.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>       <span class="string">NODE</span>     <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">wudain-pod</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">3s</span>    <span class="string">&lt;none&gt;</span>   <span class="string">&lt;none&gt;</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前node污点状态</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">node</span> <span class="string">ws-k8s-node1</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">taint</span></span><br><span class="line"><span class="attr">Taints:</span>             <span class="string">user=ws:NoSchedule</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">node</span> <span class="string">ws-k8s-node2</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">taint</span></span><br><span class="line"><span class="attr">Taints:</span>             <span class="string">user=xhy:NoExecute</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建带有容忍度的pod wudian2.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">wudian2.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wudain2-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">app1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wudian2-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">tolerations:</span>  <span class="comment">#容忍度</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span>    <span class="comment">#equal表示等于，exists代表存在</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;ws&quot;</span>          <span class="comment">#根据字段，表示能容忍user=ws的污点</span></span><br><span class="line"><span class="comment">#如果operator为exists且value为空则代表容忍所有key相同的</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span> <span class="comment">#需要准确匹配容忍等级，如果不匹配则不会生效</span></span><br><span class="line"><span class="comment">#   tolerationSeconds: 1800  effect为NoExecute时才能使用，表示容忍污染的时间，默认是0，即永远容忍</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#现在wudian2是能容忍node1的污点的</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">wudian2.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>          <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">wudain-pod</span>    <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">21m</span>   <span class="string">&lt;none&gt;</span>         <span class="string">&lt;none&gt;</span>         <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">wudain2-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">15s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.13</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建带有容忍度的pod wudian3.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">wudian3.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wudain3-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">app1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wudian3-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">tolerations:</span>  <span class="comment">#容忍度</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span>    <span class="comment">#equal表示等于，exists代表存在</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span>          <span class="comment">#根据字段，表示能容忍user=ws的污点</span></span><br><span class="line"><span class="comment">#如果operator为exist且value为空则代表容忍所有key相同的</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span> <span class="comment">#需要准确匹配容忍等级，如果不匹配则不会生效</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">1800</span>  <span class="comment">#effect为NoExecute时才能使用，表示容忍污染的时间，默认是0，即永远容忍</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">wudian3.yaml</span></span><br><span class="line"><span class="comment">#wudian3运行在node2上</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">node2</span></span><br><span class="line"><span class="string">wudain3-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">59s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.73</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理环境</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">wudian.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">wudian2.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">wudian3.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">taint</span> <span class="string">node</span> <span class="string">ws-k8s-node1</span> <span class="string">user-</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">taint</span> <span class="string">node</span> <span class="string">ws-k8s-node2</span> <span class="string">user-</span></span><br></pre></td></tr></table></figure>

<h1 id="k8s-pod重启策略"><a href="#k8s-pod重启策略" class="headerlink" title="k8s pod重启策略"></a>k8s pod重启策略</h1><h2 id="pod状态与重启策略"><a href="#pod状态与重启策略" class="headerlink" title="pod状态与重启策略"></a>pod状态与重启策略</h2><p>参考文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/">Pod 的生命周期 | Kubernetes</a></p>
<h3 id="pod状态"><a href="#pod状态" class="headerlink" title="pod状态"></a>pod状态</h3><p>1.pending——挂起<br>（1）正在创建pod，检查存储、网络、下载镜像等问题<br>（2）条件不满足，比如硬亲和性，污点等调度条件不满足</p>
<p>2.failed——失败<br>至少有一个容器因为失败而停止，即非0状态退出</p>
<p>3.unknown——未知<br>apiserver连不上node节点的kubelet，通常是网络问题</p>
<p>4.Error——错误</p>
<p>5.succeeded——成功<br>pod所有容器成功终止</p>
<p>6.Unschedulable<br>pod不能被调度</p>
<p>7.PodScheduled<br>正在调度中</p>
<p>8.Initialized<br>pod初始化完成</p>
<p>9.ImagePullBackOff<br>容器拉取失败</p>
<p>10.evicted<br>node节点资源不足</p>
<p>11.CrashLoopBackOff<br>容器曾经启动，但又异常退出了</p>
<h3 id="pod重启策略"><a href="#pod重启策略" class="headerlink" title="pod重启策略"></a>pod重启策略</h3><p>当容器异常时，可以通过设置RestartPolicy字段，设置pod重启策略来对pod进行重启等操作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod.spec.restartPolicy</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"><span class="attr">FIELD:</span>    <span class="string">restartPolicy</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">Restart</span> <span class="string">policy</span> <span class="string">for</span> <span class="string">all</span> <span class="string">containers</span> <span class="string">within</span> <span class="string">the</span> <span class="string">pod.</span> <span class="string">One</span> <span class="string">of</span> <span class="string">Always,</span> <span class="string">OnFailure,</span></span><br><span class="line">     <span class="attr">Never. Default to Always. More info:</span></span><br><span class="line">     <span class="string">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy</span></span><br><span class="line">     <span class="attr">Possible enum values:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;Always&quot;`</span>   <span class="comment">#只要异常退出，立即自动重启</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;Never&quot;`</span>    <span class="comment">#不会重启容器</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;OnFailure&quot;`#容器错误退出，即退出码不为0时，则自动重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试Always策略，创建always.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">always.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">always-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">always.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> <span class="comment">#查看状态</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">always-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">22s</span></span><br><span class="line"><span class="comment">#进入容器去关闭容器</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">always-pod</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">shutdown.sh</span></span><br><span class="line"><span class="comment">#查看当前状态，可以看到always-pod重启计数器为1</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>     <span class="string">AGE</span></span><br><span class="line"><span class="string">always-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(5s</span> <span class="string">ago)</span>   <span class="string">70s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试never策略，创建never.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">never.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">never-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">never.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">never-pod</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">shutdown.sh</span></span><br><span class="line"><span class="comment">#不会重启，状态为completed</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">never</span></span><br><span class="line"><span class="string">never-pod</span>    <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">0</span>            <span class="string">73s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试OnFailure策略，创建onfailure.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">onfailure.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">onfailure-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">onfailure.yaml</span></span><br><span class="line"><span class="comment">#进去后进行异常退出</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">onfailure-pod</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">kill</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#查看pods状态，已经重启</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span>  <span class="string">|</span> <span class="string">grep</span> <span class="string">onfailure</span></span><br><span class="line"><span class="string">onfailure-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">1</span> <span class="string">(43s</span> <span class="string">ago)</span>   <span class="string">2m11s</span></span><br><span class="line"><span class="comment">#进入后进行正常退出</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">onfailure-pod</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">shutdown.sh</span></span><br><span class="line"><span class="comment">#查看pods状态，没有重启，进入completed状态</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span>  <span class="string">|</span> <span class="string">grep</span> <span class="string">onfailure</span></span><br><span class="line"><span class="string">onfailure-pod</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">1</span>             <span class="string">3m58s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理环境</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">always.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">never.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">onfailure.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="pod生命周期——容器钩子与容器探测"><a href="#pod生命周期——容器钩子与容器探测" class="headerlink" title="pod生命周期——容器钩子与容器探测"></a>pod生命周期——容器钩子与容器探测</h2><p>参考资料</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/">Pod 的生命周期 | Kubernetes</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/">Init 容器 | Kubernetes</a></p>
<p>Pod的生命周期可以分为以下几个阶段：</p>
<ol>
<li>Pending（等待）：在这个阶段，Pod被创建，并且正在等待被调度到一个节点上运行。此时，Pod的容器镜像正在下载，网络和存储资源正在分配。</li>
<li>Running（运行中）：一旦Pod成功调度到节点上，它进入Running状态。在此阶段，Pod中的容器开始在节点上运行，并且可以处理请求。</li>
<li>Succeeded（成功）：如果Pod中的所有容器成功完成了它们的任务，并且退出状态码为0，那么Pod将进入Succeeded状态。一般情况下，这意味着Pod已经完成了它的工作。</li>
<li>Failed（失败）：如果Pod中的任何容器以非零的退出状态码退出，或者其中一个容器无法启动，那么Pod将进入Failed状态。这表示Pod执行出现了问题。</li>
<li>Unknown（未知）：如果无法获取Pod的状态信息，或者与Pod关联的节点失去联系，那么Pod将进入Unknown状态。</li>
</ol>
<p>除了这些基本的生命周期阶段，Pod还可以经历一些其他的状态转换，例如：</p>
<ul>
<li>Terminating（终止中）：当Pod被删除或终止时，它进入Terminating状态。在此阶段，Pod的容器正在停止，并且资源正在释放。</li>
<li>Evicted（驱逐）：如果节点上的资源不足，Kubernetes可能会驱逐Pod，将其从节点上移除。这将导致Pod进入Evicted状态。</li>
<li>ContainerCreating（创建容器）：当Pod的容器正在创建时，Pod将进入ContainerCreating状态。这通常发生在调度期间，当容器镜像正在下载或容器正在启动时。</li>
</ul>
<p>这些状态和状态转换代表了Pod在其生命周期中可能经历的不同阶段和情况。Kubernetes通过监控和管理Pod的状态来确保Pod的正常运行和可靠性。<br>——以上内容由gpt生成</p>
<p>Pod生命周期一般包含以下几个流程：</p>
<p>1、创建pause容器<br>主要目的是为了实现Pod级别的网络和存储隔离。当Pod中有多个容器时，这些容器共享相同的网络命名空间和存储卷。Pause容器的存在使得每个容器都可以共享同一个网络命名空间和存储卷，从而实现它们之间的通信和数据共享。</p>
<p>2、创建初始化容器<br>初始化容器是在Kubernetes中用于在主应用容器之前运行的特殊容器。它的作用是在主应用启动之前完成一些准备工作，比如加载配置、准备数据或解决依赖项。它可以确保主应用容器在启动时具备必要的环境和资源。</p>
<p>初始化容器是串行运行的，一个初始化容器运行成功才能运行下一个初始化容器，全部执行完才能执行主容器，并且初始化容器内的数据可以被主容器用到。</p>
<p>初始化容器不支持pod就绪探测，因为初始化容器在pod就绪之前就已经完成</p>
<p>如果初始化容器运行失败，k8s也会根据重启策略restartPolicy决定是否进行重启</p>
<p>3、主容器</p>
<p>4、前置钩子&#x2F;容器停止前钩子（PreStop Hook）</p>
<p>5、后置钩子&#x2F;容器启动后钩子（PostStart Hook）<br>后置钩子是在容器启动后立即运行的命令或脚本。它可以用于在容器启动后执行一些初始化任务，例如加载配置或启动辅助进程。</p>
<h3 id="初始化容器"><a href="#初始化容器" class="headerlink" title="初始化容器"></a>初始化容器</h3><p>参考资料<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use">Init Containers | Kubernetes</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod.spec.initContainers</span> <span class="comment">#初始化容器字段与container区别不大</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个初始化容器的yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">init1.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">init1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init1</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">command:</span> [<span class="string">&quot;echo&quot;</span>,<span class="string">&quot;the first test&quot;</span>]</span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init2</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;the secend test&#x27;&quot;</span>]</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">init1.yaml</span></span><br><span class="line"><span class="comment">#持续监控pod状态，可以看到经过了两个init状态，初始化完成后进入running状态</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Init:0/2</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Init:0/2</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Init:1/2</span>   <span class="number">0</span>          <span class="string">2s</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">PodInitializing</span>   <span class="number">0</span>          <span class="string">3s</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>           <span class="number">0</span>          <span class="string">4s</span></span><br></pre></td></tr></table></figure>

<h3 id="容器钩子"><a href="#容器钩子" class="headerlink" title="容器钩子"></a>容器钩子</h3><p>参考文档 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks">https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">容器启动后钩子（PostStart</span></span><br><span class="line"><span class="string">容器停止前钩子（PreStop</span></span><br><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pods.spec.containers.lifecycle</span></span><br><span class="line"><span class="string">postStart</span>    <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">preStop</span>      <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pods.spec.containers.lifecycle.postStart</span></span><br><span class="line"><span class="string">exec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">httpGet</span>      <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">tcpSocket</span>    <span class="string">&lt;Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建启动后钩子的yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">hook.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">lifecycle:</span></span><br><span class="line">       <span class="attr">postStart:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo &#x27;test&#x27;&quot;</span>]</span><br><span class="line">       <span class="attr">preStop:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;pkill ssh&quot;</span>]  <span class="comment">#在pod停止前，使用命令关闭某些进程</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">hook.yaml</span></span><br><span class="line"><span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">init1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">57m</span></span><br><span class="line"><span class="string">hook</span>    <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">hook</span>    <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">hook</span>    <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">hook</span>    <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">hook</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">hook.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">init1.yaml</span></span><br></pre></td></tr></table></figure>

<h3 id="容器探测"><a href="#容器探测" class="headerlink" title="容器探测"></a>容器探测</h3><p>容器探测包括启动探测，就绪探测与存活探测</p>
<p>1、启动探测Startup Probe</p>
<ul>
<li>用于检测容器内的应用程序是否仍在运行。</li>
<li>如果启动探测失败，则 Kubernetes 认为容器处于不健康状态，并尝试重新启动容器。</li>
<li>如果启动探测成功，则容器被认为是健康的，并继续正常运行。</li>
<li>常见的启动探测方式包括发送 HTTP 请求到容器的特定端点或执行命令并检查返回值。</li>
</ul>
<p>2、就绪探测Readiness Probe</p>
<ul>
<li>用于检测容器是否已经启动完成并准备好接收流量。</li>
<li>就绪探测与存活探测类似，但是 在容器启动期间进行检测，而不仅仅是容器启动后。</li>
<li>如果就绪探测失败，则 Kubernetes 认为容器尚未启动完成，将从服务负载均衡中剔除该容器。</li>
<li>如果就绪探测成功，则容器被认为已经启动完成并准备好接收流量。</li>
<li>常见的就绪探测方式与存活探测相似，包括发送 HTTP 请求或执行命令。</li>
</ul>
<p>3、存活探测Liveness Probe</p>
<ul>
<li>用于检测容器是否准备好接收流量。</li>
<li>如果存活探测失败，则 Kubernetes 认为容器尚未准备好处理流量，将从服务负载均衡中剔除该容器。</li>
<li>如果存活探测成功，则容器被认为是准备好接收流量的，并加入到服务负载均衡中。</li>
<li>常见的存活探测方式包括发送 HTTP 请求到容器的特定端点或执行命令并检查返回值。</li>
</ul>
<p>存活探测与就绪探测的区别：<br>可以采取相同的探测方式，只是处理方式不同，就绪探测失败后将pod的IP与port从对应的endpoint列表中删除，也就是会拒绝外部对其进行访问；存活探测探测失败后将根据重启策略进行处理<br>存活探测关注容器内应用程序的运行状态，用于重新启动不健康的容器，确保应用程序持续运行。<br>就绪探测关注容器是否已经准备好接收流量，用于在容器启动过程中防止将流量发送给尚未完全准备好的容器。</p>
<p>k8s中启动探测会最先进行，就绪探测和存活探测会同时进行</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">配置存活、就绪和启动探针 | Kubernetes</a></p>
<h3 id="启动探测"><a href="#启动探测" class="headerlink" title="启动探测"></a>启动探测</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod.spec.containers.startupProbe</span></span><br><span class="line"><span class="string">exec</span> <span class="string">&lt;Object&gt;</span>                     <span class="comment">#执行命令，如果返回为0则探测成功</span></span><br><span class="line"><span class="string">failureThreshold</span>     <span class="string">&lt;integer&gt;</span>    <span class="comment">#失败的重试次数,超过就视为失败，默认为3</span></span><br><span class="line"><span class="string">grpc</span> <span class="string">&lt;Object&gt;</span>                   <span class="comment">#用于对接grpc端口</span></span><br><span class="line"><span class="string">httpGet</span>      <span class="string">&lt;Object&gt;</span>          <span class="comment">#调用http get，响应的状态码&gt;=200且&lt;400则探测成功</span></span><br><span class="line"><span class="string">initialDelaySeconds</span>  <span class="string">&lt;integer&gt;</span> <span class="comment">#启动后多久开始探测，默认为0</span></span><br><span class="line"><span class="string">periodSeconds</span>        <span class="string">&lt;integer&gt;</span> <span class="comment">#探测的时间间隔，默认10秒</span></span><br><span class="line"><span class="string">successThreshold</span>     <span class="string">&lt;integer&gt;</span> <span class="comment">#需要探测成功的次数，默认为1，在启动和存活探测中必须为1</span></span><br><span class="line"><span class="string">tcpSocket</span>    <span class="string">&lt;Object&gt;</span>             <span class="comment">#通过ip和port进行tcp检查，如果能建立连接则探测成功</span></span><br><span class="line"><span class="string">terminationGracePeriodSeconds</span>        <span class="string">&lt;integer&gt;</span> <span class="comment">#在删除Pod之前等待的时间，用于清理</span></span><br><span class="line"><span class="string">timeoutSeconds</span>       <span class="string">&lt;integer&gt;</span>        <span class="comment">#等待响应的超时时间，默认为1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用command</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">qidongtance-command.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qidong</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;echo &#x27;1&#x27;&quot;</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>  <span class="comment">#启动后10秒开始探测</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span>         <span class="comment">#探测间隔5秒</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>      <span class="comment">#成功一次即成功</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span>      <span class="comment">#失败可重试三次</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span>        <span class="comment">#超时5秒即失败</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">qidongtance-command.yaml</span></span><br><span class="line"><span class="comment">#看到过了10+5秒进入了就绪状态</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">2s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="comment">#修改命令为错误的命令，使其不正常执行，返回码为1</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">     <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;qweasdaq&quot;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">qidongtance-command.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">qidongtance-command.yaml</span></span><br><span class="line"><span class="comment">#pod重启了4次，后面显示失败</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">78s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m6s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m6s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m6s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m6s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m6s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">1</span> <span class="string">(2s</span> <span class="string">ago)</span>   <span class="string">27s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">2</span> <span class="string">(2s</span> <span class="string">ago)</span>   <span class="string">47s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">2</span> <span class="string">(5s</span> <span class="string">ago)</span>   <span class="string">50s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">3</span> <span class="string">(1s</span> <span class="string">ago)</span>   <span class="string">66s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">4</span> <span class="string">(1s</span> <span class="string">ago)</span>   <span class="string">86s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>    <span class="number">4</span> <span class="string">(1s</span> <span class="string">ago)</span>   <span class="string">106s</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">qidongtance-command.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用tcpsocket</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">qidongtance-tcp.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qidong</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment">#给一个容器端口80</span></span><br><span class="line">     <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">         <span class="attr">port:</span> <span class="number">80</span>      <span class="comment">#探测80端口</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span> </span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span>        </span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>    </span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span>      </span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span>   </span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">qidongtance-tcp.yaml</span></span><br><span class="line"><span class="comment">#成功运行</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">22s</span></span><br><span class="line"><span class="comment">#curl访问</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.91</span><span class="string">:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">qidongtance-tcp.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用http get</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">qidongtance-httpget.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qidong</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">         <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">         <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span> </span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span>        </span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>    </span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span>      </span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span>   </span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">qidongtance-httpget.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span> <span class="comment">#运行正常</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">2s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="string">qidong</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="comment">#curl测试</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.93</span><span class="string">:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">qidongtance-httpget.yaml</span></span><br></pre></td></tr></table></figure>

<h3 id="存活探测"><a href="#存活探测" class="headerlink" title="存活探测"></a>存活探测</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助，与启动探测相似</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod.spec.containers.livenessProbe</span></span><br><span class="line"><span class="comment">#存活探测每隔一段时间进行探测，确保业务的存活</span></span><br><span class="line"><span class="comment">#存活探测</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">cunhuotance-command.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cunhuo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">     <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">     <span class="attr">args:</span>                       <span class="comment">#探针测试文件</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;touch /1.txt; sleep 20; rm -rf /1.txt&quot;</span> <span class="comment">#使其20秒后删除该文件</span></span><br><span class="line">     <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">exec:</span>       <span class="comment">#探测的命令</span></span><br><span class="line">       <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/1.txt</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cunhuotance-command.yaml</span></span><br><span class="line"><span class="comment">#查看发现经过20秒，探活失败，容器结束，重启后探活，失败循环往复</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">8s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">0</span>          <span class="string">21s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">1</span> <span class="string">(2s</span> <span class="string">ago)</span>   <span class="string">22s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">1</span> <span class="string">(23s</span> <span class="string">ago)</span>   <span class="string">43s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>   <span class="number">1</span> <span class="string">(4s</span> <span class="string">ago)</span>    <span class="string">45s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>            <span class="number">2</span> <span class="string">(15s</span> <span class="string">ago)</span>   <span class="string">56s</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>             <span class="string">RESTARTS</span>      <span class="string">AGE</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>   <span class="number">2</span> <span class="string">(12s</span> <span class="string">ago)</span>   <span class="string">88s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>            <span class="number">3</span> <span class="string">(32s</span> <span class="string">ago)</span>   <span class="string">108s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>          <span class="number">3</span> <span class="string">(52s</span> <span class="string">ago)</span>   <span class="string">2m8s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>   <span class="number">3</span> <span class="string">(2s</span> <span class="string">ago)</span>    <span class="string">2m10s</span></span><br><span class="line"><span class="string">cunhuo</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>   <span class="number">3</span> <span class="string">(26s</span> <span class="string">ago)</span>   <span class="string">2m34s</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">cunhuotance-command.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用httpdget与tcp需要结合代码进行演示，过于繁杂就不演示了</span></span><br></pre></td></tr></table></figure>

<h3 id="就绪探测"><a href="#就绪探测" class="headerlink" title="就绪探测"></a>就绪探测</h3><p>就绪探测主要用于与pod与service相对接的场景下进行使用</p>
<p>探测pod内接口，探测成功则代表程序启动，就开放对外的接口访问，如果探测失败，则暂时不开放接口访问，直到探测成功</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#就绪探测举例</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yewu</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31180</span>   <span class="comment">#封装到外侧的端口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guanli</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31181</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">java</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">labels:</span> </span><br><span class="line">       <span class="attr">app:</span> <span class="string">java</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">xxxxx</span> <span class="comment">#封装了代码的容器镜像</span></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yewu</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guanli</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>   </span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span>          </span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span>   </span><br><span class="line">      <span class="attr">httpGet:</span>       <span class="comment">#进行就绪探测8081端口</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure>

<h1 id="k8s控制器ReplicaSet与Deployment"><a href="#k8s控制器ReplicaSet与Deployment" class="headerlink" title="k8s控制器ReplicaSet与Deployment"></a>k8s控制器ReplicaSet与Deployment</h1><p>控制器：</p>
<p>在Kubernetes（简称K8s）中，控制器是负责管理和维护集群中资源状态的组件。控制器监视集群中的对象，并根据它们的预期状态来采取行动，以确保系统的期望状态与实际状态保持一致。</p>
<p>对于自主式pod来说，删除pod之后pod就直接消失了，如果因为一些误操作或pod错误退出，就不会自动恢复，这个时候就需要使用k8s的控制器，使用控制器创建的pod可以进行故障的恢复与自愈，并且也可以做资源调度、配置管理等内容</p>
<h2 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h2><p>ReplicaSet是Kubernetes中的一种控制器，用于确保一组Pod副本的运行。它定义了所需的Pod副本数量，并监控它们的运行状态，以确保始终有指定数量的副本在运行。</p>
<p>用的不多，大多数环境中使用deployment资源，deployment的功能包括ReplicaSet</p>
<p>定义ReplicaSet时，需要定义要创建的pod的模板，相当于pod做了多份的负载均衡</p>
<p>以下是一个replicatest的示例文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">rs</span> </span><br><span class="line"><span class="string">apiVersion</span>   <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">kind</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">metadata</span>     <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">spec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">status</span>       <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">rs.spec</span></span><br><span class="line"><span class="string">minReadySeconds</span></span><br><span class="line"><span class="string">replicas</span></span><br><span class="line"><span class="string">selector</span></span><br><span class="line"><span class="string">template</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">rs.spec.template.spec</span> <span class="comment">#与pod的spec相同</span></span><br><span class="line"></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">rs.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">rstest</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span>  <span class="comment">#副本数</span></span><br><span class="line">  <span class="attr">selector:</span>    <span class="comment">#筛选器，与pod关联</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">       <span class="attr">user:</span> <span class="string">ws</span> <span class="comment">#匹配标签user=ws的pod</span></span><br><span class="line">  <span class="attr">template:</span>    <span class="comment">#pod模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>   <span class="comment">#pod标签</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">ws</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span> </span><br><span class="line">            <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">ports:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">startupProbe:</span>      <span class="comment">#启动探测</span></span><br><span class="line">              <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">              <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">              <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">              <span class="attr">httpGet:</span></span><br><span class="line">                 <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">                 <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">                 <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">rs.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">Running</span></span><br><span class="line"><span class="string">rstest-2qbrw</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m34s</span></span><br><span class="line"><span class="string">rstest-6j9p6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m34s</span></span><br><span class="line"><span class="string">rstest-ltpn5</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m34s</span></span><br><span class="line"><span class="string">rstest-z7h27</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m34s</span></span><br><span class="line"><span class="string">rstest-z8cnf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m34s</span></span><br><span class="line"><span class="comment">#desired期望3，current当前启动5，ready就绪5</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">rs</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">rstest</span>   <span class="number">5</span>         <span class="number">5</span>         <span class="number">5</span>       <span class="string">2m56s、</span></span><br><span class="line"><span class="comment">#退出其中一个pod，删除或异常退出都可以</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pods</span> <span class="string">rstest-hrvtj</span></span><br><span class="line"><span class="comment">#创建了一个新pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">Running</span></span><br><span class="line"><span class="string">rstest-6j9p6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m41s</span></span><br><span class="line"><span class="string">rstest-hrvtj</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">32s</span></span><br><span class="line"><span class="string">rstest-ltpn5</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m41s</span></span><br><span class="line"><span class="string">rstest-z7h27</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m41s</span></span><br><span class="line"><span class="string">rstest-z8cnf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m41s</span></span><br><span class="line"><span class="string">rstest-rmxcq</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">rstest-rmxcq</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">10s</span></span><br><span class="line"><span class="string">rstest-rmxcq</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#replicatest扩容与缩容</span></span><br><span class="line"><span class="comment">#修改yaml文件</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">6</span>  <span class="comment">#副本数</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">rs.yaml</span></span><br><span class="line"><span class="comment">#创建了一个新pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">Running</span></span><br><span class="line"><span class="string">rstest-6j9p6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12m</span></span><br><span class="line"><span class="string">rstest-ltpn5</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12m</span></span><br><span class="line"><span class="string">rstest-rmxcq</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">5m29s</span></span><br><span class="line"><span class="string">rstest-z7h27</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12m</span></span><br><span class="line"><span class="string">rstest-z8cnf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12m</span></span><br><span class="line"><span class="string">rstest-zwgnl</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">rstest-zwgnl</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">10s</span></span><br><span class="line"><span class="string">rstest-zwgnl</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">10s</span></span><br><span class="line"><span class="comment">#修改yaml文件</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>  <span class="comment">#副本数</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">rs.yaml</span></span><br><span class="line"><span class="comment">#全部被关闭，只剩俩</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171501.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#手动更新镜像，ReplicaSet无法实现滚动更新</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#原本状态</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.34</span><span class="string">:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改yaml文件</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">rs.yaml</span></span><br><span class="line"><span class="comment">#删除原有pods，因为replicatest无法实现滚动更新，而deployment可以</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pods</span> <span class="string">rstest-6j9p6</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pods</span> <span class="string">rstest-z8cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#因为某些原因没法起来，不过问题不大，注释掉探活部分就起来了</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">rstest-c2m98</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3m54s</span></span><br><span class="line"><span class="string">rstest-xkqnl</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3m54s</span></span><br><span class="line"><span class="comment">#当前状态，说明当前镜像已经被修改</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.124</span><span class="string">:8080</span></span><br><span class="line"><span class="string">&lt;!doctype</span> <span class="string">html&gt;&lt;html</span> <span class="string">lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP</span> <span class="string">Status</span> <span class="number">404</span> <span class="string">–</span> <span class="string">Not</span> <span class="string">Found&lt;/title&gt;&lt;style</span> <span class="string">type=&quot;text/css&quot;&gt;body</span> &#123;<span class="string">font-family:Tahoma</span>,<span class="string">Arial</span>,<span class="string">sans-serif;</span>&#125; <span class="string">h1,</span> <span class="string">h2,</span> <span class="string">h3,</span> <span class="string">b</span> &#123;<span class="string">color:white;background-color:#525D76;</span>&#125; <span class="string">h1</span> &#123;<span class="string">font-size:22px;</span>&#125; <span class="string">h2</span> &#123;<span class="string">font-size:16px;</span>&#125; <span class="string">h3</span> &#123;<span class="string">font-size:14px;</span>&#125; <span class="string">p</span> &#123;<span class="string">font-size:12px;</span>&#125; <span class="string">a</span> &#123;<span class="string">color:black;</span>&#125; <span class="string">.line</span> &#123;<span class="string">height:1px;background-color:#525D76;border:none;</span>&#125;<span class="string">&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP</span> <span class="string">Status</span> <span class="number">404</span> <span class="string">–</span> <span class="string">Not</span> <span class="string">Found&lt;/h1&gt;&lt;hr</span> <span class="string">class=&quot;line&quot;</span> <span class="string">/&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt;</span> <span class="string">Status</span> <span class="string">Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;</span> <span class="string">The</span> <span class="string">origin</span> <span class="string">server</span> <span class="string">did</span> <span class="string">not</span> <span class="string">find</span> <span class="string">a</span> <span class="string">current</span> <span class="string">representation</span> <span class="string">for</span> <span class="string">the</span> <span class="string">target</span> <span class="string">resource</span> <span class="string">or</span> <span class="string">is</span> <span class="string">not</span> <span class="string">willing</span> <span class="string">to</span> <span class="string">disclose</span> <span class="string">that</span> <span class="string">one</span> <span class="string">exists.&lt;/p&gt;&lt;hr</span> <span class="string">class=&quot;line&quot;</span> <span class="string">/&gt;&lt;h3&gt;Apache</span> <span class="string">Tomcat/10.1.17&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;[</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">rs.yaml</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171524.png"></p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>Deployment是Kubernetes中的一个重要组件，用于管理应用程序的部署和更新。它提供了一种声明性的方式来定义应用程序的期望状态，并确保集群中的Pod按照这个状态进行部署和维护。<br>简化了应用程序的部署和更新流程，并提供了健康检查、自动扩缩容、历史版本回滚等功能。</p>
<p>Deployment可以管理多个rs，进行滚动更新时，会使用新的rs，只同时使用一个rs。并且Deployment支持多种更新策略</p>
<h3 id="yaml文件编写"><a href="#yaml文件编写" class="headerlink" title="yaml文件编写"></a>yaml文件编写</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Deployment yaml文件编写</span></span><br><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment</span></span><br><span class="line"><span class="string">apiVersion</span>   <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">kind</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">metadata</span>     <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">spec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">status</span>       <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="comment">#spec内的功能包含replicaSet控制器的功能</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment.spec</span> </span><br><span class="line"><span class="string">minReadySeconds</span>      <span class="string">&lt;integer&gt;</span>           <span class="comment">#最小就绪时间，比如要升级就给它设一个值，默认为0</span></span><br><span class="line"><span class="string">paused</span>       <span class="string">&lt;boolean&gt;</span>    <span class="comment">#新pod是否要暂停</span></span><br><span class="line"><span class="string">progressDeadlineSeconds</span>      <span class="string">&lt;integer&gt;</span> <span class="comment">#</span></span><br><span class="line"><span class="string">replicas</span>     <span class="string">&lt;integer&gt;</span> <span class="comment">#pod副本数</span></span><br><span class="line"><span class="string">revisionHistoryLimit</span> <span class="string">&lt;integer&gt;</span> <span class="comment">#历史版本数量限制,默认为10</span></span><br><span class="line"><span class="string">selector</span>     <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span> <span class="comment">#筛选器</span></span><br><span class="line"><span class="string">strategy</span>     <span class="string">&lt;Object&gt;</span> <span class="comment">#更新策略</span></span><br><span class="line"><span class="string">template</span>     <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span> <span class="comment">#pod模板</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment.spec.strategy</span></span><br><span class="line"><span class="string">rollingUpdate</span>        <span class="string">&lt;Object&gt;</span> <span class="comment">#滚动更新</span></span><br><span class="line"><span class="string">type</span> <span class="string">&lt;string&gt;</span>                 <span class="comment">#类型，支持下面这两种</span></span><br><span class="line"><span class="attr">Possible enum values:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;Recreate&quot;`</span> <span class="string">Kill</span> <span class="string">all</span> <span class="string">existing</span> <span class="string">pods</span> <span class="string">before</span> <span class="string">creating</span> <span class="string">new</span> <span class="string">ones.</span> <span class="comment">#创建之前删除所有老的</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;RollingUpdate&quot;`</span> <span class="string">Replace</span> <span class="string">the</span> <span class="string">old</span> <span class="string">ReplicaSets</span> <span class="string">by</span> <span class="string">new</span> <span class="string">one</span> <span class="string">using</span> <span class="string">rolling</span></span><br><span class="line">     <span class="string">update</span> <span class="string">i.e</span> <span class="string">gradually</span> <span class="string">scale</span> <span class="string">down</span> <span class="string">the</span> <span class="string">old</span> <span class="string">ReplicaSets</span> <span class="string">and</span> <span class="string">scale</span> <span class="string">up</span> <span class="string">the</span> <span class="string">new</span></span><br><span class="line">     <span class="string">one.</span> <span class="comment">#根据更新策略进行更新</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment.spec.strategy.rollingUpdate</span></span><br><span class="line"><span class="string">maxSurge</span>     <span class="string">&lt;string&gt;</span> <span class="comment">#更新过程中最多的，比如4个里25%就是最多能同时存在5个</span></span><br><span class="line"><span class="string">maxUnavailable</span>       <span class="string">&lt;string&gt;</span> <span class="comment">#几个不可用的副本数，默认为25%，比如4个里25%最多只能有一个不可用</span></span><br><span class="line"><span class="comment">#可用整形或百分比，如果出现小数，maxSurge向上取整，maxUnavailable向下取整</span></span><br><span class="line"><span class="comment">#且这两个值不能同时为0，默认都为25%%</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment.spec.template</span></span><br><span class="line"><span class="string">metadata</span>     <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">spec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个yaml文件</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">dp.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">   <span class="attr">name:</span> <span class="string">dp-test</span></span><br><span class="line">   <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">   <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment">#   minReadySeconds: 10 #等待十秒后开始，默认为0秒</span></span><br><span class="line"><span class="comment">#   paused: False #不暂停</span></span><br><span class="line"><span class="comment">#   progressDeadlineSeconds: 600 #最大可等待时间，默认为600秒</span></span><br><span class="line">   <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment">#副本数，默认为1</span></span><br><span class="line">   <span class="attr">revisionHistoryLimit:</span> <span class="number">5</span> <span class="comment">#历史版本数，默认为10</span></span><br><span class="line">   <span class="attr">selector:</span> <span class="comment">#筛选条件</span></span><br><span class="line">     <span class="attr">matchLabels:</span></span><br><span class="line">         <span class="attr">app:</span> <span class="string">test</span>     <span class="comment">#找app=test标签的pod</span></span><br><span class="line">   <span class="attr">template:</span> </span><br><span class="line">     <span class="attr">metadata:</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">       <span class="attr">labels:</span>     </span><br><span class="line">         <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">     <span class="attr">spec:</span> </span><br><span class="line">         <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dp1</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">              <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">              <span class="attr">ports:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span> <span class="comment">#可用比例、达到预期的副本数、当前可用副本数</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test</span>   <span class="number">3</span><span class="string">/3</span>     <span class="number">3</span>            <span class="number">3</span>           <span class="string">69s</span> </span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">rs</span> <span class="comment">#定义的期望副本数、正在运行的副本数、就绪的副本数</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-648cf4f5</span>   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="string">114s</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-hbhmx</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m7s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-x9gb4</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m7s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m7s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="扩容与缩容"><a href="#扩容与缩容" class="headerlink" title="扩容与缩容"></a>扩容与缩容</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改dp.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">5</span> <span class="comment">#副本数，默认为1</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br><span class="line"><span class="comment">#再查看，已经变成五个了</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test</span>   <span class="number">5</span><span class="string">/5</span>     <span class="number">5</span>            <span class="number">5</span>           <span class="string">13m</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3m29s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-dssv7</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3m29s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-hbhmx</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">13m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-x9gb4</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">13m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">13m</span></span><br><span class="line"><span class="comment">#修改dp.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">2</span> <span class="comment">#副本数，默认为1</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br><span class="line"><span class="comment">#查看，删除的时候是随机删除的</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">14m</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="滚动更新与自定义策略"><a href="#滚动更新与自定义策略" class="headerlink" title="滚动更新与自定义策略"></a>滚动更新与自定义策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前状态</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.43</span><span class="string">:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="comment">#修改yaml文件，修改镜像</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">   <span class="attr">replicas:</span> <span class="number">4</span> <span class="comment">#副本数，默认为1</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br><span class="line"><span class="comment">#查看————滚动更新的策略默认为 先创建新的，后删除老的，25%</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">80m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">90m</span></span><br><span class="line"><span class="string">dp-test-6b98994689-v7d9w</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-v7d9w</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-v7d9w</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-v7d9w</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-v7d9w</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>     <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">90m</span></span><br><span class="line"><span class="string">dp-test-6b98994689-fzfv6</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>             <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-fzfv6</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>             <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-fzfv6</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>     <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">90m</span></span><br><span class="line"><span class="string">dp-test-6b98994689-fzfv6</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">90m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">90m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-znktp</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">90m</span></span><br><span class="line"><span class="string">dp-test-6b98994689-fzfv6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">2s</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>     <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">80m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>     <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">80m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">80m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">80m</span></span><br><span class="line"><span class="string">dp-test-648cf4f5-b82kv</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">80m</span></span><br><span class="line"><span class="comment">#新的rs接管了，老的rs废弃</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">rs</span></span><br><span class="line"><span class="string">NAME</span>                 <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-648cf4f5</span>     <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="string">92m</span></span><br><span class="line"><span class="string">dp-test-6b98994689</span>   <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="string">88s</span></span><br><span class="line"><span class="comment">#当前状态</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.66</span><span class="string">:8080</span></span><br><span class="line"><span class="string">&lt;!doctype</span> <span class="string">html&gt;&lt;html</span> <span class="string">lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP</span> <span class="string">Status</span> <span class="number">404</span> <span class="string">–</span> <span class="string">Not</span> <span class="string">Found&lt;/title&gt;&lt;style</span> <span class="string">type=&quot;text/css&quot;&gt;body</span> &#123;<span class="string">font-family:Tahoma</span>,<span class="string">Arial</span>,<span class="string">sans-serif;</span>&#125; <span class="string">h1,</span> <span class="string">h2,</span> <span class="string">h3,</span> <span class="string">b</span> &#123;<span class="string">color:white;background-color:#525D76;</span>&#125; <span class="string">h1</span> &#123;<span class="string">font-size:22px;</span>&#125; <span class="string">h2</span> &#123;<span class="string">font-size:16px;</span>&#125; <span class="string">h3</span> &#123;<span class="string">font-size:14px;</span>&#125; <span class="string">p</span> &#123;<span class="string">font-size:12px;</span>&#125; <span class="string">a</span> &#123;<span class="string">color:black;</span>&#125; <span class="string">.line</span> &#123;<span class="string">height:1px;background-color:#525D76;border:none;</span>&#125;<span class="string">&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP</span> <span class="string">Status</span> <span class="number">404</span> <span class="string">–</span> <span class="string">Not</span> <span class="string">Found&lt;/h1&gt;&lt;hr</span> <span class="string">class=&quot;line&quot;</span> <span class="string">/&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt;</span> <span class="string">Status</span> <span class="string">Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;</span> <span class="string">The</span> <span class="string">origin</span> <span class="string">server</span> <span class="string">did</span> <span class="string">not</span> <span class="string">find</span> <span class="string">a</span> <span class="string">current</span> <span class="string">representation</span> <span class="string">for</span> <span class="string">the</span> <span class="string">target</span> <span class="string">resource</span> <span class="string">or</span> <span class="string">is</span> <span class="string">not</span> <span class="string">willing</span> <span class="string">to</span> <span class="string">disclose</span> <span class="string">that</span> <span class="string">one</span> <span class="string">exi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#回滚版本</span></span><br><span class="line"><span class="comment">#查看历史版本</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">history</span> <span class="string">deployment</span> <span class="comment">#两个历史版本</span></span><br><span class="line"><span class="string">deployment.apps/dp-test</span></span><br><span class="line"><span class="string">REVISION</span>  <span class="string">CHANGE-CAUSE</span></span><br><span class="line"><span class="number">1</span>         <span class="string">&lt;none&gt;</span> <span class="comment">#对应nginx镜像</span></span><br><span class="line"><span class="number">2</span>         <span class="string">&lt;none&gt;</span> <span class="comment">#对应tomcat镜像</span></span><br><span class="line"><span class="comment">#进行回滚</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">undo</span> <span class="string">deployment.apps/dp-test</span> <span class="string">--to-revision=1</span></span><br><span class="line"><span class="comment">#查看rs，发现老的rs又被使用了</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">rs</span></span><br><span class="line"><span class="string">NAME</span>                 <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-648cf4f5</span>     <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="string">99m</span></span><br><span class="line"><span class="string">dp-test-6b98994689</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="string">8m22s</span></span><br><span class="line"><span class="comment">#查看网页状态</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.46</span><span class="string">:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#自定义滚动更新策略</span></span><br><span class="line"><span class="comment">#帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment.spec.strategy</span></span><br><span class="line"><span class="string">rollingUpdate</span>        <span class="string">&lt;Object&gt;</span> <span class="comment">#滚动更新</span></span><br><span class="line"><span class="string">type</span> <span class="string">&lt;string&gt;</span>                 <span class="comment">#类型，支持下面这两种，即Recreate与RollingUpate两种</span></span><br><span class="line"><span class="attr">Possible enum values:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;Recreate&quot;`</span> <span class="string">Kill</span> <span class="string">all</span> <span class="string">existing</span> <span class="string">pods</span> <span class="string">before</span> <span class="string">creating</span> <span class="string">new</span> <span class="string">ones.</span> <span class="comment">#创建之前删除所有老的</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">`&quot;RollingUpdate&quot;`</span> <span class="string">Replace</span> <span class="string">the</span> <span class="string">old</span> <span class="string">ReplicaSets</span> <span class="string">by</span> <span class="string">new</span> <span class="string">one</span> <span class="string">using</span> <span class="string">rolling</span></span><br><span class="line">     <span class="string">update</span> <span class="string">i.e</span> <span class="string">gradually</span> <span class="string">scale</span> <span class="string">down</span> <span class="string">the</span> <span class="string">old</span> <span class="string">ReplicaSets</span> <span class="string">and</span> <span class="string">scale</span> <span class="string">up</span> <span class="string">the</span> <span class="string">new</span></span><br><span class="line">     <span class="string">one.</span> <span class="comment">#根据更新策略进行更新</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Deployment.spec.strategy.rollingUpdate</span></span><br><span class="line"><span class="string">maxSurge</span>     <span class="string">&lt;string&gt;</span> <span class="comment">#更新过程中最多的，比如4个里25%就是最多能同时存在5个</span></span><br><span class="line"><span class="string">maxUnavailable</span>       <span class="string">&lt;string&gt;</span> <span class="comment">#几个不可用的副本数，默认为25%，比如4个里25%最多只能有一个不可用</span></span><br><span class="line"><span class="comment">#可用整形或百分比，如果出现小数，maxSurge向上取整，maxUnavailable向下取整</span></span><br><span class="line"><span class="comment">#且这两个值不能同时为0，默认都为25%</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用ollingUpdate模式</span></span><br><span class="line"><span class="comment">#一个一个删</span></span><br><span class="line"><span class="attr">maxUnavailable:</span> <span class="number">0</span> <span class="comment">#不能少于目标副本数，不能有存在不可用的副本</span></span><br><span class="line"><span class="attr">maxSurge:</span> <span class="number">1</span> <span class="comment">#顶多多一个</span></span><br><span class="line"><span class="comment">#maxUnavailable越小，更新越稳妥</span></span><br><span class="line"><span class="comment">#maxSurge越大，更新速度越快</span></span><br><span class="line"><span class="comment">#修改yaml文件</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">   <span class="attr">replicas:</span> <span class="number">4</span> <span class="comment">#副本数，默认为1</span></span><br><span class="line">   <span class="attr">strategy:</span></span><br><span class="line">     <span class="attr">rollingUpdate:</span></span><br><span class="line">        <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span> <span class="comment">#rollingUpdate模式下先创建，后删除</span></span><br><span class="line"><span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">dp-test-6b98994689-7p4qf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">26s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-fg79g</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">28s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-gjwpg</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">28s</span></span><br><span class="line"><span class="string">dp-test-6b98994689-tmwwj</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">26s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用recreate模式</span></span><br><span class="line"><span class="comment">#修改yaml文件</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span> <span class="comment">#镜像改回来</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br><span class="line"><span class="comment">#可以看到是先进行删除，后进行创建，在生产环境中大部分情况下都不会这么操作</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">dp.yaml</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171652.png"></p>
<h3 id="使用Deployment进行蓝绿部署"><a href="#使用Deployment进行蓝绿部署" class="headerlink" title="使用Deployment进行蓝绿部署"></a>使用Deployment进行蓝绿部署</h3><p>蓝绿部署（Blue-Green Deployment）是一种在应用程序部署过程中实现零停机和无缝切换的策略。它通过同时维护两个完全独立且相同配置的生产环境（蓝色环境和绿色环境），使得在切换新版本应用程序时不会中断用户访问。</p>
<p>与滚动更新不同的是蓝绿部署是同时存在两个环境，然后通过流量切换来切换环境，而滚动更新从始至终只使用了一个环境</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建蓝色和绿色的命名空间</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">blue-green</span></span><br><span class="line"><span class="comment">#创建绿色与蓝色环境的yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">green.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">green</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">color:</span> <span class="string">green</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">color:</span> <span class="string">green</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">green.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">blue-green</span> <span class="string">--show-labels</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span>   <span class="string">LABELS</span></span><br><span class="line"><span class="string">green-748cc6748f-76jq6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">67s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.52</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span>            <span class="string">color=bluegreen,pod-template-hash=748cc6748f</span></span><br><span class="line"><span class="string">green-748cc6748f-tv2rd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">67s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.73</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span>            <span class="string">color=bluegreen,pod-template-hash=748cc6748f</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建service文件</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">service_bluegreen.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lanlv</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30050</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">color:</span> <span class="string">green</span>  <span class="comment">#service关联color=green的标签的pod</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service_bluegreen.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">-n</span> <span class="string">blue-green</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">lanlv</span>   <span class="string">NodePort</span>   <span class="number">10.105</span><span class="number">.133</span><span class="number">.209</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30050/TCP</span>   <span class="string">3h23m</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建蓝色环境</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">blue.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">blue</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">color:</span> <span class="string">blue</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">color:</span> <span class="string">blue</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">blue.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前状态</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">blue-green</span> <span class="string">--show-labels</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">LABELS</span></span><br><span class="line"><span class="string">blue-6c4db4cbcc-79mlg</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3h13m</span>   <span class="string">color=blue,pod-template-hash=6c4db4cbcc</span></span><br><span class="line"><span class="string">blue-6c4db4cbcc-pv76m</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3h13m</span>   <span class="string">color=blue,pod-template-hash=6c4db4cbcc</span></span><br><span class="line"><span class="string">green-7fc6f944df-5br85</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3h14m</span>   <span class="string">color=green,pod-template-hash=7fc6f944df</span></span><br><span class="line"><span class="string">green-7fc6f944df-jvblp</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3h14m</span>   <span class="string">color=green,pod-template-hash=7fc6f944df</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当前状态————通过访问service代理的端口</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.105</span><span class="number">.133</span><span class="number">.209</span><span class="string">:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="comment">#也可以宿主机访问192.168.8.160（k8s集群master地址）:port（service定义的）来访问</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171823.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改service的yaml文件，使其匹配到labels=blue的pod</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30050</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">color:</span> <span class="string">blue</span>  <span class="comment">#service关联color=blue的标签的pod</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service_bluegreen.yaml</span></span><br><span class="line"><span class="comment">#再次查看状态</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.105</span><span class="number">.133</span><span class="number">.209</span><span class="string">:8080</span></span><br><span class="line"><span class="string">&lt;!doctype</span> <span class="string">html&gt;&lt;html</span> <span class="string">lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP</span> <span class="string">Status</span> <span class="number">404</span> <span class="string">–</span> <span class="string">Not</span> <span class="string">Found&lt;/title&gt;&lt;style</span> <span class="string">type=&quot;text/css&quot;&gt;body</span> &#123;<span class="string">font-family:Tahoma</span>,<span class="string">Arial</span>,<span class="string">sans-serif;</span>&#125; <span class="string">h1,</span> <span class="string">h2,</span> <span class="string">h3,</span> <span class="string">b</span> &#123;<span class="string">color:white;background-color:#525D76;</span>&#125; <span class="string">h1</span> &#123;<span class="string">font-size:22px;</span>&#125; <span class="string">h2</span> &#123;<span class="string">font-size:16px;</span>&#125; <span class="string">h3</span> &#123;<span class="string">font-size:14px;</span>&#125; <span class="string">p</span> &#123;<span class="string">font-size:12px;</span>&#125; <span class="string">a</span> &#123;<span class="string">color:black;</span>&#125; <span class="string">.line</span> &#123;<span class="string">height:1px;background-color:#525D76;border:none;</span>&#125;<span class="string">&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP</span> <span class="string">Status</span> <span class="number">404</span> <span class="string">–</span> <span class="string">Not</span> <span class="string">Found&lt;/h1&gt;&lt;hr</span> <span class="string">class=&quot;line&quot;</span> <span class="string">/&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt;</span> <span class="string">Status</span> <span class="string">Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;</span> <span class="string">The</span> <span class="string">origin</span> <span class="string">server</span> <span class="string">did</span> <span class="string">not</span> <span class="string">find</span> <span class="string">a</span> <span class="string">current</span> <span class="string">representation</span> <span class="string">for</span> <span class="string">the</span> <span class="string">target</span> <span class="string">resource</span> <span class="string">or</span> <span class="string">is</span> <span class="string">not</span> <span class="string">willing</span> <span class="string">to</span> <span class="string">disclose</span> <span class="string">that</span> <span class="string">one</span> <span class="string">exists.&lt;/p&gt;&lt;hr</span> <span class="string">class=&quot;line&quot;</span> <span class="string">/&gt;&lt;h3&gt;Apache</span> <span class="string">Tomcat/10.1.17&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;[root@ws-k8s-master1</span> <span class="string">~]#</span></span><br><span class="line"><span class="comment">#通过宿主机网页访问，清除缓存</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171849.png"></p>
<h3 id="使用Deployment进行金丝雀部署"><a href="#使用Deployment进行金丝雀部署" class="headerlink" title="使用Deployment进行金丝雀部署"></a>使用Deployment进行金丝雀部署</h3><p>金丝雀部署（Canary Deployment）是一种逐步发布新版本应用程序的部署策略。它的目标是在生产环境中逐渐引入新版本，以评估其性能、稳定性和用户反馈，同时最小化潜在的风险。</p>
<p>在金丝雀部署中，只有一小部分流量被导向到新版本，而大部分流量仍然被发送到稳定版本。这样可以在真实环境中进行测试，同时保持对用户的影响最小化。如果新版本表现良好，逐渐增加流量份额，直到完全切换到新版本。如果出现问题，可以快速回滚到稳定版本。又称灰度发布</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">deployment</span> <span class="string">blue</span> <span class="string">test2=docker.io/library/nginx</span> <span class="string">-n</span> <span class="string">blue-green</span> <span class="string">&amp;&amp;</span> <span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">pause</span> <span class="string">deployment</span> <span class="string">blue</span> <span class="string">-n</span> <span class="string">blue-green</span></span><br><span class="line"><span class="comment">#查看发现只运行了一个</span></span><br><span class="line"><span class="comment">#继续运行</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">resume</span> <span class="string">deployment</span> <span class="string">blue</span> <span class="string">-n</span> <span class="string">blue-green</span></span><br><span class="line"><span class="string">会开始更新剩余未更新的pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">service_bluegreen.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">blue.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">green.yaml</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419171928.png"></p>
<h1 id="四层代理service"><a href="#四层代理service" class="headerlink" title="四层代理service"></a>四层代理service</h1><p>Service在Kubernetes中提供了一种抽象的方式来公开应用程序的网络访问，并提供了负载均衡和服务发现等功能，使得应用程序在集群内外都能够可靠地进行访问。</p>
<p>每个Service都会自动关联一个对应的Endpoint。当创建一个Service时，Kubernetes会根据Service的选择器（selector）来找到匹配的Pod，并将这些Pod的IP地址和端口信息作为Endpoint的一部分。当Service接收到来自外部或内部的请求时，它会将请求转发到与之关联的Endpoint。Endpoint中包含了后端Pod的IP地址和端口信息，Service会根据负载均衡算法将请求转发到一个或多个后端Pod上。并且Service会自动关联到防火墙规则， 将pod的地址和端口保存在防火墙规则内</p>
<p>以上内容由gtp生成 </p>
<p>举个例子，以前我访问pod资源要一个一个访问，现在我把一堆具有相同特征（如标签）的pod绑定一个service，然后在service内侧与pod端口绑定，service外侧映射一个端口到宿主机，service还能改dns改防火墙规则。这样直接访问宿主机的端口就能访问到一组pod的特定端口。跟nginx做反向代理负载均衡差不多</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Service</span></span><br><span class="line"><span class="string">apiVersion</span>   <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">kind</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">metadata</span>     <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">spec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="string">status</span>       <span class="string">&lt;Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">Service.spec</span></span><br><span class="line"><span class="string">allocateLoadBalancerNodePorts</span>  <span class="string">&lt;boolean&gt;#是否是默认映射端口nodeports</span></span><br><span class="line"><span class="comment">#如果是，则会默认分配到30000-32767随机一个</span></span><br><span class="line"><span class="string">clusterIP</span>    <span class="string">&lt;string&gt;</span>   <span class="comment">#service的虚拟ip地址</span></span><br><span class="line"><span class="string">externalIPs</span>  <span class="string">&lt;[]string&gt;</span> <span class="comment">#公开到集群外的ip</span></span><br><span class="line"><span class="string">externalName</span> <span class="string">&lt;string&gt;</span> <span class="comment">#指定外部dns名称</span></span><br><span class="line"><span class="string">externalTrafficPolicy</span> <span class="string">&lt;string&gt;</span> <span class="comment">#定义外部流量策略，可选cluster或local</span></span><br><span class="line"><span class="string">healthCheckNodePort</span>  <span class="string">&lt;integer&gt;</span> <span class="comment">#用于健康检查的端口</span></span><br><span class="line"><span class="string">sessionAffinity</span> <span class="string">&lt;string&gt;</span>  <span class="comment">#会话策略，可选ClientIP或者None</span></span><br><span class="line"><span class="string">type</span> <span class="string">&lt;string&gt;</span>  <span class="comment">#类型，有四种，ExternalName, ClusterIP, NodePort, LoadBalancer</span></span><br><span class="line"><span class="string">ports</span>        <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">service.spec.ports</span></span><br><span class="line"><span class="string">name</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="string">nodePort</span>     <span class="string">&lt;integer&gt;</span> <span class="comment">#对外映射的端口</span></span><br><span class="line"><span class="string">port</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span> <span class="comment">#service的端口</span></span><br><span class="line"><span class="string">protocol</span>     <span class="string">&lt;string&gt;</span> <span class="comment">#可选SCTP、TCP、UDP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在node上下载旧版本的nginx</span></span><br><span class="line"><span class="string">ctr</span> <span class="string">images</span> <span class="string">pull</span> <span class="string">docker.io/library/nginx:1.21</span></span><br><span class="line"><span class="comment">#创建被管理的pod的yaml文件</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">service</span></span><br><span class="line"><span class="string">cd</span> <span class="string">service</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pod.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/library/nginx:1.21</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">startupProbe:</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span>        </span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod.yaml</span></span><br><span class="line"><span class="comment">#成功运行，就不去用curl验证了</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>                   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pods-8599b54cf-6tzrx</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12s</span></span><br><span class="line"><span class="string">pods-8599b54cf-vhxd8</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12s</span></span><br><span class="line"><span class="string">pods-8599b54cf-6tzrx</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">25s</span></span><br><span class="line"><span class="string">pods-8599b54cf-vhxd8</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">25s</span></span><br><span class="line"><span class="string">pods-8599b54cf-6tzrx</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">25s</span></span><br><span class="line"><span class="string">pods-8599b54cf-vhxd8</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">25s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ClusterIP模式"><a href="#ClusterIP模式" class="headerlink" title="ClusterIP模式"></a>ClusterIP模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### ClusterIP模式仅允许集群内部访问</span></span><br><span class="line"><span class="comment">#创建servicea-clusterip.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">service-clusterip.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span> <span class="comment">#service内侧端口</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment">#对应的pod的端口</span></span><br><span class="line">  <span class="attr">selector:</span>    <span class="comment">#筛选器，匹配标签nginx=&quot;1.21&quot;的pod</span></span><br><span class="line">     <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kubernetes</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span>        <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>   <span class="string">12d</span></span><br><span class="line"><span class="string">service</span>      <span class="string">ClusterIP</span>   <span class="number">10.107</span><span class="number">.178</span><span class="number">.176</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="string">31s</span></span><br><span class="line"><span class="comment">#查看Endpoint列表</span></span><br><span class="line"><span class="comment">#只有完成就绪探测的pod才会被service接管，才会被加入endpoint列表中。未完成启动探测的pod也不会</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">service</span> <span class="string">service</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">Endpoint</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80,10.10.234.86:80</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">ep</span> <span class="string">service</span> <span class="comment">#也可以</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">ENDPOINTS</span>                        <span class="string">AGE</span></span><br><span class="line"><span class="string">service</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80,10.10.234.86:80</span>   <span class="string">2m54s</span></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80</span></span><br><span class="line"><span class="comment">#service自动生成域名，仅在pod内可以进行访问</span></span><br><span class="line"><span class="string">service.default.svc.cluster.local:80</span></span><br><span class="line"><span class="comment">#进入pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">pods-8599b54cf-6tzrx</span> <span class="string">-it</span> <span class="string">--</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="string">curl</span> <span class="string">service.default.svc.cluster.local:80</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">service-clusterip.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="nodeport模式"><a href="#nodeport模式" class="headerlink" title="nodeport模式"></a>nodeport模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建service-nodeport.yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">service-nodeport.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">80</span>  <span class="comment">#对应的pod的端口</span></span><br><span class="line">     <span class="attr">nodePort:</span> <span class="number">30080</span> <span class="comment">#映射到物理机的端口，如果不写，会随机分配到30000-32767之间的一个</span></span><br><span class="line">  <span class="attr">selector:</span>          <span class="comment">#筛选器，匹配标签nginx=&quot;1.21&quot;的pod</span></span><br><span class="line">     <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service-nodeport.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">kubernetes</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span>      <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>        <span class="string">12d</span></span><br><span class="line"><span class="string">service</span>      <span class="string">NodePort</span>    <span class="number">10.108</span><span class="number">.9</span><span class="number">.134</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30080/TCP</span>   <span class="string">11s</span></span><br><span class="line"><span class="comment">#通过宿主机直接请求如图</span></span><br><span class="line"><span class="string">ipvsadm</span> <span class="string">-Ln</span> <span class="string">|</span> <span class="string">grep</span> <span class="number">30080</span> <span class="string">-A</span> <span class="number">2</span></span><br><span class="line"><span class="string">TCP</span>  <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span><span class="string">:30080</span> <span class="string">rr</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80</span>               <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.86</span><span class="string">:80</span>              <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">TCP</span>  <span class="number">192.168</span><span class="number">.8</span><span class="number">.160</span><span class="string">:30080</span> <span class="string">rr</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80</span>               <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">1</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.86</span><span class="string">:80</span>              <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">TCP</span>  <span class="number">192.168</span><span class="number">.122</span><span class="number">.1</span><span class="string">:30080</span> <span class="string">rr</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80</span>               <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.86</span><span class="string">:80</span>              <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">TCP</span>  <span class="number">10.10</span><span class="number">.189</span><span class="number">.192</span><span class="string">:30080</span> <span class="string">rr</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.1</span><span class="string">:80</span>               <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line">  <span class="string">-&gt;</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.86</span><span class="string">:80</span>              <span class="string">Masq</span>    <span class="number">1</span>      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">service-nodeport.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419172049.png"></p>
<h2 id="ExternalName模式"><a href="#ExternalName模式" class="headerlink" title="ExternalName模式"></a>ExternalName模式</h2><p>充当一个别名，将服务映射到集群外部的一个外部域名。当使用该服务时，Kubernetes会将服务的DNS解析为ExternalName指定的外部域名，从而实现对外部服务的访问。这种模式适用于需要将服务与集群外部的现有服务进行关联的场景。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用以跨namespace调用资源</span></span><br><span class="line"><span class="comment">#创建一个新的ns</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">server</span></span><br><span class="line"><span class="comment">#创建server中的yaml文件</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pod-in-server.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/library/nginx:1.21</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-in-server.yaml</span></span><br><span class="line"><span class="comment">#创建pod in server中的service四层代理</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">service-in-server.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-in-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">     <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service-in-server.yaml</span></span><br><span class="line"><span class="comment">#创建default中的service，设置为externalname</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">service-externalname.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">service-in-server.server.svc.cluster.local</span> <span class="comment">#设置要关联的service的域名</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">     <span class="attr">nginx:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service-externalname.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">server</span></span><br><span class="line"><span class="string">NAME</span>                    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pods-8649769f54-fs72b</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">22s</span></span><br><span class="line"><span class="comment">#进入默认的ns的pod中，通过域名访问server的ns中的pod资源</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">pods-8599b54cf-6tzrx</span> <span class="string">-it</span> <span class="string">--</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="string">curl</span> <span class="string">service-in-server.server.svc.cluster.local</span></span><br><span class="line"><span class="comment">#可以访问到</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">html</span> &#123; <span class="attr">color-scheme:</span> <span class="string">light</span> <span class="string">dark;</span> &#125;</span><br><span class="line"><span class="string">body</span> &#123; <span class="attr">width:</span> <span class="string">35em;</span> <span class="attr">margin:</span> <span class="number">0</span> <span class="string">auto;</span></span><br><span class="line"><span class="attr">font-family:</span> <span class="string">Tahoma</span>, <span class="string">Verdana</span>, <span class="string">Arial</span>, <span class="string">sans-serif;</span> &#125;</span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If</span> <span class="string">you</span> <span class="string">see</span> <span class="string">this</span> <span class="string">page,</span> <span class="string">the</span> <span class="string">nginx</span> <span class="string">web</span> <span class="string">server</span> <span class="string">is</span> <span class="string">successfully</span> <span class="string">installed</span> <span class="string">and</span></span><br><span class="line"><span class="string">working.</span> <span class="string">Further</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;For</span> <span class="string">online</span> <span class="string">documentation</span> <span class="string">and</span> <span class="string">support</span> <span class="string">please</span> <span class="string">refer</span> <span class="string">to</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial</span> <span class="string">support</span> <span class="string">is</span> <span class="string">available</span> <span class="string">at</span></span><br><span class="line"><span class="string">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">using</span> <span class="string">nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">service-externalname.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">service-in-server.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pod-in-server.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="通过service和endpoint引用外部mysql的最佳实践"><a href="#通过service和endpoint引用外部mysql的最佳实践" class="headerlink" title="通过service和endpoint引用外部mysql的最佳实践"></a>通过service和endpoint引用外部mysql的最佳实践</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node节点</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">mariadb-server.x86_64</span> <span class="string">-y</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">start</span> <span class="string">mariadb</span></span><br><span class="line"><span class="comment">#master节点</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">mysql.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">mysql.yaml</span></span><br><span class="line"><span class="comment">#此时是没有绑定endpoint的</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#创建endpoint的service文件，endpoint资源名必须与service资源名相同</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">mysql_endpoint.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.162</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span> <span class="comment">#将endpoint关联到192.168.8.162:3306</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">mysql_endpoint.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时service资源和endpoint资源关联上了</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">ENDPOINTS</span>                               <span class="string">AGE</span></span><br><span class="line"><span class="string">kubernetes</span>   <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span><span class="string">:6443,192.168.8.160:6443</span>   <span class="string">12d</span></span><br><span class="line"><span class="string">mysql</span>        <span class="number">192.168</span><span class="number">.8</span><span class="number">.162</span><span class="string">:3306</span>                      <span class="string">2m29s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">svc</span> <span class="string">mysql</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-i</span> <span class="string">endpoint</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">192.168</span><span class="number">.8</span><span class="number">.162</span><span class="string">:3306</span></span><br></pre></td></tr></table></figure>

<h1 id="k8s-持久化存储"><a href="#k8s-持久化存储" class="headerlink" title="k8s 持久化存储"></a>k8s 持久化存储</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pods.spec.volumes</span></span><br><span class="line"><span class="string">awsElasticBlockStore</span>    <span class="string">&lt;Object&gt;</span>               <span class="comment"># AWS Elastic Block Store（EBS）卷的配置对象</span></span><br><span class="line"><span class="string">azureDisk</span>               <span class="string">&lt;Object&gt;</span>               <span class="comment"># Azure Disk卷的配置对象</span></span><br><span class="line"><span class="string">azureFile</span>               <span class="string">&lt;Object&gt;</span>               <span class="comment"># Azure File卷的配置对象</span></span><br><span class="line"><span class="string">cephfs</span>                  <span class="string">&lt;Object&gt;</span>               <span class="comment"># Ceph文件系统的配置对象</span></span><br><span class="line"><span class="string">cinder</span>                  <span class="string">&lt;Object&gt;</span>               <span class="comment"># Cinder卷的配置对象</span></span><br><span class="line"><span class="string">configMap</span>               <span class="string">&lt;Object&gt;</span>               <span class="comment"># ConfigMap卷的配置对象</span></span><br><span class="line"><span class="string">csi</span>                     <span class="string">&lt;Object&gt;</span>               <span class="comment"># Container Storage Interface（CSI）卷的配置对象</span></span><br><span class="line"><span class="string">downwardAPI</span>             <span class="string">&lt;Object&gt;</span>               <span class="comment"># Downward API卷的配置对象</span></span><br><span class="line"><span class="string">emptyDir</span>                <span class="string">&lt;Object&gt;</span>               <span class="comment"># EmptyDir卷的配置对象,临时卷</span></span><br><span class="line"><span class="string">ephemeral</span>               <span class="string">&lt;Object&gt;</span>               <span class="comment"># 临时卷的配置对象，该卷的生命周期与Pod的生命周期相同</span></span><br><span class="line"><span class="string">fc</span>                      <span class="string">&lt;Object&gt;</span>               <span class="comment"># Fibre Channel（FC）卷的配置对象</span></span><br><span class="line"><span class="string">flexVolume</span>              <span class="string">&lt;Object&gt;</span>               <span class="comment"># FlexVolume卷的配置对象</span></span><br><span class="line"><span class="string">flocker</span>                 <span class="string">&lt;Object&gt;</span>               <span class="comment"># Flocker卷的配置对象</span></span><br><span class="line"><span class="string">gcePersistentDisk</span>       <span class="string">&lt;Object&gt;</span>               <span class="comment"># Google Compute Engine（GCE）持久磁盘卷的配置对象</span></span><br><span class="line"><span class="string">gitRepo</span>                 <span class="string">&lt;Object&gt;</span>               <span class="comment"># Git存储库卷的配置对象</span></span><br><span class="line"><span class="string">glusterfs</span>               <span class="string">&lt;Object&gt;</span>               <span class="comment"># GlusterFS卷的配置对象</span></span><br><span class="line"><span class="string">hostPath</span>                <span class="string">&lt;Object&gt;</span>               <span class="comment"># HostPath卷的配置对象，使用主机上的文件或目录作为卷</span></span><br><span class="line"><span class="string">iscsi</span>                   <span class="string">&lt;Object&gt;</span>               <span class="comment"># iSCSI卷的配置对象</span></span><br><span class="line"><span class="string">name</span>                    <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>    <span class="comment"># 表示卷的名称（必需）</span></span><br><span class="line"><span class="string">nfs</span>                     <span class="string">&lt;Object&gt;</span>               <span class="comment"># NFS卷的配置对象</span></span><br><span class="line"><span class="string">persistentVolumeClaim</span>   <span class="string">&lt;Object&gt;</span>               <span class="comment"># 持久卷声明（PVC）的配置对象</span></span><br><span class="line"><span class="string">photonPersistentDisk</span>    <span class="string">&lt;Object&gt;</span>               <span class="comment"># Photon持久磁盘卷的配置对象</span></span><br><span class="line"><span class="string">portworxVolume</span>          <span class="string">&lt;Object&gt;</span>               <span class="comment"># Portworx卷的配置对象</span></span><br><span class="line"><span class="string">projected</span>               <span class="string">&lt;Object&gt;</span>               <span class="comment"># Projected卷的配置对象，可以将多种卷类型投影到单个卷中</span></span><br><span class="line"><span class="string">quobyte</span>                 <span class="string">&lt;Object&gt;</span>               <span class="comment"># Quobyte卷的配置对象</span></span><br><span class="line"><span class="string">rbd</span>                     <span class="string">&lt;Object&gt;</span>               <span class="comment"># Rados Block Device（RBD）卷的配置对象</span></span><br></pre></td></tr></table></figure>

<h2 id="emptyDir临时目录"><a href="#emptyDir临时目录" class="headerlink" title="emptyDir临时目录"></a>emptyDir临时目录</h2><p>该目录在Pod的所有容器之间是可共享的，容器可以读取和写入其中的文件。emptyDir卷的生命周期与Pod的生命周期相同，当Pod被删除或重启时，emptyDir中的数据也会被清除。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个卷</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">linshi-dir.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">stor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span>   <span class="comment">#挂载到容器内的临时目录/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">linshi</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">linshi</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;   <span class="comment">#创建一个临时目录作为容器的卷</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">linshi-dir.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>             <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">stor</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3m28s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.66</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment">#查看与测试，找到node的临时目录</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">stor</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">uid</span></span><br><span class="line"><span class="comment">#  uid: 35339f94-e827-4227-be53-9b0ac7116ec5</span></span><br><span class="line"><span class="comment">#node节点</span></span><br><span class="line"><span class="string">ls</span> <span class="string">/var/lib/kubelet/pods</span> <span class="string">-l</span></span><br><span class="line"><span class="string">total</span> <span class="number">0</span></span><br><span class="line"><span class="string">drwxr-x---</span> <span class="number">5</span> <span class="string">root</span> <span class="string">root</span> <span class="number">71</span> <span class="string">Jan</span> <span class="number">19</span> <span class="number">08</span><span class="string">:11</span> <span class="string">35339f94-e827-4227-be53-9b0ac7116ec5</span></span><br><span class="line"><span class="string">drwxr-x---</span> <span class="number">5</span> <span class="string">root</span> <span class="string">root</span> <span class="number">71</span> <span class="string">Jan</span> <span class="number">19</span> <span class="number">08</span><span class="string">:11</span> <span class="string">cc056149-ee92-4080-a8d5-15de19f4dee5</span></span><br><span class="line"><span class="string">drwxr-x---</span> <span class="number">5</span> <span class="string">root</span> <span class="string">root</span> <span class="number">71</span> <span class="string">Jan</span>  <span class="number">6</span> <span class="number">18</span><span class="string">:36</span> <span class="string">e6696d51-c037-49a8-bfeb-c0c452b0558b</span></span><br><span class="line"><span class="string">drwxr-x---</span> <span class="number">5</span> <span class="string">root</span> <span class="string">root</span> <span class="number">71</span> <span class="string">Jan</span> <span class="number">19</span> <span class="number">08</span><span class="string">:11</span> <span class="string">eaec4ad0-b509-472d-9c8f-7271b6379482</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">cd</span> <span class="string">35339f94-e827-4227-be53-9b0ac7116ec5</span></span><br><span class="line"><span class="string">cd</span> <span class="string">volumes/kubernetes.io~empty-dir</span></span><br><span class="line"><span class="comment">#进入容器</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">stor</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/cache/1.txt</span></span><br><span class="line"><span class="comment">#查看node节点</span></span><br><span class="line"><span class="string">ls</span> <span class="string">linshi/</span></span><br><span class="line"><span class="number">1.</span><span class="string">txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">linshi-dir.yaml</span></span><br><span class="line"><span class="comment">#目录已经随着pod删除而消失</span></span><br><span class="line"><span class="string">ls</span> <span class="string">linshi/</span></span><br><span class="line"><span class="attr">ls: cannot access linshi/:</span> <span class="literal">No</span> <span class="string">such</span> <span class="string">file</span> <span class="string">or</span> <span class="string">directory</span></span><br></pre></td></tr></table></figure>

<h2 id="hostpath"><a href="#hostpath" class="headerlink" title="hostpath"></a>hostpath</h2><p>允许把节点的目录挂载到容器上，但跨节点不行，所以需要确保能够调度到同一节点。</p>
<p>支持持久化存储，类似于容器的bind mount，因此安全性存在问题，需要尽量设置为只读类型</p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419172243.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在node上创建一个目录用以挂载pod，也可以不创建，因为type可以选择</span></span><br><span class="line"><span class="comment">#mkdir /stor-test</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">hostpath-stor.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">stor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span>   <span class="comment">#挂载到容器内的目录/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/stor-test</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span> <span class="comment">#如果在给定路径上什么都不存在，那么将根据需要创建空目录</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">hostpath-stor.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>     <span class="string">AGE</span>   <span class="string">IP</span>            <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">stor</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(2s</span> <span class="string">ago)</span>   <span class="string">5s</span>    <span class="number">10.10</span><span class="number">.179</span><span class="number">.2</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">stor</span> <span class="string">-c</span> <span class="string">test1</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/cache/1.txt</span></span><br><span class="line"><span class="comment">#n进入test2查看</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">stor</span> <span class="string">-c</span> <span class="string">test2</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">root@stor:/usr/local/tomcat#</span> <span class="string">ls</span> <span class="string">/cache/</span></span><br><span class="line"><span class="number">1.</span><span class="string">txt</span></span><br><span class="line"><span class="comment">#说明test1和test2之间已经完成容器存储的共享</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">hostpath-stor.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="nfs持久化存储"><a href="#nfs持久化存储" class="headerlink" title="nfs持久化存储"></a>nfs持久化存储</h2><p>NFS（Network File System）是一种用于在计算机网络中共享文件的协议和文件系统。它允许在不同的计算机之间通过网络访问和共享文件，就像这些文件位于本地文件系统上一样。</p>
<p>NFS是一种分布式文件系统，它允许客户端计算机通过网络挂载和访问远程服务器上的文件系统。NFS使用客户端-服务器模型，其中服务器端维护存储在共享目录中的文件，并向客户端提供访问权限。弥补了hostpath的缺点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在master2与node节点上创建nfs</span></span><br><span class="line"><span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">nfs-utils</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span> <span class="string">nfs</span> <span class="string">--now</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">/dirfornfs</span></span><br><span class="line"><span class="comment">#挂载dirfornfs目录，允许所有网段，读写权限，且以root访问</span></span><br><span class="line"><span class="comment">#生产环境中不要这么配置</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;/dirfornfs *(rw,no_root_squash)&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/etc/exports</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node测试</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">test</span></span><br><span class="line"><span class="string">mount</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span><span class="string">:/dirfornfs</span> <span class="string">test</span></span><br><span class="line"><span class="string">df</span> <span class="string">-Th</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">test</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span><span class="string">:/dirfornfs</span> <span class="string">nfs4</span>       <span class="string">50G</span>  <span class="number">7.</span><span class="string">6G</span>   <span class="string">43G</span>  <span class="number">16</span><span class="string">%</span> <span class="string">/root/test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master创建yaml</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">cunchu-nfs.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">     <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">cunchu:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">template:</span> </span><br><span class="line">      <span class="attr">metadata:</span></span><br><span class="line">         <span class="attr">name:</span> <span class="string">nfs-pod</span></span><br><span class="line">         <span class="attr">labels:</span> </span><br><span class="line">             <span class="attr">cunchu:</span> <span class="string">nfs</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">             <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">             <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">             <span class="attr">ports:</span> </span><br><span class="line">              <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">volumeMounts:</span> </span><br><span class="line">               <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">                 <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span> <span class="comment">#nginx默认的首页</span></span><br><span class="line">          <span class="attr">volumes:</span> </span><br><span class="line">             <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">               <span class="attr">nfs:</span>  <span class="comment">#要挂载的服务器的ip与目录</span></span><br><span class="line">                 <span class="attr">path:</span> <span class="string">/dirfornfs</span>  </span><br><span class="line">                 <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cunchu-nfs.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">test-nfs-5559d84cd6-sb25b</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">62s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.4</span>    <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-nfs-5559d84cd6-w77mf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">62s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.67</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment">#在nfs服务器端创建首页</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/dirfornfs/</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&#x27;123&#x27;</span> <span class="string">&gt;</span> <span class="string">index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问这两个pod查看网页，已经同步</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.179</span><span class="number">.4</span><span class="string">:80</span></span><br><span class="line"><span class="number">123</span></span><br><span class="line"><span class="string">curl</span> <span class="number">10.10</span><span class="number">.234</span><span class="number">.67</span><span class="string">:80</span></span><br><span class="line"><span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">cunchu-nfs.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="k8s-持久化存储PV和PVC"><a href="#k8s-持久化存储PV和PVC" class="headerlink" title="k8s 持久化存储PV和PVC"></a>k8s 持久化存储PV和PVC</h1><h2 id="PV和PVC"><a href="#PV和PVC" class="headerlink" title="PV和PVC"></a>PV和PVC</h2><p>PV 和 PVC 之间的关系是一种动态的供需匹配关系。PVC 表示应用程序对持久化存储的需求，而 PV 表示可用的持久化存储资源。Kubernetes 控制平面会根据 PVC 的需求来选择和绑定合适的 PV，将其挂载到应用程序的 Pod 中，从而使应用程序可以访问持久化存储。</p>
<p>PV可以静态或动态的创建；PV和PVC必须一一对应；PVC如果没有对应的绑定PV则会Pending</p>
<p>PVC被删除后，PV内的数据有两种处理策略分别是Retain保留（默认）、Delete删除</p>
<p>接下来的实验中会对这几种模式进行测试，测试结果发现并没有什么区别（k8s1.26）</p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419172442.png"></p>
<h2 id="静态创建PV"><a href="#静态创建PV" class="headerlink" title="静态创建PV"></a>静态创建PV</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#绑定master2节点的/dirfornfs</span></span><br><span class="line"><span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">nfs-utils</span></span><br><span class="line"><span class="comment">#创建一个新的nfs目录，并添加到/etc/exports文件中</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/dirfornfs/&#123;1..5&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;/dirfornfs *(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/dirfornfs/1 *(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/dirfornfs/2 *(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/dirfornfs/3 *(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/dirfornfs/4 *(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/dirfornfs/5 *(rw,no_root_squash)&quot;</span> <span class="string">&gt;</span> <span class="string">/etc/exports</span></span><br><span class="line"><span class="comment">#创建pv资源</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">jintai-PV.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">jintai-pv1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">stor:</span> <span class="string">pv1</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">nfs:</span> </span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/dirfornfs/1</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]  <span class="comment">#访问模式 只支持同一node的读写</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="number">1.</span><span class="string">5Gi</span>  <span class="comment">#分配1.5个G</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">jintai-pv2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">stor:</span> <span class="string">pv2</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">nfs:</span> </span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/dirfornfs/2</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>] <span class="comment">#支持多个node读写</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">2Gi</span>  <span class="comment">#分配2个G</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">jintai-pv3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">stor:</span> <span class="string">pv3</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">nfs:</span> </span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/dirfornfs/3</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadOnlyMany&quot;</span>]  <span class="comment">#多个node只读</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">3Gi</span>  <span class="comment">#分配3个G</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">jintai-PV.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pv</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>     </span><br><span class="line"><span class="string">jintai-pv1</span>   <span class="string">1536Mi</span>     <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>   <span class="comment">#单节点读写   </span></span><br><span class="line"><span class="string">jintai-pv2</span>   <span class="string">2Gi</span>        <span class="string">RWX</span>            <span class="string">Retain</span>           <span class="string">Available</span>   <span class="comment">#多节点读写   </span></span><br><span class="line"><span class="string">jintai-pv3</span>   <span class="string">3Gi</span>        <span class="string">ROX</span>            <span class="string">Retain</span>           <span class="string">Available</span>   <span class="comment">#多节点只读</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建pvc</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pvc.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>] <span class="comment">#对应的pv必须访问模式保持相同</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">       <span class="attr">stor:</span> <span class="string">pv1</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">     <span class="attr">requests:</span></span><br><span class="line">       <span class="attr">storage:</span> <span class="number">1.</span><span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>] <span class="comment">#对应的pv必须访问模式保持相同</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">       <span class="attr">stor:</span> <span class="string">pv2</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">     <span class="attr">requests:</span></span><br><span class="line">       <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadOnlyMany&quot;</span>] <span class="comment">#对应的pv必须访问模式保持相同</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">       <span class="attr">stor:</span> <span class="string">pv3</span> <span class="comment">#对应上pv的标签</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">     <span class="attr">requests:</span></span><br><span class="line">       <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pvc</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">STATUS</span>   <span class="string">VOLUME</span>       <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pvc1</span>   <span class="string">Bound</span>    <span class="string">jintai-pv1</span>   <span class="string">1536Mi</span>     <span class="string">RWO</span>                           <span class="string">54s</span></span><br><span class="line"><span class="string">pvc2</span>   <span class="string">Bound</span>    <span class="string">jintai-pv2</span>   <span class="string">2Gi</span>        <span class="string">RWX</span>                           <span class="string">54s</span></span><br><span class="line"><span class="string">pvc3</span>   <span class="string">Bound</span>    <span class="string">jintai-pv3</span>   <span class="string">3Gi</span>        <span class="string">ROX</span>                           <span class="string">54s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建pod1，让pvc1挂载上去</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pod-pvc.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-pvc1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">stor:</span> <span class="string">pvc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">stor:</span> <span class="string">pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">pvc1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-pvc2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">stor:</span> <span class="string">pvc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">stor:</span> <span class="string">pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pvc2</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc2</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">pvc2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-pvc3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">stor:</span> <span class="string">pvc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">stor:</span> <span class="string">pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pvc3</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc3</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">pvc3</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-owide</span></span><br><span class="line"><span class="string">NAME</span>                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod-pvc1-69b655447-5zmjn</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.12</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc1-69b655447-crnfr</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.11</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc1-69b655447-kzpf5</span>    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.75</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc2-697979cddb-6x658</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.13</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc2-697979cddb-bxcxm</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.15</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc2-697979cddb-zffwh</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.74</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc3-7588fbc489-2v8pt</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.14</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc3-7588fbc489-5scpd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.76</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-pvc3-7588fbc489-b7cp9</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">95s</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.77</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment">#进入不同node节点的pod查看是否同步</span></span><br><span class="line"><span class="comment">#pvc1</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">pod-pvc1-69b655447-5zmjn</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">cd</span>  <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="string">touch</span> <span class="number">11</span></span><br><span class="line"><span class="string">exit</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">pod-pvc1-69b655447-kzpf5</span>  <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">ls</span> <span class="string">/usr/share/nginx/html/11</span></span><br><span class="line"><span class="string">/usr/share/nginx/html/11</span> <span class="comment">#不同节点依然可以同时访问到这个pv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pvc2也可以，略过了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pvc3  ACCESS MODES为ROX，无法创建</span></span><br><span class="line"><span class="string">root@pod-pvc3-7588fbc489-b7cp9:/#</span> <span class="string">touch</span> <span class="number">123454</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="string">root@pod-pvc3-7588fbc489-b7cp9:/#</span></span><br><span class="line"><span class="string">root@pod-pvc3-7588fbc489-b7cp9:/#</span> <span class="string">ls</span> <span class="string">/usr/share/nginx/html/</span> </span><br><span class="line"><span class="string">root@pod-pvc3-7588fbc489-b7cp9:/#</span> <span class="string">无输出</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#删除</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pod-pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">jintai-PV.yaml</span></span><br><span class="line"><span class="comment">#启用</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">jintai-PV.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">pod-pvc1-69b655447-46h5h</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">ls</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="number">11</span> <span class="comment">#依然保留了数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改回收策略</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">vim</span> <span class="string">jintai-PV.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">capacity:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="number">1.</span><span class="string">5Gi</span>  <span class="comment">#分配1.5个G</span></span><br><span class="line"><span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span> <span class="comment">#回收策略为Delete</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pod-pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">jintai-PV.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">jintai-PV.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个新pod关联pvc1</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pod-test.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-pvc-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test10</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">pvc1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-test.yaml</span></span><br><span class="line"><span class="comment">#使用测试pod新建文件</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">pod-pvc-test</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">cd</span>  <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="string">mkdir</span> <span class="number">123</span></span><br><span class="line"><span class="string">exit</span> </span><br><span class="line"><span class="comment">#进入另一个pod查看</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">pod-pvc1-69b655447-7lxwl</span>  <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">ls</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="number">123</span>  <span class="number">12345</span></span><br><span class="line"><span class="comment">#删除新建文件的测试pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pod-test.yaml</span></span><br><span class="line"><span class="comment">#在另一个查看</span></span><br><span class="line"><span class="string">ls</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="number">123</span>  <span class="number">12345</span> <span class="comment">#依然存在</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#回收策略Delete和Retain没什么区别，都不会被删除</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pod-pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pvc.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">jintai-PV.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="StorageClass创建pv"><a href="#StorageClass创建pv" class="headerlink" title="StorageClass创建pv"></a>StorageClass创建pv</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">storageclass</span></span><br><span class="line"><span class="string">allowVolumeExpansion</span> <span class="string">&lt;boolean&gt;</span> <span class="comment"># 是否允许持久卷的扩展，不能支持缩小</span></span><br><span class="line"><span class="string">allowedTopologies</span> <span class="string">&lt;[]Object&gt;</span> <span class="comment"># 定义允许使用该StorageClass的节点拓扑约束</span></span><br><span class="line"><span class="string">apiVersion</span> <span class="string">&lt;string&gt;</span> </span><br><span class="line"><span class="string">kind</span> <span class="string">&lt;string&gt;</span> </span><br><span class="line"><span class="string">metadata</span> <span class="string">&lt;Object&gt;</span> </span><br><span class="line"><span class="string">mountOptions</span> <span class="string">&lt;[]string&gt;</span> <span class="comment"># 挂载持久卷时使用的挂载选项</span></span><br><span class="line"><span class="string">parameters</span> <span class="string">&lt;map[string]string&gt;</span> <span class="comment"># 存储提供程序的特定参数</span></span><br><span class="line"><span class="string">provisioner</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span> <span class="comment"># 供应商，不同供应商要填写的不同</span></span><br><span class="line"><span class="string">reclaimPolicy</span> <span class="string">&lt;string&gt;</span> <span class="comment"># 定义持久卷回收策略</span></span><br><span class="line"><span class="string">volumeBindingMode</span> <span class="string">&lt;string&gt;</span> <span class="comment"># 定义持久卷与节点的绑定模式</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#在nfs服务器中加入实验的目录</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/dirfornfs/nfs</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;/dirfornfs/nfs *(rw,no_root_squash)&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/etc/exports</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">restart</span> <span class="string">nfs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建nfs的资源供应商的认证授权</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">serviceaccount.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">serviceaccount.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">nfs-provisioner-clusterrolebinding</span> <span class="string">--clusterrole=cluster-admin</span> <span class="string">--serviceaccount=default:nfs-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">nfs.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-beijing.aliyuncs.com/mydlq/nfs-subdir-external-provisioner:v4.0.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span>                        <span class="comment">#环境变量</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span>  <span class="comment">#供应商名称值改为example.com/nfs,存储类文件需要于其一致</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">example.com/nfs</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/dirfornfs/nfs/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.159</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dirfornfs/nfs/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">nfs.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个nfs的storageclass存储类</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">nfs-storageclass.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs</span>                  <span class="comment">#存储类名称为nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">example.com/nfs</span> <span class="comment">#nfs的供应商为example.com/nfs</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">nfs-storageclass.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据存储类 创建pvc</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pvc.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span>  [<span class="string">&quot;ReadWriteMany&quot;</span>] <span class="comment">#多节点可读写</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span>   <span class="comment">#要与上面的存储类名字相同</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pv-sc.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pv</span></span><br><span class="line"><span class="string">NAME</span>                                       <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>   <span class="string">CLAIM</span>                <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pvc-660c088b-c9ba-412b-8c54-7d0716844b24</span>   <span class="string">1Gi</span>        <span class="string">RWX</span>            <span class="string">Delete</span>           <span class="string">Bound</span>    <span class="string">default/claim-test</span>   <span class="string">nfs</span>                     <span class="string">2m58s</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pvc</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">STATUS</span>   <span class="string">VOLUME</span>                                     <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test</span>   <span class="string">Bound</span>    <span class="string">pvc-660c088b-c9ba-412b-8c54-7d0716844b24</span>   <span class="string">1Gi</span>        <span class="string">RWX</span>            <span class="string">nfs</span>            <span class="string">3m13s</span></span><br><span class="line"><span class="comment">#已经绑定完成</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pvc-test.yaml</span> <span class="string">&lt;&lt;</span>  <span class="string">EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">read-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">&quot;Never&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span>  <span class="comment">#</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">test</span> </span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pvc-test.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                               <span class="string">READY</span>   <span class="string">STATUS</span>              <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs-provisioner-5468dbd878-95jmz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">15m</span></span><br><span class="line"><span class="string">read-pod</span>                           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">14m</span></span><br><span class="line"><span class="comment">#正常运行</span></span><br><span class="line"><span class="comment">#查看nfs服务器，自动创建了对应的目录</span></span><br><span class="line"><span class="string">ls</span> <span class="string">/dirfornfs/nfs/</span></span><br><span class="line"><span class="string">default-claim-test-pvc-f2f469c5-df7d-44a8-8ddb-adb9744fb528</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">pvc-test.yaml</span></span><br></pre></td></tr></table></figure>

<h1 id="Statefulset控制器"><a href="#Statefulset控制器" class="headerlink" title="Statefulset控制器"></a>Statefulset控制器</h1><p>StatefulSet是Kubernetes中的一种控制器（Controller），用于管理有状态应用程序的部署和管理。与Deployment控制器不同，StatefulSet被设计用于管理需要稳定网络标识和有序部署的有状态应用程序。</p>
<p>有状态服务在内部保存和管理状态或数据，具有稳定的标识和顺序依赖，不能随意修改名称或者状态的。而无状态服务不保留持久状态，可以简单地水平扩展并且无关顺序。选择使用有状态服务还是无状态服务取决于应用程序的需求、复杂性和可伸缩性要求。</p>
<h2 id="yaml编写"><a href="#yaml编写" class="headerlink" title="yaml编写"></a>yaml编写</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">sts</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: StatefulSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 2</span></span><br><span class="line"><span class="string">  serviceName: svc-sta #关联创建的service</span></span><br><span class="line"><span class="string">  selector:     #关联pod</span></span><br><span class="line"><span class="string">    matchLabels: </span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">  volumeClaimTemplates:        #使用卷申请模板，自动从存储卷取得存储pv和pvc进行绑定</span></span><br><span class="line"><span class="string">    - metadata:</span></span><br><span class="line"><span class="string">         name: nginx-html</span></span><br><span class="line"><span class="string">      spec:</span></span><br><span class="line"><span class="string">        accessModes: [&quot;</span><span class="string">ReadWriteMany&quot;]</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">nfs</span> </span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">             <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">           <span class="attr">image:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">           <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">           <span class="attr">ports:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">           <span class="attr">volumeMounts:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-html</span></span><br><span class="line">               <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-sta</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">clusterIP:</span> <span class="string">None</span>     <span class="comment">#设置service没有ip</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">   <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">&quot; &gt; statefulset.yaml</span></span><br><span class="line"><span class="string">kubectl apply -f statefulset.yaml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#使用我之前创建的存储类nfs</span></span><br><span class="line"><span class="string">kubectl get pods</span></span><br><span class="line"><span class="string">NAME                               READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="string">nfs-provisioner-5468dbd878-nf8n5   1/1     Running   0          48s</span></span><br><span class="line"><span class="string">test-0                             1/1     Running   0          11s</span></span><br><span class="line"><span class="string">test-1                             1/1     Running   0          8s</span></span><br><span class="line"><span class="string">kubectl get pvc</span></span><br><span class="line"><span class="string">NAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span></span><br><span class="line"><span class="string">nginx-test-0   Bound    pvc-bfd92daa-01a1-43e2-83df-03521105cd11   1Gi        RWX            nfs            4m3s</span></span><br><span class="line"><span class="string">nginx-test-1   Bound    pvc-36143720-774f-47f7-8db1-b160d0909154   1Gi        RWX            nfs            4m</span></span><br><span class="line"><span class="string">#在master2中查看存储（存储类自动创建的，分别为每个pod创建了一个pvc</span></span><br><span class="line"><span class="string">ls /dirfornfs/nfs/</span></span><br><span class="line"><span class="string">default-nginx-test-0-pvc-bfd92daa-01a1-43e2-83df-03521105cd11</span></span><br><span class="line"><span class="string">default-nginx-test-1-pvc-36143720-774f-47f7-8db1-b160d0909154</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#虽然service没有IP，但是看describe能看到endpoint关联了pod的ip:port</span></span><br><span class="line"><span class="string">#并且有相关联的dns解析的域名</span></span><br><span class="line"><span class="string">格式：pod名.service名.service的ns.svc.cluster.local</span></span><br><span class="line"><span class="string">test-0.svc-sta.default.svc.cluster.local</span></span><br><span class="line"><span class="string">test-1.svc-sta.default.svc.cluster.local</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#尝试删除pod</span></span><br><span class="line"><span class="string">kubectl delete pod test-0</span></span><br><span class="line"><span class="string">kubectl get pods #可以看到test-0新创建出来了，并且名字相同</span></span><br><span class="line"><span class="string">NAME                               READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="string">busybox                            1/1     Running   0          8m44s</span></span><br><span class="line"><span class="string">nfs-provisioner-5468dbd878-nf8n5   1/1     Running   0          53m</span></span><br><span class="line"><span class="string">read-pod                           1/1     Running   0          44m</span></span><br><span class="line"><span class="string">test-0                             1/1     Running   0          5s</span></span><br><span class="line"><span class="string">test-1                             1/1     Running   0          52m</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#从另外的pod中curl这个域名，可以看到能看到网页内容</span></span><br><span class="line"><span class="string">#并且就算删除了pod，虽然pod的ip变化了，但是如果指定了域名，那么还是能够访问到</span></span><br><span class="line"><span class="string">curl test-0.svc-sta.default.svc.cluster.local</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class="line"><span class="string">&lt;hr&gt;&lt;center&gt;nginx/1.25.3&lt;/center&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="statefulSet扩容缩容与更换镜像"><a href="#statefulSet扩容缩容与更换镜像" class="headerlink" title="statefulSet扩容缩容与更换镜像"></a>statefulSet扩容缩容与更换镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改yaml文件副本数</span></span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  replicas: 4</span><br><span class="line">  serviceName: svc-sta <span class="comment">#关联创建的service</span></span><br><span class="line">...</span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line">kubectl get pods</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-provisioner-5468dbd878-nf8n5   1/1     Running   0          75m</span><br><span class="line">test-0                             1/1     Running   0          22m</span><br><span class="line">test-1                             1/1     Running   0          74m</span><br><span class="line">test-2                             1/1     Running   0          7s</span><br><span class="line">test-3                             1/1     Running   0          5s</span><br><span class="line"><span class="comment">#修改yaml文件副本</span></span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  serviceName: svc-sta <span class="comment">#关联创建的service</span></span><br><span class="line">...</span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line"><span class="comment">#逐个删除，序号大的先删</span></span><br><span class="line">kubectl get pods</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-provisioner-5468dbd878-nf8n5   1/1     Running   0          76m</span><br><span class="line">test-0                             1/1     Running   0          23m</span><br><span class="line"></span><br><span class="line"><span class="comment">#更换镜像</span></span><br><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">kubectl explain  sts.spec.updateStrategy</span><br><span class="line">rollingUpdate        &lt;Object&gt;</span><br><span class="line"><span class="built_in">type</span> &lt;string&gt;</span><br><span class="line">可选<span class="built_in">type</span>类型有：</span><br><span class="line">OnDelete（</span><br><span class="line">RollingUpdate（滚动更新</span><br><span class="line"></span><br><span class="line">kubectl explain  sts.spec.updateStrategy.rollingUpdate</span><br><span class="line">maxUnavailable       &lt;string&gt; （最多不可用pod数或百分比</span><br><span class="line">partition    &lt;<span class="built_in">integer</span>&gt; （最少的可用pod数或百分比</span><br><span class="line"><span class="comment">#修改yaml文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; statefulset.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: StatefulSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 4</span></span><br><span class="line"><span class="string">  serviceName: svc-sta #关联创建的service</span></span><br><span class="line"><span class="string">  selector:     #关联pod</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">  updateStrategy:           #默认type字段为RollingUpdate</span></span><br><span class="line"><span class="string">    rollingUpdate:</span></span><br><span class="line"><span class="string">       maxUnavailable: 0    #最多不可用pod数量为0，即逐个进行更新</span></span><br><span class="line"><span class="string">       partition: 1         #将序号&gt;=1的pod做更新</span></span><br><span class="line"><span class="string">  volumeClaimTemplates: #卷申请模板，自动从存储卷取得存储</span></span><br><span class="line"><span class="string">    - metadata:</span></span><br><span class="line"><span class="string">         name: nginx</span></span><br><span class="line"><span class="string">      spec:</span></span><br><span class="line"><span class="string">        accessModes: [&quot;ReadWriteMany&quot;]</span></span><br><span class="line"><span class="string">        storageClassName: nfs</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">          storage: 1Gi</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">         - name: test-nginx</span></span><br><span class="line"><span class="string">           image: docker.io/library/nginx:1.21</span></span><br><span class="line"><span class="string">           imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">           ports:</span></span><br><span class="line"><span class="string">             - containerPort: 80</span></span><br><span class="line"><span class="string">           volumeMounts:</span></span><br><span class="line"><span class="string">             - name: nginx</span></span><br><span class="line"><span class="string">               mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: svc-sta</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  clusterIP: None #设置service没有ip</span></span><br><span class="line"><span class="string">   ports:</span></span><br><span class="line"><span class="string">    - port: 80</span></span><br><span class="line"><span class="string">   selector:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line"><span class="comment">#现象不是很明显，再将image改回来</span></span><br><span class="line">...</span><br><span class="line">           image: docker.io/library/nginx:latest</span><br><span class="line">...</span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line"><span class="comment">#查看，序号&gt;=1的pod做了更新，test-0并没有更新</span></span><br><span class="line"><span class="comment">#可以看到是序号从大到小逐个进行了更新</span></span><br><span class="line">kubectl get pods -w</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-provisioner-5468dbd878-nf8n5   1/1     Running   0          112m</span><br><span class="line">read-pod                           1/1     Running   0          103m</span><br><span class="line">test-0                             1/1     Running   0          59m</span><br><span class="line">test-1                             1/1     Running   0          80s</span><br><span class="line">test-2                             1/1     Running   0          79s</span><br><span class="line">test-3                             1/1     Running   0          78s</span><br><span class="line">test-3                             1/1     Terminating   0          100s</span><br><span class="line">test-3                             1/1     Terminating   0          100s</span><br><span class="line">test-3                             0/1     Terminating   0          100s</span><br><span class="line">test-3                             0/1     Terminating   0          100s</span><br><span class="line">test-3                             0/1     Terminating   0          100s</span><br><span class="line">test-3                             0/1     Pending       0          0s</span><br><span class="line">test-3                             0/1     Pending       0          0s</span><br><span class="line">test-3                             0/1     ContainerCreating   0          0s</span><br><span class="line">test-3                             0/1     ContainerCreating   0          1s</span><br><span class="line">test-3                             1/1     Running             0          1s</span><br><span class="line">test-2                             1/1     Terminating         0          102s</span><br><span class="line">test-2                             1/1     Terminating         0          103s</span><br><span class="line">test-2                             0/1     Terminating         0          104s</span><br><span class="line">test-2                             0/1     Terminating         0          104s</span><br><span class="line">test-2                             0/1     Terminating         0          104s</span><br><span class="line">test-2                             0/1     Pending             0          0s</span><br><span class="line">test-2                             0/1     Pending             0          0s</span><br><span class="line">test-2                             0/1     ContainerCreating   0          0s</span><br><span class="line">test-2                             0/1     ContainerCreating   0          0s</span><br><span class="line">test-2                             1/1     Running             0          1s</span><br><span class="line">test-1                             1/1     Terminating         0          106s</span><br><span class="line">test-1                             1/1     Terminating         0          106s</span><br><span class="line">test-1                             0/1     Terminating         0          106s</span><br><span class="line">test-1                             0/1     Terminating         0          106s</span><br><span class="line">test-1                             0/1     Terminating         0          106s</span><br><span class="line">test-1                             0/1     Pending             0          0s</span><br><span class="line">test-1                             0/1     Pending             0          0s</span><br><span class="line">test-1                             0/1     ContainerCreating   0          0s</span><br><span class="line">test-1                             0/1     ContainerCreating   0          1s</span><br><span class="line">test-1                             1/1     Running             0          1s</span><br><span class="line">test-2                             1/1     Running             0          4s</span><br><span class="line">test-1                             1/1     Running             0          15s</span><br><span class="line">test-3                             1/1     Running             0          19s</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改updateStrategy升级策略，选择OnDelete</span></span><br><span class="line"><span class="comment">#策略如果是OnDelete，控制器不会自动进行更新</span></span><br><span class="line">...</span><br><span class="line">updateStrategy:</span><br><span class="line">     <span class="built_in">type</span>: OnDelete</span><br><span class="line">...</span><br><span class="line">  image: docker.io/library/nginx:latest</span><br><span class="line">...</span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line"><span class="comment">#无反应，需要手动进行更新</span></span><br><span class="line">kubectl delete -f statefulset.yaml</span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line"></span><br><span class="line">test-0                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-0                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-0                             1/1     Running             0          &lt;invalid&gt;</span><br><span class="line">test-1                             0/1     Pending             0          &lt;invalid&gt;</span><br><span class="line">test-1                             0/1     Pending             0          &lt;invalid&gt;</span><br><span class="line">test-1                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-1                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-1                             1/1     Running             0          &lt;invalid&gt;</span><br><span class="line">test-2                             0/1     Pending             0          &lt;invalid&gt;</span><br><span class="line">test-2                             0/1     Pending             0          &lt;invalid&gt;</span><br><span class="line">test-2                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-2                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-2                             1/1     Running             0          &lt;invalid&gt;</span><br><span class="line">test-3                             0/1     Pending             0          &lt;invalid&gt;</span><br><span class="line">test-3                             0/1     Pending             0          &lt;invalid&gt;</span><br><span class="line">test-3                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-3                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-3                             0/1     ContainerCreating   0          &lt;invalid&gt;</span><br><span class="line">test-1                             1/1     Running             0          &lt;invalid&gt;</span><br><span class="line">test-3                             1/1     Running             0          &lt;invalid&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="DaemonSet控制器"><a href="#DaemonSet控制器" class="headerlink" title="DaemonSet控制器"></a>DaemonSet控制器</h1><p>DaemonSet控制器是一种用于在每个节点上运行Pod副本的控制器。他能确保在集群中的每个节点上都会运行一个Pod副本。当有新节点加入集群时，DaemonSet会自动在新节点上创建一个Pod副本，以确保在整个集群中的每个节点上都存在相应的Pod，并且支持平滑扩展，支持亲和性和污点，支持滚动更新等</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">kubectl explain ds</span><br><span class="line"><span class="comment">#创建挂载测试的文件</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /test/log</span><br><span class="line"><span class="built_in">touch</span> /test/log/ds</span><br><span class="line"><span class="comment">#通过kubectl describe nodes ws-k8s-master1 | grep -i taint查看容忍度</span></span><br><span class="line">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; ds.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: DaemonSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ds-test</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: ds</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  minReadySeconds: 5 #初始化等待时间</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">       name: fluentd  #与template中的labels一样，以此为依据</span></span><br><span class="line"><span class="string">#  updateStrategy:    #更新策略</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      name: ds-pod</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">         name: fluentd</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      tolerations:           #要在master节点上部署pod，则需要定义污点容忍度</span></span><br><span class="line"><span class="string">        - key: node-role.kubernetes.io/control-plane</span></span><br><span class="line"><span class="string">          effect: NoSchedule</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: ds-pod</span></span><br><span class="line"><span class="string">          image: fluentd:latest  #使用其他镜像亦可</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">            requests:        #requests字段可选cpu、memory、hugepages</span></span><br><span class="line"><span class="string">              memory: &#x27;1Gi&#x27;  </span></span><br><span class="line"><span class="string">              cpu: &#x27;200m&#x27;                    </span></span><br><span class="line"><span class="string">            limits:</span></span><br><span class="line"><span class="string">              cpu: &#x27;200m&#x27;</span></span><br><span class="line"><span class="string">              memory: &#x27;1Gi&#x27;</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: ds</span></span><br><span class="line"><span class="string">              mountPath: /test/log</span></span><br><span class="line"><span class="string">       volumes:</span></span><br><span class="line"><span class="string">        - name: ds</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /test/log</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f ds.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods -owide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP              NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">ds-test-hdjqf   1/1     Running   0          37s   10.10.234.111   ws-k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ds-test-qrgj2   1/1     Running   0          37s   10.10.189.215   ws-k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ds-test-z7swf   1/1     Running   0          37s   10.10.250.3     ws-k8s-master2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ds-test-zk6pl   1/1     Running   0          37s   10.10.179.56    ws-k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl get ds</span><br><span class="line">NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">ds-test   4         4         4       4            4           &lt;none&gt;          3m3s</span><br><span class="line"></span><br><span class="line"><span class="comment">#滚动更新策略</span></span><br><span class="line">...</span><br><span class="line">  updateStrategy:    <span class="comment">#更新策略</span></span><br><span class="line">    rollingUpdate:   <span class="comment">#滚动更新</span></span><br><span class="line"><span class="comment">#      maxSurge:  #最大同时更新数量，最大5，,</span></span><br><span class="line">       maxUnavailable:   <span class="comment">#最大不可用数，默认1，一个一个更新</span></span><br><span class="line">... </span><br><span class="line"><span class="comment">#通过命令行进行设置</span></span><br><span class="line">kubectl <span class="built_in">set</span> image &lt;控制器类型&gt; &lt;控制器名称&gt; &lt;container名称&gt;=&lt;镜像名称&gt;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl <span class="built_in">set</span> image daemonsets ds-test ds-pod=ikubernetes/nginx:1.21</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl <span class="built_in">set</span> image daemonsets ds-test ds-pod=xianchao/fluentd:v2.5.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="job与cronjob控制器"><a href="#job与cronjob控制器" class="headerlink" title="job与cronjob控制器"></a>job与cronjob控制器</h1><h2 id="job控制器"><a href="#job控制器" class="headerlink" title="job控制器"></a>job控制器</h2><p>Job控制器用于管理Pod对象运行<strong>一次性任务</strong>，启动一个pod，这个pod专门用来完成某个任务，不需要重启，而是将Pod对象置于”Completed”(完成)状态，若容器中的进程因错误而终止，则需要按照重启策略配置确定是否重启，对于Job这个类型的控制器来说，需不需要重建pod就看任务是否完成，完成就不需要重建，没有完成就需要重建pod</p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161409.png"></p>
<p>Job三种使用场景：<br>1、非并行任务：只启一个pod，pod成功，job正常结束<br>2、并行任务同时指定成功个数：.spec.completions为指定成功个数，可以指定也可以不指定.spec.parallelism（指定&gt;1，会有多个任务并行运行）。当成功个数达到.spec.completions，任务结束。<br>3、有工作队列的并行任务：.spec.completions默认为1，.spec.parallelism为大于0的整数。此时并行启动多个pod，只要有一个成功，任务结束，所有pod结束</p>
<p>Job的主要参数：<br>.spec.completions：完成该Job需要执行成功的Pod数<br>.spec.parallelism：能够同时运行的Pod数<br>.spec.backoffLimit：允许执行失败的Pod数（重启几次）<br>.spec.activeDeadlineSeconds: Job的超时时间   </p>
<h2 id="Cronjob控制器"><a href="#Cronjob控制器" class="headerlink" title="Cronjob控制器"></a>Cronjob控制器</h2><p>CronJob跟Job完成的工作是一样的，只不过CronJob添加了定时任务能力可以指定时间，实现周期性运行。Job，CronJob和Deployment，DaemonSet显著区别在于不需要持续在后台运行</p>
<p>使用场景：<br>1、在给定时间点只运行一次。<br>2、在给定时间点周期性地运行。</p>
<p>CronJob的典型用法如下：<br>1、在给定的时间点调度Job运行。<br>2、创建周期性运行的Job，例如数据库备份、发送邮件</p>
<h2 id="使用job"><a href="#使用job" class="headerlink" title="使用job"></a>使用job</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">job.yaml</span></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">completions：完成该Job需要执行成功的Pod数</span></span><br><span class="line"><span class="string">parallelism：能够同时运行的Pod数</span></span><br><span class="line"><span class="string">backoffLimit：允许执行失败的Pod数（重启几次）</span></span><br><span class="line"><span class="string">activeDeadlineSeconds: Job的超时时间   </span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">activeDeadlineSeconds:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">         <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">         <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;123456&quot;</span> <span class="string">;</span> <span class="string">sleep</span> <span class="number">60</span> <span class="string">;</span> <span class="string">echo</span> <span class="string">&quot;qwertyu&quot;</span></span><br><span class="line">            </span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">job.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161453.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161516.png"></p>
<h2 id="使用Cronjob"><a href="#使用Cronjob" class="headerlink" title="使用Cronjob"></a>使用Cronjob</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">cronjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjob-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/10 * * * *&quot;</span> <span class="comment"># cronjob的周期，10秒钟一次；分时天月周</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">date</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date</span> <span class="comment"># 输出当前时间</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span> <span class="comment"># 失败不重启</span></span><br><span class="line">          </span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cronjob.yaml</span></span><br></pre></td></tr></table></figure>

<p>下图对比pod的状态与输出</p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161534.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240525161548.png"></p>
<h1 id="configmap配置管理中心"><a href="#configmap配置管理中心" class="headerlink" title="configmap配置管理中心"></a>configmap配置管理中心</h1><p>configmap是k8s中的一种资源对象，用以保存非机密性的配置</p>
<p>满足了变更大批量配置的需求，允许动态的管理需求</p>
<p>configmap不能保存大量数据，在configmap中保存的数据不能超过1MiB</p>
<h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><p>从本节开始我更换了环境，做简要说明</p>
<p>虚机环境：<br>VMware Workstation 17Pro<br>CentOS Linux release 7.9.2009 (Core)<br>8G RAM，4vCPU，100G硬盘精简置备</p>
<p>容器环境：<br>k8s 1.26<br>CentOS Linux release 7.6.1810 (Core)</p>
<p>网络环境：<br>NAT网络192.168.8.0&#x2F;24<br>192.168.8.160 ws-k8s-master1<br>192.168.8.159 ws-k8s-master2 （兼nfs服务器）<br>192.168.8.161 ws-k8s-node1<br>192.168.8.162 ws-k8s-node2<br>192.168.8.12 mysql-host<br>192.168.8.10 docker-registry（镜像仓库）</p>
<p>软件说明：<br>solo博客版本solo-v4.4.0，数据库指向mysql-host，并且依赖jdk环境运行<br>jdk版本jdk-12.0.2<br>本地jdk环境目录为&#x2F;opt&#x2F;jdk-12.0.2&#x2F;bin<br>远端jdk环境为nfs服务器&#x2F;NFS&#x2F;jdk-12.0.2&#x2F;bin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dockerfile文件</span></span><br><span class="line">FROM 192.168.8.10:1000/hcie-cloud/centos:7.6.1810</span><br><span class="line">WORKDIR /opt/solo</span><br><span class="line">COPY http.repo /etc/yum.repos.d/</span><br><span class="line">COPY solo-v4.4.0.zip .</span><br><span class="line">RUN yum -y install unzip &amp;&amp; unzip solo-v4.4.0.zip</span><br><span class="line">ADD openjdk-12.0.2_linux-x64_bin.tar.gz /opt</span><br><span class="line">COPY local.properties .</span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/yum.repos.d/C* &amp;&amp; <span class="built_in">rm</span> -rf solo-v4.4.0.zip </span><br><span class="line">ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/opt/jdk-12.0.2/bin</span><br><span class="line">ENTRYPOINT java -<span class="built_in">cp</span> <span class="string">&quot;lib/*:.&quot;</span> org.b3log.solo.Server <span class="comment">#启动命令</span></span><br></pre></td></tr></table></figure>

<h2 id="configmap的创建方法"><a href="#configmap的创建方法" class="headerlink" title="configmap的创建方法"></a>configmap的创建方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap 参数</span><br><span class="line">--from-literal=&lt;key&gt;=&lt;value&gt;  使用键值对的形式直接指定配置参数</span><br><span class="line">--from-file=&lt;文件路径&gt;  从文件中读取，可指定多个</span><br><span class="line">--namespace=&lt;命名空间&gt;</span><br><span class="line">--output=...：指定输出的格式。可以选择的选项包括 json、yaml、name、wide 等</span><br><span class="line">-save-config：将当前的配置保存到配置文件中</span><br><span class="line">--dry-run=client：不真正创建，而是模拟API请求</span><br><span class="line"></span><br><span class="line">1.在命令行中直接指定configmap参数创建</span><br><span class="line">kubectl create configmap solo-blog --from-literal=solo_port=8080</span><br><span class="line"><span class="comment">#configmap/solo-blog created</span></span><br><span class="line"><span class="comment">#查看cm</span></span><br><span class="line">kubectl describe cm solo-blog</span><br><span class="line">Name:         solo-blog</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">solo_port:</span><br><span class="line">----</span><br><span class="line">8080</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">kubectl delete configmap solo-blog</span><br><span class="line"></span><br><span class="line">2.通过文件方式创建</span><br><span class="line"><span class="built_in">mkdir</span> cm</span><br><span class="line"><span class="built_in">cd</span> cm/</span><br><span class="line"><span class="built_in">cat</span> &gt; solo-blog.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">server &#123;</span></span><br><span class="line"><span class="string">	solo_port 8080</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl create configmap solo-blog2 --from-file=/root/cm/solo-blog.yaml</span><br><span class="line"><span class="comment">#configmap/solo-blog2 created</span></span><br><span class="line">kubectl describe cm solo-blog2</span><br><span class="line">Name:         solo-blog2</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">solo-blog.yaml: <span class="comment">#有文件名</span></span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">solo_port 8080</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">kubectl delete configmap solo-blog2</span><br><span class="line"></span><br><span class="line">3.通过指定目录创建configmap</span><br><span class="line"><span class="comment">#修改cm目录</span></span><br><span class="line"><span class="built_in">mv</span> solo-blog.yaml solo-blog.cnf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;MYSQL_HOST=192.168.8.12&quot;</span> &gt; solo-blog.cnf</span><br><span class="line"><span class="built_in">cat</span> &gt; solo-blog2.cnf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">MYSQL_HOST=192.168.8.14</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl create configmap solo-blog3 --from-file=/root/cm/</span><br><span class="line"></span><br><span class="line">kubectl describe cm solo-blog3</span><br><span class="line">Name:         solo-blog3</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">solo-blog.cnf:</span><br><span class="line">----</span><br><span class="line">MYSQL_HOST=192.168.8.12</span><br><span class="line"></span><br><span class="line">solo-blog2.cnf:</span><br><span class="line">----</span><br><span class="line">MYSQL_HOST=192.168.8.14</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">kubectl delete configmap solo-blog3</span><br><span class="line"></span><br><span class="line">4.在yaml文件创建cm</span><br><span class="line"><span class="built_in">cd</span> ~/cm</span><br><span class="line"><span class="built_in">cat</span> &gt; cm.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo-blog</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: blog</span></span><br><span class="line"><span class="string">data:     </span></span><br><span class="line"><span class="string">  MYSQL_HOST: 192.168.8.12       # 添加配置项(变量)</span></span><br><span class="line"><span class="string">  solo-blog.cnf: |               # 添加配置文件，|表示添加多行</span></span><br><span class="line"><span class="string">    [solo-blog]</span></span><br><span class="line"><span class="string">    PATH=/NFS/jkd12.0.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/binEOF</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f cm.yaml</span><br><span class="line"><span class="comment">#configmap/solo-blog created</span></span><br><span class="line">kubectl describe cm solo-blog</span><br><span class="line">Name:         solo-blog</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       app=blog</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">MYSQL_HOST:</span><br><span class="line">----</span><br><span class="line">192.168.8.12</span><br><span class="line">solo-blog.cnf:</span><br><span class="line">----</span><br><span class="line">[solo-blog]</span><br><span class="line">PATH=/NFS/jkd12.0.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/binEOF</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">kubectl delete -f cm.yaml</span><br></pre></td></tr></table></figure>

<h2 id="configmap的使用"><a href="#configmap的使用" class="headerlink" title="configmap的使用"></a>configmap的使用</h2><h3 id="使用configMapKeyRef"><a href="#使用configMapKeyRef" class="headerlink" title="使用configMapKeyRef"></a>使用configMapKeyRef</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看valueFrom字段</span></span><br><span class="line">kubectl explain pod.spec.containers.env.valueFrom</span><br><span class="line">   configMapKeyRef      &lt;Object&gt;</span><br><span class="line">   fieldRef     &lt;Object&gt;</span><br><span class="line">   resourceFieldRef     &lt;Object&gt;</span><br><span class="line">   secretKeyRef &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#先创建一个cm</span></span><br><span class="line"><span class="built_in">cat</span> &gt; cm1.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo-blog</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: blog</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  MYSQL_HOST: 192.168.8.12</span></span><br><span class="line"><span class="string">  PATH: /NFS/jdk-12.0.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f cm.yaml</span><br><span class="line">kubectl get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      55d</span><br><span class="line">solo-blog          2      1s</span><br><span class="line"><span class="comment">#创建一个pod来使用yaml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-cm.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: blog</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: solo-blog</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: solo</span></span><br><span class="line"><span class="string">      image: docker.io/library/solo:1.0</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: nfs</span></span><br><span class="line"><span class="string">          mountPath: /NFS</span></span><br><span class="line"><span class="string">      ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">      env:</span></span><br><span class="line"><span class="string">        - name: PATH</span></span><br><span class="line"><span class="string">          valueFrom:</span></span><br><span class="line"><span class="string">            configMapKeyRef:</span></span><br><span class="line"><span class="string">              name: solo-blog</span></span><br><span class="line"><span class="string">              key: PATH</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: nfs</span></span><br><span class="line"><span class="string">      nfs:</span></span><br><span class="line"><span class="string">        path: /NFS</span></span><br><span class="line"><span class="string">        server: 192.168.8.159</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f pod-cm.yaml</span><br><span class="line"><span class="comment">#pod/blog created</span></span><br><span class="line"><span class="comment">#kubectl get pods -owide</span></span><br><span class="line">NAME   READY   STATUS    RESTARTS       AGE   IP              NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">blog   1/1     Running   11 (29m ago)   47h   10.10.234.125   ws-k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过curl进行测试</span></span><br><span class="line">curl 10.10.234.125:8080</span><br><span class="line"><span class="comment">#能够打开</span></span><br><span class="line"><span class="comment">#进入容器查看环境变量</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it blog -- /bin/bash</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line"><span class="comment">#/NFS/jdk-12.0.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span></span><br><span class="line"><span class="comment">#已成功应用</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用envFrom"><a href="#使用envFrom" class="headerlink" title="使用envFrom"></a>使用envFrom</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">直接将cm的整体注入Container中</span><br><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">kubectl explain pod.spec.containers.envFrom</span><br><span class="line">   configMapRef &lt;Object&gt;</span><br><span class="line">   prefix       &lt;string&gt;</span><br><span class="line">   secretRef    &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-cm2.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: blog2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: solo-blog</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: solo2</span></span><br><span class="line"><span class="string">      image: docker.io/library/solo:1.0</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: nfs</span></span><br><span class="line"><span class="string">          mountPath: /NFS</span></span><br><span class="line"><span class="string">      ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">      envFrom:</span></span><br><span class="line"><span class="string">        - configMapRef:</span></span><br><span class="line"><span class="string">            name: solo-blog</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: nfs</span></span><br><span class="line"><span class="string">      nfs:</span></span><br><span class="line"><span class="string">        path: /NFS</span></span><br><span class="line"><span class="string">        server: 192.168.8.159</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f pod-cm2.yaml </span><br><span class="line"><span class="comment">#pod/blog2 created</span></span><br><span class="line">kubectl get pods -owide</span><br><span class="line">NAME    READY   STATUS    RESTARTS       AGE   IP              NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">blog    1/1     Running   11 (92m ago)   2d    10.10.234.125   ws-k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">blog2   1/1     Running   0              12m   10.10.234.126   ws-k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment">#测试与验证</span></span><br><span class="line">curl 10.10.234.126:8080</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it blog2 -- /bin/bash</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line"><span class="comment">#/NFS/jdk-12.0.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span></span><br></pre></td></tr></table></figure>

<h3 id="将cm制作成volume进行挂载"><a href="#将cm制作成volume进行挂载" class="headerlink" title="将cm制作成volume进行挂载"></a>将cm制作成volume进行挂载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个新的cm文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; cm2.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo-blog2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: blog</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  local.properties: |</span></span><br><span class="line"><span class="string">  runtimeDatabase=MYSQL</span></span><br><span class="line"><span class="string">	  jdbc.username=root</span></span><br><span class="line"><span class="string">	  jdbc.password=Admin@123!</span></span><br><span class="line"><span class="string">	  jdbc.driver=com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="string">	  jdbc.URL=jdbc:mysql://192.168.8.12:3306/solo?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line"><span class="string">	  jdbc.minConnCnt=5</span></span><br><span class="line"><span class="string">	  jdbc.maxConnCnt=10</span></span><br><span class="line"><span class="string">	  jdbc.tablePrefix=b3_solo</span></span><br><span class="line"><span class="string">    #new                  #这是一个标记</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f cm2.yaml </span><br><span class="line">kubectl get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      57d</span><br><span class="line">solo-blog          2      2d1h</span><br><span class="line">solo-blog2         2      14s</span><br><span class="line"></span><br><span class="line"><span class="comment">#再创建一个新pod，在其中将cm2作为volume挂载</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-cm3.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: blog3</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: solo-blog</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: solo3</span></span><br><span class="line"><span class="string">      image: docker.io/library/solo:1.0</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: nfs</span></span><br><span class="line"><span class="string">          mountPath: /NFS</span></span><br><span class="line"><span class="string">        - name: solo</span></span><br><span class="line"><span class="string">          mountPath: /tmp/test  #配置文件放置位置，此目录必须为新目录，不然就会被覆盖</span></span><br><span class="line"><span class="string">      ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">      envFrom:</span></span><br><span class="line"><span class="string">        - configMapRef:         #引入solo-blog的环境变量</span></span><br><span class="line"><span class="string">            name: solo-blog</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: nfs</span></span><br><span class="line"><span class="string">      nfs:</span></span><br><span class="line"><span class="string">        path: /NFS</span></span><br><span class="line"><span class="string">        server: 192.168.8.159</span></span><br><span class="line"><span class="string">    - name: solo</span></span><br><span class="line"><span class="string">      configMap:</span></span><br><span class="line"><span class="string">        name: solo-blog2   #指定cm名</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply  -f pod-cm3.yaml </span><br><span class="line">kubectl <span class="built_in">exec</span> -it blog3 -- /bin/bash</span><br><span class="line"><span class="built_in">ls</span> /tmp/test/</span><br><span class="line"><span class="comment">#local.properties</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/test/local.properties </span><br><span class="line"><span class="comment">#runtimeDatabase=MYSQL</span></span><br><span class="line"><span class="comment">#jdbc.username=root</span></span><br><span class="line"><span class="comment">#jdbc.password=Admin@123!</span></span><br><span class="line"><span class="comment">#jdbc.driver=com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment">#jdbc.URL=jdbc:mysql://192.168.8.12:3306/solo?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line"><span class="comment">#jdbc.minConnCnt=5</span></span><br><span class="line"><span class="comment">#jdbc.maxConnCnt=10</span></span><br><span class="line"><span class="comment">#jdbc.tablePrefix=b3_solo</span></span><br><span class="line"><span class="comment">#new                  #这是一个标记</span></span><br></pre></td></tr></table></figure>

<h2 id="configmap热更新"><a href="#configmap热更新" class="headerlink" title="configmap热更新"></a>configmap热更新</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">可以通过用kubectl edit cm来进行滚动更新，热更新只支持volumes挂载的方式</span><br><span class="line">因为volume是可变的，但cm配置文件不会变，就需要再次应用</span><br><span class="line"><span class="comment">#在pod-cm3.yaml中添加一个启动后钩子</span></span><br><span class="line">...</span><br><span class="line">      lifecycle:                <span class="comment">#添加一个启动后钩子,将配置文件同步到软件目录下</span></span><br><span class="line">        postStart:              <span class="comment">#其实最好还是用job来执行，不过不重要，就是表达一个同步的意思</span></span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">              - /bin/bash</span><br><span class="line">              - -c </span><br><span class="line">              - <span class="built_in">cp</span> /tmp/test/local.properties /opt/solo</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl delete -f pod-cm3.yaml</span><br><span class="line">kubectl apply -f pod-cm3.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新看一下cm1</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: solo-blog</span><br><span class="line">  labels:</span><br><span class="line">    app: blog</span><br><span class="line">data:</span><br><span class="line">  MYSQL_HOST: 192.168.8.12</span><br><span class="line">  PATH: /NFS/jdk-12.0.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#用kubectl edit修改solo-blog2中传送的文件的值，并保存，此时会直接提交</span></span><br><span class="line">kubectl edit cm solo-blog2</span><br><span class="line">...</span><br><span class="line">    jdbc.URL=jdbc:mysql://<span class="variable">$&#123;MYSQL_HOST&#125;</span>:3306/solo?useUnicode=<span class="built_in">yes</span>&amp;characterEncoding=UTF-8&amp;useSSL=<span class="literal">false</span>&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=<span class="literal">true</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#登录查看</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it blog3 -- /bin/bash</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$MYSQL_HOST</span></span><br><span class="line">192.168.8.12</span><br><span class="line"><span class="comment">#过了一会</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/test/local.properties</span><br><span class="line">runtimeDatabase=MYSQL</span><br><span class="line">jdbc.username=root</span><br><span class="line">jdbc.password=Admin@123!</span><br><span class="line">jdbc.driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">jdbc.URL=jdbc:mysql://<span class="variable">$&#123;MYSQL_HOST&#125;</span>:3306/solo?useUnicode=<span class="built_in">yes</span>&amp;characterEncoding=UTF-8&amp;useSSL=<span class="literal">false</span>&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=<span class="literal">true</span></span><br><span class="line">jdbc.minConnCnt=5</span><br><span class="line">jdbc.maxConnCnt=10</span><br><span class="line">jdbc.tablePrefix=b3_solo</span><br><span class="line"><span class="comment">#new                  #这是一个标记</span></span><br></pre></td></tr></table></figure>

<h1 id="secret配置管理中心"><a href="#secret配置管理中心" class="headerlink" title="secret配置管理中心"></a>secret配置管理中心</h1><p>secret一般用来保存密文数据，比如密码等</p>
<p>也可以用环境变量或者以卷的形式进行挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">kubectl explain secret</span><br><span class="line">   kind &lt;string&gt;</span><br><span class="line">   stringData   &lt;map[string]string&gt;</span><br><span class="line">   <span class="built_in">type</span> &lt;string&gt; <span class="comment">#https://kubernetes.io/docs/concepts/configuration/secret/#secret-types</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可选参数</span></span><br><span class="line">generic 通用</span><br><span class="line">tls 私钥和证书</span><br><span class="line">docker-registry docker仓库的认证信息</span><br><span class="line"></span><br><span class="line"><span class="comment">#type类型</span></span><br><span class="line">Service account 用于被sa引用，会制动创建secret，并且会自动挂载至pod</span><br><span class="line">Opaque 默认类型，<span class="built_in">base64</span>格式的密码</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>…如下图<br><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240419184100.png"></p>
<h2 id="secret的使用"><a href="#secret的使用" class="headerlink" title="secret的使用"></a>secret的使用</h2><h3 id="环境变量的引入"><a href="#环境变量的引入" class="headerlink" title="环境变量的引入"></a>环境变量的引入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/sec</span><br><span class="line"><span class="built_in">cd</span> ~/sec/</span><br><span class="line"><span class="comment">#命令行创建</span></span><br><span class="line"><span class="comment">#kubectl create secret generic &lt;secret-name&gt; --from-literal=key1=value1 --from-literal=key2=value2</span></span><br><span class="line">kubectl create secret generic sec1 --from-literal=MYSQL_PASSWORD=Admin@123!</span><br><span class="line">kubectl get secret</span><br><span class="line">NAME   TYPE     DATA   AGE</span><br><span class="line">sec1   Opaque   2      20s</span><br><span class="line"></span><br><span class="line">kubectl describe secret sec1</span><br><span class="line">Name:         sec1</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">MYSQL_PASSWORD:  10 bytes</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#在yaml中添加</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-sec.yaml &lt;&lt;<span class="string">EOF </span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: blog</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: solo-blog</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: solo</span></span><br><span class="line"><span class="string">      image: docker.io/library/solo:1.0</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: nfs</span></span><br><span class="line"><span class="string">          mountPath: /NFS</span></span><br><span class="line"><span class="string">      ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">      env:</span></span><br><span class="line"><span class="string">        - name: MYSQL_PASSWORD        #变量名</span></span><br><span class="line"><span class="string">          valueFrom:</span></span><br><span class="line"><span class="string">            secretKeyRef:</span></span><br><span class="line"><span class="string">              name: sec1              #sec名</span></span><br><span class="line"><span class="string">              key: MYSQL_PASSWORD     #sec中的key，其value会被赋给变量名</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: nfs</span></span><br><span class="line"><span class="string">      nfs:</span></span><br><span class="line"><span class="string">        path: /NFS</span></span><br><span class="line"><span class="string">        server: 192.168.8.159</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f pod-sec.yaml </span><br><span class="line">pod/blog created</span><br><span class="line"></span><br><span class="line">kubectl get pods</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">blog   1/1     Running   0          5s</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入测试</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it blog -- /bin/bash</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;MYSQL_PASSWORD&#125;</span></span><br><span class="line">Admin@123!</span><br></pre></td></tr></table></figure>

<h3 id="作为volume挂载-常用"><a href="#作为volume挂载-常用" class="headerlink" title="作为volume挂载(常用)"></a>作为volume挂载(常用)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用base64加密</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&#x27;Admin@123!&#x27;</span> | <span class="built_in">base64</span></span><br><span class="line">QWRtaW5AMTIzIQ==</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&#x27;root&#x27;</span> | <span class="built_in">base64</span></span><br><span class="line">cm9vdA==</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建新的sec和pod的yaml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-sec2.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Secret</span></span><br><span class="line"><span class="string">type: Opaque</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: sec2</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  user: cm9vdA==</span></span><br><span class="line"><span class="string">  passwd: QWRtaW5AMTIzIQ==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: blog2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: solo-blog2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: solo2</span></span><br><span class="line"><span class="string">      image: docker.io/library/solo:1.0</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: nfs</span></span><br><span class="line"><span class="string">          mountPath: /NFS</span></span><br><span class="line"><span class="string">        - name: sec-volume</span></span><br><span class="line"><span class="string">          mountPath: /etc/secret</span></span><br><span class="line"><span class="string">          readOnly: true</span></span><br><span class="line"><span class="string">      ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: nfs</span></span><br><span class="line"><span class="string">      nfs:</span></span><br><span class="line"><span class="string">        path: /NFS</span></span><br><span class="line"><span class="string">        server: 192.168.8.159</span></span><br><span class="line"><span class="string">    - name: sec-volume</span></span><br><span class="line"><span class="string">      secret:</span></span><br><span class="line"><span class="string">        secretName: sec2              #sec名称</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f pod-sec2.yaml </span><br><span class="line"><span class="comment">#secret/sec2 created</span></span><br><span class="line"><span class="comment">#pod/blog2 created</span></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment">#NAME    READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment">#blog    1/1     Running   0          15m</span></span><br><span class="line"><span class="comment">#blog2   1/1     Running   0          9s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it blog2 -- /bin/bash</span><br><span class="line"><span class="built_in">cat</span> /etc/secret/user </span><br><span class="line">root</span><br><span class="line"><span class="built_in">cat</span> /etc/secret/passwd </span><br><span class="line">Admin@123!</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">kubectl delete -f .</span><br></pre></td></tr></table></figure>

<p>注： 用generic方式加密时在pod中会自动解密，安全性不高</p>
<h1 id="RBAC基础概念"><a href="#RBAC基础概念" class="headerlink" title="RBAC基础概念"></a>RBAC基础概念</h1><p>RBAC是基于角色的访问控制的简称Role-Based Access Control</p>
<p>认证方式：<br>1.双向TLS认证——kubectl和apiserver都要经过CA来签发证书<br>2.bearertoken——给token，直接进行相互访问<br>3.ServiceAccount资源——用于集群内部的访问，包括ns，token和ca，通过目录挂载方式给pod</p>
<p>1和2都是kubectl与apiserver的交互，kubectl是外部的管理命令行，都属于内外部的交互<br>3是apiserver与pod之间的交互，所以是集群内部的访问</p>
<p>kubeconfig文件（config资源）:<br>用kubectl操作k8s中，如果没有指定用户，则会读取kubeconfig文件，其中定义了集群地址，安全上下文，默认用户(认证情况)等信息</p>
<p>可以通过kubectl get pods —kubeconfig&#x3D;…来指定配置文件，跟ansible一样</p>
<h2 id="账号分类"><a href="#账号分类" class="headerlink" title="账号分类"></a>账号分类</h2><p>kubernetes中账户分为：UserAccounts（用户账户） 和 ServiceAccounts（服务账户）   </p>
<p>UserAccounts ，用来给外部用户使用，默认账户是kubernetes-admin，也就是在kubeconfig中默认制定的用户，需要用证书进行签发</p>
<p>ServiceAccounts，给集群内部使用的，进程需要访问apiserver时，需要一个serviceaccount账号。SA账号以ns为区分，每个ns创建时都会有一个default service account，创建pod时如果没有指定service account就会自动使用ns的default sa</p>
<h2 id="RBAC资源与认证策略"><a href="#RBAC资源与认证策略" class="headerlink" title="RBAC资源与认证策略"></a>RBAC资源与认证策略</h2><p>有四个资源对象Role、RoleBinding、ClusterRole和ClusterRoleBinding</p>
<p>授权方式：<br>1.user通过roleBinding绑定到role<br>给role赋予权限后，通过rolebinding给user，<br>user的权限在受ns的限制，rolebinding在哪个ns，只对这个ns有该role的权限</p>
<p>2.user通过roleBinding绑定到clusterRole<br>对clusterrole进行授权<br>使user在ns A下具有clusterrole对ns A的权限，在nsB下有clusterrole对ns B的权限<br>如果用rolebinding，则需要创建两个role</p>
<p>3.user通过clusterroleBinding绑定到clusterRole<br>对clusterrole进行授权<br>user拥有clusterrole对ns的权限</p>
<h2 id="role"><a href="#role" class="headerlink" title="role"></a>role</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span>            <span class="comment">#ns名</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-read</span>           <span class="comment">#role名</span></span><br><span class="line"><span class="attr">rules:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]          <span class="comment">#允许的api接口组</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]      <span class="comment">#允许的资源对象</span></span><br><span class="line">  <span class="attr">resourceNames:</span> []</span><br><span class="line"><span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;list&quot;</span>] <span class="comment">#允许的操作方法，只允许get，watch，list</span></span><br></pre></td></tr></table></figure>

<h2 id="clusterrole"><a href="#clusterrole" class="headerlink" title="clusterrole"></a>clusterrole</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">clusterrole-secrets</span>  <span class="comment">#clusterrole名</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line"> <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]      <span class="comment">#能够进行操作的资源</span></span><br><span class="line"><span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;list&quot;</span>] <span class="comment">#允许的操作方法</span></span><br></pre></td></tr></table></figure>

<h2 id="rilebinding"><a href="#rilebinding" class="headerlink" title="rilebinding"></a>rilebinding</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将user与role绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bind</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">subjects:</span>            <span class="comment">#指定用户</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span>         <span class="comment">#外部用户useraccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yonghu</span>       <span class="comment">#用户名</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span>             <span class="comment">#指定role</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Role</span>         <span class="comment">#</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-read</span>     <span class="comment">#上面定义的role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#与clusterRole绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bind-clsterrole</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yonghu</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span>   <span class="comment">#类型为clusterrole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span> <span class="comment">#指定clusterrole名字</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="准入插件"><a href="#准入插件" class="headerlink" title="准入插件"></a>准入插件</h2><p>k8s的准入控制器有LimitRanger（默认）、ResourceQuota、ServiceAccount、PodSecurityPolicy(k8s1.25废弃了)等</p>
<p>查看当前k8s中的准入插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/kubernetes/manifests/kube-apiserver.yaml | grep enable-admission</span><br><span class="line"><span class="comment">#    - --enable-admission-plugins=NodeRestriction</span></span><br><span class="line"><span class="comment">#https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/</span></span><br></pre></td></tr></table></figure>

<h2 id="使用SA"><a href="#使用SA" class="headerlink" title="使用SA"></a>使用SA</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> RBAC</span><br><span class="line"><span class="built_in">cd</span> RBAC/</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个sa，并使其绑定到pod</span></span><br><span class="line"><span class="comment">#命令行创建</span></span><br><span class="line">kubectl create sa sa-test</span><br><span class="line"><span class="comment">#serviceaccount/sa-test created</span></span><br><span class="line">kubectl get sa</span><br><span class="line"><span class="comment">#NAME      SECRETS   AGE</span></span><br><span class="line"><span class="comment">#default   0         59d</span></span><br><span class="line"><span class="comment">#sa-test   0         81s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查找用法</span></span><br><span class="line">kubectl explain pod.spec</span><br><span class="line">  serviceAccount       &lt;string&gt;</span><br><span class="line">     DeprecatedServiceAccount is a depreciated <span class="built_in">alias</span> <span class="keyword">for</span> ServiceAccountName.</span><br><span class="line">     Deprecated: Use serviceAccountName instead.</span><br><span class="line"></span><br><span class="line">   serviceAccountName   &lt;string&gt;</span><br><span class="line">     ServiceAccountName is the name of the ServiceAccount to use to run this</span><br><span class="line">     pod. More info:</span><br><span class="line">     https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建pod绑定test</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-test.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: sa</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  serviceAccountName: sa-test</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">   - name: test-sa</span></span><br><span class="line"><span class="string">     ports:</span></span><br><span class="line"><span class="string">     - containerPort: 8080</span></span><br><span class="line"><span class="string">     image: docker.io/library/solo:1.0</span></span><br><span class="line"><span class="string">     imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f pod-test.yaml </span><br><span class="line"><span class="comment">#pod/test created</span></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment">#NAME   READY   STATUS    RESTARTS       AGE</span></span><br><span class="line"><span class="comment">#test   1/1     Running   4 (113s ago)   2m52s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="built_in">test</span> -- /bin/bash</span><br><span class="line"><span class="built_in">cd</span> /var/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment">#ca.crt  namespace  token</span></span><br><span class="line"><span class="comment">#基于ca.crt请求访问 apiserver下kube-system的ns的资源</span></span><br><span class="line">curl --cacert ./ca.crt  -H <span class="string">&quot;Authorization: Bearer <span class="subst">$(cat ./token)</span>&quot;</span> \</span><br><span class="line">https://kubernetes/api/v1/namespaces/kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#报错内容</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Status&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;Failure&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;namespaces \&quot;kube-system\&quot; is forbidden: User \&quot;system:serviceaccount:default:sa-test\&quot; cannot get resource \&quot;namespaces\&quot; in API group \&quot;\&quot; in the namespace \&quot;kube-system\&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Forbidden&quot;</span>,</span><br><span class="line">  <span class="string">&quot;details&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;kube-system&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;namespaces&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: 403</span><br><span class="line">由于sa-test的sa权限不足，请求时会报错403</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二终端使用clusterrolebinding进行授权，sa-test绑定到cluster-admin</span></span><br><span class="line">kubectl create clusterrolebinding sa-test-admin --clusterrole=cluster-admin  \</span><br><span class="line">--serviceaccount=default:sa-test</span><br><span class="line"><span class="comment">#clusterrolebinding.rbac.authorization.k8s.io/sa-test-admin created</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次请求</span></span><br><span class="line">curl --cacert ./ca.crt  -H <span class="string">&quot;Authorization: Bearer <span class="subst">$(cat ./token)</span>&quot;</span> \</span><br><span class="line">https://kubernetes/api/v1/namespaces/kube-system</span><br><span class="line"><span class="comment">#正常返回了kube-system的信息</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Namespace&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;kube-system&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: <span class="string">&quot;4f07055e-7da0-461c-9c95-a4d8c21124bc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;resourceVersion&quot;</span>: <span class="string">&quot;12&quot;</span>,</span><br><span class="line">    <span class="string">&quot;creationTimestamp&quot;</span>: <span class="string">&quot;2024-01-05T23:40:24Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;labels&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;kubernetes.io/metadata.name&quot;</span>: <span class="string">&quot;kube-system&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;managedFields&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;manager&quot;</span>: <span class="string">&quot;kube-apiserver&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operation&quot;</span>: <span class="string">&quot;Update&quot;</span>,</span><br><span class="line">        <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time&quot;</span>: <span class="string">&quot;2024-01-05T23:40:24Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fieldsType&quot;</span>: <span class="string">&quot;FieldsV1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fieldsV1&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;f:metadata&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;f:labels&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;.&quot;</span>: &#123;&#125;,</span><br><span class="line">              <span class="string">&quot;f:kubernetes.io/metadata.name&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;spec&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;finalizers&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;phase&quot;</span>: <span class="string">&quot;Active&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="资源的引用"><a href="#资源的引用" class="headerlink" title="资源的引用"></a>资源的引用</h2><p>大多数资源都可以使用endpoint中的URL相对路径来引用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个ns</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#在ns内创建用户</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">sa</span> <span class="string">test</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#serviceaccount/test created</span></span><br><span class="line"><span class="comment">#创建role的yaml和ac账号，并将ac绑定到pod</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pod-log.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="comment">#role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">role-for-log</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>,<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#rolebinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bind</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">role-for-log</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/solo:1.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod-log.yaml</span> </span><br><span class="line"><span class="comment">#role.rbac.authorization.k8s.io/role-for-log created</span></span><br><span class="line"><span class="comment">#rolebinding.rbac.authorization.k8s.io/bind created</span></span><br><span class="line"><span class="comment">#pod/pod created</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">ws</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/</span></span><br><span class="line"><span class="comment">#请求默认ns中的pod的log</span></span><br><span class="line"><span class="string">curl</span> <span class="string">--cacert</span> <span class="string">./ca.crt</span>  <span class="string">-H</span> <span class="string">&quot;Authorization: Bearer $(cat ./token)&quot;</span> <span class="string">\</span></span><br><span class="line"><span class="string">https://kubernetes.default/api/v1/namespaces/default/pods/test/log</span></span><br><span class="line"><span class="comment">#返回报错</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;Status&quot;</span><span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;v1&quot;</span><span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;:</span> &#123;&#125;<span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;:</span> <span class="string">&quot;Failure&quot;</span><span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;:</span> <span class="string">&quot;pods \&quot;test\&quot; is forbidden: User \&quot;system:serviceaccount:ws:test\&quot; cannot get resource \&quot;pods/log\&quot; in API group \&quot;\&quot; in the namespace \&quot;default\&quot;&quot;</span><span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;reason&quot;:</span> <span class="string">&quot;Forbidden&quot;</span><span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;details&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;pods&quot;</span></span><br><span class="line">  &#125;<span class="string">,</span></span><br><span class="line">  <span class="attr">&quot;code&quot;:</span> <span class="number">403</span></span><br><span class="line"><span class="string">无法请求，因为该sa只在自己ns中生效，无权查看default的ns下的pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#请求ns ws下的pod的log</span></span><br><span class="line"><span class="string">curl</span> <span class="string">--cacert</span> <span class="string">./ca.crt</span>  <span class="string">-H</span> <span class="string">&quot;Authorization: Bearer $(cat ./token)&quot;</span> <span class="string">\</span></span><br><span class="line"><span class="string">https://kubernetes.default/api/v1/namespaces/ws/pods/pod-test/log</span></span><br><span class="line"><span class="comment">#可以请求到</span></span><br><span class="line">[<span class="string">INFO</span> ]<span class="string">-[2024-03-06</span> <span class="number">10</span><span class="string">:56:35]-[org.b3log.solo.Server:259]:</span> <span class="string">Solo</span> <span class="string">is</span> <span class="string">booting</span> [<span class="string">ver=4.4.0</span>, <span class="string">os=Linux</span>, <span class="string">isDocker=true</span>, <span class="string">inJar=false</span>, <span class="string">luteAvailable=false</span>, <span class="string">pid=1</span>, <span class="string">runtimeDatabase=MYSQL</span>, <span class="string">runtimeMode=PRODUCTION</span>, <span class="string">jdbc.username=root</span>, <span class="string">jdbc.URL=jdbc:mysql://192.168.8.12:3306/solo?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true</span>]</span><br><span class="line">[<span class="string">WARN</span> ]<span class="string">-[2024-03-06</span> <span class="number">10</span><span class="string">:56:35]-[org.b3log.solo.service.InitService:150]:</span> <span class="string">Solo</span> <span class="string">has</span> <span class="string">not</span> <span class="string">been</span> <span class="string">initialized,</span> <span class="string">please</span> <span class="string">open</span> <span class="string">your</span> <span class="string">browser</span> <span class="string">to</span> <span class="string">init</span> <span class="string">Solo</span></span><br><span class="line"></span><br><span class="line"><span class="string">同理，也可以对其他类型的资源，进行其他类型的操作</span></span><br></pre></td></tr></table></figure>

<h1 id="RBAC常用授权操作"><a href="#RBAC常用授权操作" class="headerlink" title="RBAC常用授权操作"></a>RBAC常用授权操作</h1><h2 id="常用role与clusterRole定义"><a href="#常用role与clusterRole定义" class="headerlink" title="常用role与clusterRole定义"></a>常用role与clusterRole定义</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role/ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;name&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;ns&gt;</span></span><br><span class="line"><span class="attr">rules:</span>                <span class="comment">#允许读取核心API组的pod</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="attr">rules:</span>                <span class="comment">#允许读写apps API组中的dp资源</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="attr">rules:</span>                <span class="comment">#允许读取pod，读写jobs类型的资源</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;jobs&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="attr">rules:</span>                <span class="comment">#允许读取某个cm类型的资源</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;&lt;cm&gt;&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="attr">rules:</span>                <span class="comment">#必须存在于clusterrole中，允许读取node资源</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="attr">rules:</span>                <span class="comment">#必须存在于clusterrole中，允许get和post对非资源端点“/healthz”和子路径</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/healthz&quot;</span>,<span class="string">&quot;/healthz/*&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;post&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="常用rolebinding"><a href="#常用rolebinding" class="headerlink" title="常用rolebinding"></a>常用rolebinding</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bind</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;ns-name&gt;</span></span><br><span class="line"><span class="attr">subjects:</span>       <span class="comment">#对用户名ws进行授权</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ws</span> </span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span>       <span class="comment">#对组名ws进行授权</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ws</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span>       <span class="comment">#对kube-system的default的sa进行授权</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<h2 id="使用命令行进行roleBinding和clusterRoleBinding"><a href="#使用命令行进行roleBinding和clusterRoleBinding" class="headerlink" title="使用命令行进行roleBinding和clusterRoleBinding"></a>使用命令行进行roleBinding和clusterRoleBinding</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令行格式，绑定</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">&lt;要创建的资源名&gt;</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=&lt;集群角色&gt;</span> <span class="string">--serviceaccount=&lt;ns名&gt;:&lt;sa名&gt;</span> <span class="string">\</span></span><br><span class="line"><span class="string">--namespace=&lt;资源的ns名&gt;</span> <span class="string">\</span></span><br><span class="line"><span class="string">----user=&lt;user名&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#命名空间ws内，给wangsheng SA赋予集群角色view（系统自带）</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">sa-view</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=view</span> <span class="string">--serviceaccount=&lt;ns-name&gt;:wangsheng</span> <span class="string">--namespace=ws</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#集群内给所有group为wangsheng的sa赋予集群角色view</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">sas-view</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=view</span> <span class="string">--group=system:serviceaccounts:wangsheng</span> <span class="string">\</span></span><br><span class="line"><span class="string">--namespace=wangsheng</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#集群内给所有group为wangsheng的sa赋予集群角色admin</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">sas-view</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=cluster-admin</span> <span class="string">--group=system:serviceaccounts:wangsheng</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#命名空间ws内，给wangsheng User赋予集群角色admin</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">user-admin</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=admin</span> <span class="string">--user=wangsheng</span> <span class="string">--namespace=ws</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#全集群下，给root User赋予集群角色cluster-admin</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">cluster-binding</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=cluster-admin</span> <span class="string">--user=root</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#全集群下，给root SA赋予集群角色view</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">service-account-binding</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=view</span> <span class="string">--serviceaccount=root</span></span><br></pre></td></tr></table></figure>

<h2 id="User的创建与限制使用"><a href="#User的创建与限制使用" class="headerlink" title="User的创建与限制使用"></a>User的创建与限制使用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ssl认证</span></span><br><span class="line"><span class="comment">#生成私钥</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/etc/kubernetes/pki/</span></span><br><span class="line"><span class="string">umask</span> <span class="number">077</span><span class="string">;</span> <span class="string">openssl</span> <span class="string">genrsa</span> <span class="string">-out</span> <span class="string">wangsheng.key</span> <span class="number">2048</span></span><br><span class="line"><span class="comment">#user需要被证书信任，生成证书请求文件</span></span><br><span class="line"><span class="string">openssl</span> <span class="string">req</span> <span class="string">-new</span> <span class="string">-key</span> <span class="string">wangsheng.key</span> <span class="string">-out</span> <span class="string">wangsheng.csr</span> <span class="string">-subj</span> <span class="string">&quot;/CN=wangsheng&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用wangsheng.csr,ca.crt,ca.key生成一个新证书,有效期十年</span></span><br><span class="line"><span class="string">openssl</span> <span class="string">x509</span> <span class="string">-req</span> <span class="string">-in</span> <span class="string">wangsheng.csr</span> <span class="string">-CA</span> <span class="string">ca.crt</span> <span class="string">-CAkey</span> <span class="string">ca.key</span> <span class="string">\</span></span><br><span class="line"><span class="string">-CAcreateserial</span> <span class="string">-out</span> <span class="string">wangsheng.crt</span> <span class="string">-days</span> <span class="number">3650</span></span><br><span class="line"><span class="comment">#Signature ok</span></span><br><span class="line"><span class="comment">#subject=/CN=wangsheng</span></span><br><span class="line"><span class="comment">#Getting CA Private Key</span></span><br><span class="line"><span class="string">此时wangsheng已经被信任可以访问apiserver</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加一个用户wangsheng</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/root/.kube</span></span><br><span class="line"><span class="string">cp</span> <span class="string">config</span> <span class="string">config.bak</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/etc/kubernetes/pki/</span></span><br><span class="line"><span class="comment">#指定证书wangsheng.crt，指定key</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">set-credentials</span> <span class="string">wangsheng</span> <span class="string">--client-certificate=./wangsheng.crt</span> <span class="string">\</span></span><br><span class="line"><span class="string">--client-key=./wangsheng.key</span> <span class="string">--embed-certs=true</span></span><br><span class="line"><span class="comment">#User &quot;wangsheng&quot; set.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看config文件</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">view</span></span><br><span class="line"><span class="string">可以看到已经有了一个wangsheng用户</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.8.160:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wangsheng</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加安全上下文</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">set-context</span> <span class="string">wangsheng@kubernetes</span> <span class="string">--cluster=kubernetes</span> <span class="string">\</span></span><br><span class="line"><span class="string">--user=wangsheng</span></span><br><span class="line"><span class="comment">#Context &quot;wangsheng@kubernetes&quot; created.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次查看kubeconfig</span></span><br><span class="line"><span class="string">此时context中多了一个</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.8.160:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">wangsheng</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wangsheng@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wangsheng</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切换至wangsheng用户</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> <span class="string">wangsheng@kubernetes</span></span><br><span class="line"><span class="comment">#Switched to context &quot;wangsheng@kubernetes&quot;.</span></span><br><span class="line"><span class="string">此时查看kubeconfig，</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">wangsheng@kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时用户没有权限，需要为期绑定权限</span></span><br><span class="line"><span class="comment">#切换回admin用户</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="comment">#创建用于测试的ns</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#绑定role</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">wangsheng-binding</span> <span class="string">\</span></span><br><span class="line"><span class="string">--clusterrole=cluster-admin</span> <span class="string">--user=wangsheng</span> <span class="string">--namespace=ws</span></span><br><span class="line"><span class="comment">#rolebinding.rbac.authorization.k8s.io/wangsheng-binding created</span></span><br><span class="line"><span class="string">如果操作出错了，将原本的Rolebinding删除重新创建即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切换用户，进行测试</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> <span class="string">wangsheng@kubernetes</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#NAME   READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment">#pod    1/1     Running   0          5h19m</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">sa</span> <span class="number">11111</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#serviceaccount/11111 created</span></span><br><span class="line"><span class="string">此时已经可以访问，并且具有修改权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加普通用户</span></span><br><span class="line"><span class="comment">#创建用户并添加权限</span></span><br><span class="line"><span class="string">useradd</span> <span class="string">xhy</span></span><br><span class="line"><span class="comment">#复制并修改config文件</span></span><br><span class="line"><span class="string">cp</span> <span class="string">/root/.kube/config</span> <span class="string">/</span></span><br><span class="line"><span class="comment">#删除admin相关的context和密钥信息</span></span><br><span class="line"><span class="string">vim</span> <span class="string">/config</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">/home/xhy/.kube/</span> <span class="string">-p</span></span><br><span class="line"><span class="string">cp</span> <span class="string">/config</span> <span class="string">/home/xhy/.kube</span></span><br><span class="line"><span class="string">cp</span> <span class="string">-r</span> <span class="string">/root/.kube/cache</span> <span class="string">/home/xhy/.kube</span></span><br><span class="line"><span class="string">chown</span> <span class="string">-R</span> <span class="string">xhy:xhy</span> <span class="string">/home/xhy</span></span><br><span class="line"><span class="comment">#给xhy设置一个密码</span></span><br><span class="line"><span class="string">passwd</span> <span class="string">xhy</span></span><br><span class="line"><span class="comment">#用xhy登录</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#NAME   READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment">#pod    1/1     Running   0          5h58m</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">sa</span> <span class="number">1111</span>  <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#serviceaccount/1111 created</span></span><br><span class="line"><span class="string">此时可以访问k8s，查看ns-ws内的内容，相当于此时xhy已经拥有了wangsheng的权限</span></span><br><span class="line"></span><br><span class="line"><span class="string">wangsheng当前只有虽然具有clusterrole</span></span><br><span class="line"><span class="string">但是因为使用的是rolebinding，所有wangsheng只具有ns</span> <span class="string">ws内的权限</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果想创建一个用户xuehuiying，具有所有集群下的只读权限，则可以创建clusterrole</span></span><br><span class="line"><span class="string">并使用clusterrolebinding将clusterrole进行绑定；</span></span><br><span class="line"><span class="string">再创建普通用户xuehuiying2，重复上面的步骤：</span></span><br><span class="line"><span class="string">删除/home/xuehuiying2/.kube/config中的admin部分</span></span><br><span class="line"><span class="string">只保留xuehuiying的部分，此时xuehuiying2就拥有与xuehuiying一样的权限</span></span><br></pre></td></tr></table></figure>

<h1 id="ResourceQuota准入控制"><a href="#ResourceQuota准入控制" class="headerlink" title="ResourceQuota准入控制"></a>ResourceQuota准入控制</h1><p>ResourceQuota准入控制是k8s内置的准入控制器，默认就是启用状态。</p>
<p>用来限制ns级别下pod占用的资源</p>
<h2 id="限制cpu-mem-pod-dp数量"><a href="#限制cpu-mem-pod-dp数量" class="headerlink" title="限制cpu mem pod dp数量"></a>限制cpu mem pod dp数量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mkdir</span> <span class="string">quota</span></span><br><span class="line"><span class="string">cd</span> <span class="string">quota/</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">quota.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="comment">#https://kubernetes.io/docs/concepts/policy/resource-quotas/</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line">    <span class="attr">count/deployments.apps:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">quota</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/library/solo:1.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">quota.yaml</span> </span><br><span class="line"><span class="comment">#resourcequota/quota unchanged</span></span><br><span class="line"><span class="comment">#deployment.apps/quota created</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="comment">#NAME                     READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment">#pod                      1/1     Running   0          8h</span></span><br><span class="line"><span class="comment">#quota-7485b7b4d4-5h5w6   1/1     Running   0          4s</span></span><br><span class="line"><span class="comment">#quota-7485b7b4d4-qjlkx   1/1     Running   0          4s</span></span><br><span class="line"><span class="string">只创建了两个副本，这个pod是本来就就有的，加上两个quota就有3个了，ns</span> <span class="string">ws中就不能再创建更多pod</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">quota</span> <span class="string">-n</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">Name:</span>                   <span class="string">quota</span></span><br><span class="line"><span class="attr">Namespace:</span>              <span class="string">ws</span></span><br><span class="line"><span class="string">Resource</span>                <span class="string">Used</span>   <span class="string">Hard</span></span><br><span class="line"><span class="string">--------</span>                <span class="string">----</span>   <span class="string">----</span></span><br><span class="line"><span class="string">count/deployments.apps</span>  <span class="number">1</span>      <span class="number">2</span></span><br><span class="line"><span class="string">limits.cpu</span>              <span class="number">2</span>      <span class="number">4</span></span><br><span class="line"><span class="string">limits.memory</span>           <span class="string">200Mi</span>  <span class="string">4Gi</span>          <span class="comment">#已经用了200Mi（两个quota各占了100Mi）</span></span><br><span class="line"><span class="string">pods</span>                    <span class="number">3</span>      <span class="number">3</span>            <span class="comment">#pod数量已经占满</span></span><br><span class="line"><span class="string">requests.cpu</span>            <span class="string">200m</span>   <span class="number">2</span>            <span class="comment">#已经用了200m的CPU资源（两个quota各占了100m）</span></span><br><span class="line"><span class="string">requests.memory</span>         <span class="string">200Mi</span>  <span class="string">2Gi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="LimitRanger准入控制"><a href="#LimitRanger准入控制" class="headerlink" title="LimitRanger准入控制"></a>LimitRanger准入控制</h1><p>LimitRanger准入控制是之前版本k8s的准入控制器，只限制单个pod资源的使用</p>
<p>如果创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝创建此pod；如果创建资源没有指定其资源限制，默认使用LimitRange规则中的默认资源限制</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limit</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitR</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ws</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span>               <span class="comment">#默认限制，如果pod没指定，则用这个</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">1000m</span>               </span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1000Mi</span></span><br><span class="line">    <span class="attr">defaultRequest:</span>        <span class="comment">#默认请求，如果pod没指定，则用default</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">min:</span>                   <span class="comment">#定义资源的最小限制</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">max:</span>                   <span class="comment">#定义资源的最大限制</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">2000Mi</span></span><br><span class="line">	    <span class="attr">maxLimitRequestRatio:</span>    <span class="comment">#最大比率，4表示不超过最大的四倍，确保不超过需要资源的一定比率</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span>          <span class="comment">#指定要限制的资源类型</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="ingress七层代理"><a href="#ingress七层代理" class="headerlink" title="ingress七层代理"></a>ingress七层代理</h1><p>四层负载与七层代理的区别：</p>
<p>四代负载基于vip+port，如果想要让服务被k8s集群外部访问，需要用nodeport类型，nodeport会在ip上绑定端口，每个服务都绑定一个端口会导致端口过多</p>
<p>七层负载是基于虚拟的URL或ip的负载均衡，除了根据VIP+port，还可以根据URL，语言，浏览器类别来进行负载均衡</p>
<h2 id="ingress资源概述"><a href="#ingress资源概述" class="headerlink" title="ingress资源概述"></a>ingress资源概述</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/">Ingress 控制器 | Kubernetes</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">Ingress | Kubernetes</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211032.png"></p>
<p>Ingress简单的理解就是你原来需要改Nginx配置，然后配置各种域名对应哪个 Service，现在把这个动作抽象出来，变成一个 Ingress 对象，你可以用 yaml 创建，直接改yaml。</p>
<p>ingress资源是用来管理ingress controller的，ingress controller能够实现nginx的负载均衡功能</p>
<h3 id="ingress-controller"><a href="#ingress-controller" class="headerlink" title="ingress controller"></a>ingress controller</h3><p>ingress controller是一个七层负载均衡调度器，将封装的nginx放到pod中运行</p>
<p>用户请求到达ingress controller，ingress controller根据ingress资源的配置，通过路由到四层service，service再转发至pod</p>
<p>ingress controller比虚机nginx的优点：如果是nginx，需要reload才可以生效，如果使用ingress controller，使用ingress维护配置时，会自动进行reload使配置生效</p>
<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211102.png"></p>
<h3 id="使用ingress-controller代理的步骤"><a href="#使用ingress-controller代理的步骤" class="headerlink" title="使用ingress controller代理的步骤"></a>使用ingress controller代理的步骤</h3><p>1.部署ingress controller（只需要做一次）</p>
<p>2.创建pod</p>
<p>3.创建service绑定pod</p>
<p>4.创建ingress http</p>
<p>5.创建ingress https</p>
<h2 id="ingress-controller高可用"><a href="#ingress-controller高可用" class="headerlink" title="ingress controller高可用"></a>ingress controller高可用</h2><p>Deployment+ nodeSeletor+pod反亲和性方式部署在k8s指定的两个work节点，nginx-ingress-controller这个pod共享宿主机ip，然后通过keepalive+nginx实现nginx-ingress-controller高可用</p>
<h3 id="部署ingress-controller"><a href="#部署ingress-controller" class="headerlink" title="部署ingress controller"></a>部署ingress controller</h3><p>部署的yaml下载地址<br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/tree/main/deploy/static/provider/baremetal">https://github.com/kubernetes/ingress-nginx/tree/main/deploy/static/provider/baremetal</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node节点拉取镜像</span></span><br><span class="line"><span class="string">ctr</span> <span class="string">images</span> <span class="string">pull</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.0</span></span><br><span class="line"><span class="string">ctr</span> <span class="string">images</span> <span class="string">pull</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master节点进行配置</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">ingress</span></span><br><span class="line"><span class="string">cd</span> <span class="string">ingress/</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deploy.yaml</span></span><br><span class="line"><span class="string">版本过低可能会报错internal</span> <span class="string">error，如果报错执行</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-A</span> <span class="string">ValidatingWebhookConfiguration</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line"><span class="comment">#namespace/ingress-nginx created</span></span><br><span class="line"><span class="comment">#serviceaccount/ingress-nginx created</span></span><br><span class="line"><span class="comment">#configmap/ingress-nginx-controller created</span></span><br><span class="line"><span class="comment">#clusterrole.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class="line"><span class="comment">#clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class="line"><span class="comment">#role.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class="line"><span class="comment">#rolebinding.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class="line"><span class="comment">#service/ingress-nginx-controller-admission created</span></span><br><span class="line"><span class="comment">#service/ingress-nginx-controller created</span></span><br><span class="line"><span class="comment">#deployment.apps/ingress-nginx-controller created</span></span><br><span class="line"><span class="comment">#ingressclass.networking.k8s.io/nginx created</span></span><br><span class="line"><span class="comment">#validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span></span><br><span class="line"><span class="comment">#serviceaccount/ingress-nginx-admission created</span></span><br><span class="line"><span class="comment">#clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class="line"><span class="comment">#clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class="line"><span class="comment">#role.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class="line"><span class="comment">#rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class="line"><span class="comment">#job.batch/ingress-nginx-admission-create created</span></span><br><span class="line"><span class="comment">#job.batch/ingress-nginx-admission-patch created</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">ns</span></span><br><span class="line"><span class="string">NAME</span>              <span class="string">STATUS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">blue-green</span>        <span class="string">Active</span>   <span class="string">50d</span></span><br><span class="line"><span class="string">default</span>           <span class="string">Active</span>   <span class="string">61d</span></span><br><span class="line"><span class="string">ingress-nginx</span>     <span class="string">Active</span>   <span class="string">18m</span></span><br><span class="line"><span class="string">kube-node-lease</span>   <span class="string">Active</span>   <span class="string">61d</span></span><br><span class="line"><span class="string">kube-public</span>       <span class="string">Active</span>   <span class="string">61d</span></span><br><span class="line"><span class="string">kube-system</span>       <span class="string">Active</span>   <span class="string">61d</span></span><br><span class="line"><span class="string">ws</span>                <span class="string">Active</span>   <span class="string">60d</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-n</span> <span class="string">ingress-nginx</span> <span class="string">-owide</span> <span class="comment">#地址使用的是本机地址（node地址）</span></span><br><span class="line"><span class="string">NAME</span>                                        <span class="string">READY</span>   <span class="string">STATUS</span>      <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>              <span class="string">NODE</span>           <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">ingress-nginx-admission-create-rvbbw</span>        <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">0</span>          <span class="string">20m</span>   <span class="number">10.10</span><span class="number">.234</span><span class="number">.75</span>    <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">ingress-nginx-admission-patch-jgpmd</span>         <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">0</span>          <span class="string">20m</span>   <span class="number">10.10</span><span class="number">.179</span><span class="number">.39</span>    <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">ingress-nginx-controller-678b9b68c4-4p4lh</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">0</span>          <span class="string">20m</span>   <span class="number">192.168</span><span class="number">.8</span><span class="number">.162</span>   <span class="string">ws-k8s-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">ingress-nginx-controller-678b9b68c4-f4mn9</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">0</span>          <span class="string">20m</span>   <span class="number">192.168</span><span class="number">.8</span><span class="number">.161</span>   <span class="string">ws-k8s-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="ingress-controller的负载均衡和反向代理"><a href="#ingress-controller的负载均衡和反向代理" class="headerlink" title="ingress controller的负载均衡和反向代理"></a>ingress controller的负载均衡和反向代理</h3><p>使用keepalive+nginx对ingress controller做负载均衡和反向代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node节点安装keepalive和nginx</span></span><br><span class="line">yum -y install epel-release nginx keepalived nginx-mod-stream</span><br><span class="line"></span><br><span class="line"><span class="comment">#将配置文件传到node1和node2</span></span><br><span class="line">scp nginx.conf ws-k8s-node1:/etc/nginx</span><br><span class="line">scp nginx.conf ws-k8s-node2:/etc/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置node1主节点的keepalive</span></span><br><span class="line">scp keepalived.conf ws-k8s-node1:/etc/keepalived/</span><br><span class="line">scp check_nginx.sh  ws-k8s-node1:/etc/keepalived/</span><br><span class="line"><span class="comment">#配置node2备节点的keepalive</span></span><br><span class="line">scp keepalived.conf2 ws-k8s-node2:/etc/keepalived/</span><br><span class="line">scp check_nginx.sh  ws-k8s-node2:/etc/keepalived/</span><br><span class="line"></span><br><span class="line"><span class="comment">#node1</span></span><br><span class="line">systemctl daemon-reload <span class="comment">#重载</span></span><br><span class="line">systemctl <span class="built_in">enable</span> nginx.service keepalived.service --now</span><br><span class="line"><span class="comment">#node2</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx.service keepalived.service --now</span><br><span class="line"></span><br><span class="line"><span class="comment">#node1停止keepalive测试</span></span><br><span class="line">ip a | grep 192.168.8</span><br><span class="line">    inet 192.168.8.161/24 brd 192.168.8.255 scope global noprefixroute ens33</span><br><span class="line">    inet 192.168.8.199/24 scope global secondary ens33</span><br><span class="line">systemctl stop keepalived.service</span><br><span class="line"><span class="comment">#node2查看，vip进行了转移</span></span><br><span class="line">ip a| grep 192.168.8</span><br><span class="line">    inet 192.168.8.162/24 brd 192.168.8.255 scope global noprefixroute ens33</span><br><span class="line">    inet 192.168.8.199/24 scope global secondary ens33</span><br><span class="line"><span class="comment">#node1起服务，vip重新回到node1</span></span><br><span class="line">systemctl start keepalived.service</span><br><span class="line">ip a| grep 192.168.8</span><br><span class="line">    inet 192.168.8.161/24 brd 192.168.8.255 scope global noprefixroute ens33</span><br><span class="line">    inet 192.168.8.199/24 scope global secondary ens33</span><br></pre></td></tr></table></figure>

<h3 id="相关配置文件"><a href="#相关配置文件" class="headerlink" title="相关配置文件"></a>相关配置文件</h3><p>nginx.conf配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">user nginx;                               <span class="comment"># 指定运行Nginx进程的用户</span></span><br><span class="line">worker_processes auto;                    <span class="comment"># 自动检测并设置Nginx的工作进程数量</span></span><br><span class="line">error_log /var/log/nginx/error.log;       <span class="comment"># 错误日志文件路径</span></span><br><span class="line">pid /run/nginx.pid;                       <span class="comment"># Nginx进程ID文件路径</span></span><br><span class="line">include /usr/share/nginx/modules/*.conf;  <span class="comment"># 包含额外的Nginx模块配置文件</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;  <span class="comment"># 每个工作进程允许的最大连接数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    log_format main <span class="string">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class="line">    access_log /var/log/nginx/k8s-access.log main;  <span class="comment"># 流日志文件路径</span></span><br><span class="line"></span><br><span class="line">    upstream k8s-ingress-controller &#123;      <span class="comment">#代理后端名称为k8s-ingress-controller</span></span><br><span class="line">    <span class="comment">#ingress-controller pod默认会占用80端口</span></span><br><span class="line">        server 192.168.8.161:80 weight=5 max_fails=3 fail_timeout=30s;  <span class="comment"># node1  IP:PORT</span></span><br><span class="line">        server 192.168.8.162:80 weight=5 max_fails=3 fail_timeout=30s;  <span class="comment"># node2  IP:PORT</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 30080;         <span class="comment">#监听30080</span></span><br><span class="line">        proxy_pass k8s-ingress-controller;  <span class="comment"># 负载均衡到k8s-ingress-controller后端</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format main <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">    access_log /var/log/nginx/access.log main;  <span class="comment"># HTTP访问日志文件路径</span></span><br><span class="line"></span><br><span class="line">    sendfile on;</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>keepalive.conf配置文件和脚本：<br>主配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc  # 设置通知电子邮件地址</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  # 设置发送通知的电子邮件地址</span><br><span class="line">   smtp_server 127.0.0.1    # 设置用于发送电子邮件通知的SMTP服务器地址</span><br><span class="line">   smtp_connect_timeout 30  # 设置SMTP服务器连接超时时间（以秒为单位）</span><br><span class="line">   router_id NGINX_MASTER   # 设置VRRP路由器的标识符</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot;  # 设置用于检查Nginx工作状态的脚本路径</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER  # 设置当前实例的状态为主服务器</span><br><span class="line">    interface ens33  # 设置实际网卡名称</span><br><span class="line">    virtual_router_id 51  # 设置VRRP路由器ID实例,每个实例唯一</span><br><span class="line">    priority 100  # 设置当前实例的优先级为100（备用服务器通常设置为较低的优先级，如90）</span><br><span class="line">    advert_int 1  # 设置VRRP心跳包通告间隔时间为1秒（默认值为1秒）</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS       # 明文</span><br><span class="line">        auth_pass wangsheng  # 设置VRRP身份验证密码</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.199/24  # 设置虚拟IP地址（VIP）</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx  # 设置要跟踪的脚本（用于根据Nginx状态进行故障转移）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>备配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc  <span class="comment"># 设置通知电子邮件地址</span></span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  <span class="comment"># 设置发送通知的电子邮件地址</span></span><br><span class="line">   smtp_server 127.0.0.1    <span class="comment"># 设置用于发送电子邮件通知的SMTP服务器地址</span></span><br><span class="line">   smtp_connect_timeout 30  <span class="comment"># 设置SMTP服务器连接超时时间（以秒为单位）</span></span><br><span class="line">   router_id NGINX_MASTER   <span class="comment"># 设置VRRP路由器的标识符</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span>  <span class="comment"># 设置用于检查Nginx工作状态的脚本路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP  <span class="comment"># 设置当前实例的状态为备用</span></span><br><span class="line">    interface ens33  <span class="comment"># 设置实际网卡名称</span></span><br><span class="line">    virtual_router_id 51  <span class="comment"># 设置VRRP路由器ID实例,每个实例唯一</span></span><br><span class="line">    priority 90  <span class="comment"># 低于主的优先级</span></span><br><span class="line">    advert_int 1  <span class="comment"># 设置VRRP心跳包通告间隔时间为1秒（默认值为1秒）</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS       <span class="comment"># 明文</span></span><br><span class="line">        auth_pass wangsheng  <span class="comment"># 设置VRRP身份验证密码</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.199/24  <span class="comment"># 设置虚拟IP地址（VIP）</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx  <span class="comment"># 设置要跟踪的脚本（用于根据Nginx状态进行故障转移）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>check_nginx脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#判断Nginx是否存活</span></span><br><span class="line">counter=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class="string">&quot;grep|$$&quot;</span> )</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$counter</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    service nginx start         <span class="comment">#如果不存活则尝试启动Nginx</span></span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    <span class="comment">#等待2秒后再次获取一次Nginx状态</span></span><br><span class="line">    counter=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class="string">&quot;grep|$$&quot;</span> )</span><br><span class="line">    <span class="comment">#再次进行判断，如Nginx还不存活则停止Keepalived，使地址进行切换</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$counter</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        service  keepalived stop</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="基于http测试ingress代理"><a href="#基于http测试ingress代理" class="headerlink" title="基于http测试ingress代理"></a>基于http测试ingress代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先创建一个新的用于测试的dp环境</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/ingress-test</span><br><span class="line"><span class="built_in">cd</span> ~/ingress-test</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo</span></span><br><span class="line"><span class="string">  namespace: test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: solo</span></span><br><span class="line"><span class="string">    portocol: http</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: http</span></span><br><span class="line"><span class="string">    targetPort: 8080</span></span><br><span class="line"><span class="string">    port: 8080</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo-dp</span></span><br><span class="line"><span class="string">  namespace: de</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: solo</span></span><br><span class="line"><span class="string">      portocol: http</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: solo</span></span><br><span class="line"><span class="string">        portocol: http</span></span><br><span class="line"><span class="string">      namespace: test</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: solo-blog</span></span><br><span class="line"><span class="string">        image: 192.168.10.130/wangsheng/solo:1.0</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent  </span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - name: http</span></span><br><span class="line"><span class="string">          containerPort: 8080</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f pod.yaml</span><br><span class="line">kubectl get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">solo-dp-57fc49b5b8-959f2   1/1     Running   0          60s</span><br><span class="line">solo-dp-57fc49b5b8-jnn4t   1/1     Running   0          60s</span><br><span class="line">solo-dp-57fc49b5b8-zcszk   1/1     Running   0          60s</span><br><span class="line"></span><br><span class="line"><span class="comment">#写ingress</span></span><br><span class="line"><span class="built_in">cd</span> s</span><br><span class="line"><span class="comment">#ingress.networking.k8s.io/test-http created</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">NAME        CLASS   HOSTS                ADDRESS                       PORTS   AGE</span><br><span class="line">test-http   nginx   solo.wangsheng.com   192.168.8.161,192.168.8.162   80      4m1s</span><br><span class="line"></span><br><span class="line"><span class="comment">#宿主机内添加解析</span></span><br><span class="line">192.168.8.199 solo.wangsheng.com</span><br><span class="line"></span><br><span class="line">solo.wangsheng.com:30080 → 192.168.8.199:30080 → 192.168.8.161,192.168.8.162:80 →</span><br><span class="line">svc:solo:8080 </span><br><span class="line"></span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">kubectl delete -f .</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211503.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新创建一个svc关联到pod</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ingress-http.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo-http</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: solo</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: http</span></span><br><span class="line"><span class="string">    targetPort: 8080</span></span><br><span class="line"><span class="string">    port: 8080</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: http</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ingressClassName: nginx       #指定类，ingress controller默认类为nginx</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">  - host: solo.wangsheng.com    #设定要请求的域名</span></span><br><span class="line"><span class="string">    http:</span></span><br><span class="line"><span class="string">      paths:</span></span><br><span class="line"><span class="string">      - backend: #必填项，要关联的后端</span></span><br><span class="line"><span class="string">          service: #指定关联的service和对应端口</span></span><br><span class="line"><span class="string">            name: solo</span></span><br><span class="line"><span class="string">            port:</span></span><br><span class="line"><span class="string">              number: 8080 </span></span><br><span class="line"><span class="string">              #name:</span></span><br><span class="line"><span class="string">        path: /</span></span><br><span class="line"><span class="string">        pathType: Prefix </span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="基于https测试ingress代理"><a href="#基于https测试ingress代理" class="headerlink" title="基于https测试ingress代理"></a>基于https测试ingress代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建TLS站点</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">openssl genrsa -out tls.key 4096                   <span class="comment">#生成一个4096位私钥</span></span><br><span class="line"><span class="comment">#基于密钥签发一个根证书，信任域名</span></span><br><span class="line">openssl req -new -x509 -key tls.key -out tls.crt \</span><br><span class="line">-subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=solo.wangsheng.com </span><br><span class="line"><span class="comment">#生成secret，指定crt与key</span></span><br><span class="line">kubectl create secret tls solo-ingress-secret --cert=tls.crt --key=tls.key</span><br><span class="line"><span class="comment">#创建secret资源</span></span><br><span class="line">kubectl get secret</span><br><span class="line"><span class="comment">#NAME                  TYPE                DATA   AGE</span></span><br><span class="line"><span class="comment">#sec1                  Opaque              1      4d</span></span><br><span class="line"><span class="comment">#solo-ingress-secret   kubernetes.io/tls   2      2s</span></span><br><span class="line"></span><br><span class="line">kubectl describe secret solo-ingress-secret</span><br><span class="line"><span class="comment">#Name:         solo-ingress-secret</span></span><br><span class="line"><span class="comment">#Namespace:    default</span></span><br><span class="line"><span class="comment">#Labels:       &lt;none&gt;</span></span><br><span class="line"><span class="comment">#Annotations:  &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Type:  kubernetes.io/tls</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Data</span></span><br><span class="line"><span class="comment">#====</span></span><br><span class="line"><span class="comment">#tls.crt:  1992 bytes</span></span><br><span class="line"><span class="comment">#tls.key:  3247 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建ingress-https</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ingress-https.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-http</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ingressClassName: nginx       #指定类，ingress controller默认类为nginx</span></span><br><span class="line"><span class="string">  tls:</span></span><br><span class="line"><span class="string">  - hosts:</span></span><br><span class="line"><span class="string">    - solo.wangsheng.com        #被签发的域名</span></span><br><span class="line"><span class="string">    secretName: solo-ingress-secret #指定创建的secret</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">  - host: solo.wangsheng.com    #设定要请求的域名</span></span><br><span class="line"><span class="string">    http:</span></span><br><span class="line"><span class="string">      paths:</span></span><br><span class="line"><span class="string">      - backend: #必填项，要关联的后端</span></span><br><span class="line"><span class="string">          service: #指定关联的service和对应端口</span></span><br><span class="line"><span class="string">            name: solo</span></span><br><span class="line"><span class="string">            port:</span></span><br><span class="line"><span class="string">              number: 8080 </span></span><br><span class="line"><span class="string">              #name:</span></span><br><span class="line"><span class="string">        path: /</span></span><br><span class="line"><span class="string">        pathType: Prefix    #必填项</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl apply -f ingress-https.yaml</span><br><span class="line">kubectl get ingress</span><br><span class="line"><span class="comment">#NAME        CLASS   HOSTS                ADDRESS                       PORTS     AGE</span></span><br><span class="line"><span class="comment">#test-http   nginx   solo.wangsheng.com   192.168.8.161,192.168.8.162   80, 443   37s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">修改hosts后再次使用浏览器进行访问</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/durative/picture-warehouse@main/images/20240426211534.png"></p>
<h2 id="ingress-controller灰度发布"><a href="#ingress-controller灰度发布" class="headerlink" title="ingress controller灰度发布"></a>ingress controller灰度发布</h2><p>通过配置Ingress Annotations来实现不同场景下的灰度发布和测试   </p>
<p>选择方式：</p>
<p>nginx.ingress.kubernetes.io&#x2F;canary-by-header：基于Request Header的流量切分，适用于灰度发布以及 A&#x2F;B 测试。当Request Header 设置为 always时，请求将会被一直发送到 Canary 版本；当 Request Header 设置为 never时，请求不会被发送到 Canary 入口。</p>
<p>nginx.ingress.kubernetes.io&#x2F;canary-by-header-value：要匹配的 Request Header 的值，用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务。当 Request Header 设置为此值时，它将被路由到 Canary 入口。</p>
<p>nginx.ingress.kubernetes.io&#x2F;canary-weight：基于服务权重的流量切分，适用于蓝绿部署，权重范围 0 - 100 按百分比将请求路由到 Canary Ingress 中指定的服务。权重为 0 意味着该金丝雀规则不会向 Canary 入口的服务发送任何请求。权重为60意味着60%流量转到canary。权重为 100 意味着所有请求都将被发送到 Canary 入口。</p>
<p>nginx.ingress.kubernetes.io&#x2F;canary-by-cookie：基于 Cookie 的流量切分，适用于灰度发布与 A&#x2F;B 测试。用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务的cookie。当 cookie 值设置为 always时，它将被路由到 Canary 入口；当 cookie 值设置为 never时，请求不会被发送到 Canary 入口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#部署两个测试的版本</span></span><br><span class="line"><span class="built_in">mkdir</span> ingress-update</span><br><span class="line"><span class="built_in">cd</span> ingress-update/</span><br><span class="line"></span><br><span class="line"><span class="comment">#v1.yaml </span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-v1</span><br><span class="line">spec:</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  replicas: 1           <span class="comment">#三副本</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: openresty/openresty:centos</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">          - name: http</span><br><span class="line">            protocol: TCP</span><br><span class="line">            containerPort: 80</span><br><span class="line">          volumeMounts:</span><br><span class="line">          - mountPath: /usr/local/openresty/nginx/conf/nginx.conf</span><br><span class="line">            name: config</span><br><span class="line">            subPath: nginx.conf</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: nginx-v1</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">    version: v1</span><br><span class="line">  name: nginx-v1</span><br><span class="line">data:</span><br><span class="line">  nginx.conf: |</span><br><span class="line">    worker processes 1;</span><br><span class="line">    events &#123;</span><br><span class="line">        accept_mutex on;</span><br><span class="line">        multi_accept on;</span><br><span class="line">        use epoll;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    http &#123;</span><br><span class="line">        ignore_invalid_headers off;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80;</span><br><span class="line">            location / &#123;</span><br><span class="line">                access_by_lua <span class="string">&#x27;</span></span><br><span class="line"><span class="string">                    local header_str = ngx.say(&quot;nginx-v1&quot;)</span></span><br><span class="line"><span class="string">                &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-v1</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">    version: v1</span><br><span class="line"></span><br><span class="line">kubectl apply -f v1.yaml </span><br><span class="line"><span class="comment">#deployment.apps/nginx-v1 created</span></span><br><span class="line"><span class="comment">#configmap/nginx-v1 unchanged</span></span><br><span class="line"><span class="comment">#service/nginx-v1 unchanged</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#v2.yaml </span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-v2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">      version: v2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">        version: v2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: <span class="string">&quot;openresty/openresty:centos&quot;</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">          containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /usr/local/openresty/nginx/conf/nginx.conf</span><br><span class="line">          name: config</span><br><span class="line">          subPath: nginx.conf</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: nginx-v2</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">    version: v2</span><br><span class="line">  name: nginx-v2</span><br><span class="line">data:</span><br><span class="line">  nginx.conf: |-</span><br><span class="line">    worker_processes  1;</span><br><span class="line">    events &#123;</span><br><span class="line">        accept_mutex on;</span><br><span class="line">        multi_accept on;</span><br><span class="line">        use epoll;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    http &#123;</span><br><span class="line">        ignore_invalid_headers off;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80;</span><br><span class="line">            location / &#123;</span><br><span class="line">                access_by_lua <span class="string">&#x27;</span></span><br><span class="line"><span class="string">                    local header_str = ngx.say(&quot;nginx-v2&quot;)</span></span><br><span class="line"><span class="string">                &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-v2</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">    version: v2</span><br><span class="line"></span><br><span class="line">kubectl apply -f v2.yaml </span><br><span class="line"><span class="comment">#deployment.apps/nginx-v2 created</span></span><br><span class="line"><span class="comment">#configmap/nginx-v2 created</span></span><br><span class="line"><span class="comment">#service/nginx-v2 created</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#都有app: nginx的标签，但version不同</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#v1-ingress.yaml</span></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: canary.example.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        pathType:  Prefix</span><br><span class="line">        backend:  <span class="comment">#配置后端服务</span></span><br><span class="line">         service:</span><br><span class="line">           name: nginx-v1</span><br><span class="line">           port:</span><br><span class="line">            number: 80</span><br><span class="line">kubectl apply -f v1-ingress.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="基于header的流量切分"><a href="#基于header的流量切分" class="headerlink" title="基于header的流量切分"></a>基于header的流量切分</h3><p>创建 Canary Ingress，指定 v2 版本的后端服务，且加上一些 annotation，实现仅将带有名为 Region 且值为 cd 或 sz 的请求头的请求转发给当前 Canary Ingress，模拟灰度新版本给成都和深圳地域的用户:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">v2-ingress.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: <span class="string">&quot;true&quot;</span></span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header: <span class="string">&quot;Region&quot;</span></span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header-pattern: <span class="string">&quot;cd|sz&quot;</span></span><br><span class="line">    <span class="comment">#如果请求头为cd或者sz，就会代理到v2的service</span></span><br><span class="line">  name: nginx-canary</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: canary.example.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        pathType:  Prefix</span><br><span class="line">        backend:  <span class="comment">#配置后端服务</span></span><br><span class="line">         service:</span><br><span class="line">           name: nginx-v2</span><br><span class="line">           port:</span><br><span class="line">            number: 80</span><br><span class="line">kubectl apply -f v2-ingress.yaml</span><br><span class="line"></span><br><span class="line">curl -H <span class="string">&quot;Host: canary.example.com&quot;</span> -H <span class="string">&quot;Region: cd&quot;</span> \</span><br><span class="line">http://192.168.8.199     <span class="comment">#VIP</span></span><br><span class="line">返回v2，只有为<span class="built_in">cd</span>或sz时会返回v2，如果是其他的会返回v1</span><br><span class="line"></span><br><span class="line">kubectl delete -f v2-ingress.yaml</span><br></pre></td></tr></table></figure>

<h3 id="基于-Cookie-的流量切分"><a href="#基于-Cookie-的流量切分" class="headerlink" title="基于 Cookie 的流量切分"></a>基于 Cookie 的流量切分</h3><p>与前面 Header 类似，不过使用 Cookie 就无法自定义 value 了，这里以模拟灰度成都地域用户为例，仅将带有名为 user_from_cd 的 cookie 的请求转发给当前 Canary Ingress 。先删除前面基于 Header 的流量切分的 Canary Ingress，然后创建下面新的 Canary Ingress:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">v1-cookie.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: <span class="string">&quot;true&quot;</span></span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-cookie: <span class="string">&quot;user_from_cd&quot;</span></span><br><span class="line">  name: nginx-canary</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: canary.example.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        pathType:  Prefix</span><br><span class="line">        backend:  <span class="comment">#配置后端服务</span></span><br><span class="line">         service:</span><br><span class="line">           name: nginx-v2</span><br><span class="line">           port:</span><br><span class="line">            number: 80</span><br><span class="line"></span><br><span class="line">kubectl apply -f v1-cookie.yaml</span><br><span class="line"></span><br><span class="line">curl -H <span class="string">&quot;Host: canary.example.com&quot;</span> --cookie <span class="string">&quot;user_from_cd=always&quot;</span> \</span><br><span class="line">http://192.168.8.199     <span class="comment">#VIP</span></span><br><span class="line">返回v2，带有cookie: <span class="string">&quot;user_from_cd&quot;</span>返回v1</span><br><span class="line"></span><br><span class="line">kubectl delete -f v1-cookie.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="基于权重"><a href="#基于权重" class="headerlink" title="基于权重"></a>基于权重</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> v1-weight.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: <span class="string">&quot;true&quot;</span>       <span class="comment">#如果走的是金丝雀将10%的流量代理给金丝雀</span></span><br><span class="line">    nginx.ingress.kubernetes.io/canary-weight: <span class="string">&quot;10&quot;</span></span><br><span class="line">  name: nginx-canary</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: canary.example.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        pathType:  Prefix</span><br><span class="line">        backend:  <span class="comment">#配置后端服务</span></span><br><span class="line">         service:</span><br><span class="line">           name: nginx-v2</span><br><span class="line">           port:</span><br><span class="line">            number: 80</span><br><span class="line"> kubectl apply -f v1-weight.yaml</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span> curl -H <span class="string">&quot;Host: canary.example.com&quot;</span> http://192.168.8.199; <span class="keyword">done</span>; </span><br></pre></td></tr></table></figure>

<h1 id="一些新特性"><a href="#一些新特性" class="headerlink" title="一些新特性"></a>一些新特性</h1><h2 id="PodDisruptionBudget"><a href="#PodDisruptionBudget" class="headerlink" title="PodDisruptionBudget"></a>PodDisruptionBudget</h2><p>它可以确保在节点故障时，Pod 具有更高的可用性。PodDisruptionBudget 可以限制允许同时处于故障中的 Pod 数量，从而避免因节点故障而导致太多的 Pod 关闭。</p>
<p>具体来说，PodDisruptionBudget 通过以下方式确保 Pod 的高可用性：<br>1）在进行维护、升级或其他操作时，PodDisruptionBudget 可以确保最小化对正在运行的 Pod 的影响。<br>2）如果发生节点故障或其他故障，PodDisruptionBudget 可以确保只有受影响的 Pod 被关闭，而不是所有的 Pod。<br>3）当 PodDisruptionBudget 设置允许的最大故障数时，它可以确保在某个时间点上，至少有指定数量的 Pod 在运行。</p>
<p>具体实现时，可以通过在 PodDisruptionBudget 中设置 minAvailable 字段来限制允许同时处于故障中的 Pod 数量。例如，如果设置 minAvailable 为 2，则在任何时间点上至少有两个 Pod 在运行，即使某些节点发生故障。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: policy/v1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: <span class="comment">#绑pod的标签</span></span><br><span class="line">      app: nginx</span><br><span class="line">  minAvailable: 2</span><br></pre></td></tr></table></figure>

<h2 id="Pod优先级"><a href="#Pod优先级" class="headerlink" title="Pod优先级"></a>Pod优先级</h2><p>这个特性允许用户在定义 Pod 时设置优先级，并在节点资源紧张时，Kubernetes 会根据优先级自动进行抢占，从而保证高优先级的 Pod 能够优先调度和运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义一个PriorityClass，名为high-priority</span></span><br><span class="line"><span class="comment">#将其值设置为1000000（优先级）</span></span><br><span class="line">apiVersion: scheduling.k8s.io/v1</span><br><span class="line">kind: PriorityClass</span><br><span class="line">metadata:</span><br><span class="line">  name: high-priority</span><br><span class="line">value: 1000000</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: high-priority-pod</span><br><span class="line">spec:</span><br><span class="line">  priorityClassName: high-priority <span class="comment">#指定priorityClass，将其绑定到上面那个priorityclass</span></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    </span><br><span class="line"><span class="comment"># PriorityClass资源可以手动设置</span></span><br><span class="line">globaldefault设置为<span class="literal">true</span>，表示没有设置PriorityClass的pod都为这个优先级</span><br><span class="line">如果没有globaldefault，则没有设置PriorityClass的pod优先级都为0</span><br></pre></td></tr></table></figure>


    </article>
    <!-- license -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="https://akemi.zj.cn">王盛</a>
            <p>原文链接：<a href="https://akemi.zj.cn/2024/02/27/K8s/">https://akemi.zj.cn/2024/02/27/K8s/</a>
            <p>发表日期：<a href="https://akemi.zj.cn/2024/02/27/K8s/">February 27th 2024, 4:39:48 pm</a>
            <p>更新日期：<a href="https://akemi.zj.cn/2024/02/27/K8s/">February 20th 2025, 6:37:27 pm</a>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2024/02/27/Harbor/" title="本地部署harbor私有镜像仓库">
                    <div class="nextTitle">本地部署harbor私有镜像仓库</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2024/02/06/Python/" title="Python学习笔记">
                    <div class="prevTitle">Python学习笔记</div>
                </a>
            
        </li>
    </ul>
    <!-- comment -->
    
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->


            

            

            

            <!-- utteranc评论 -->


            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->


            
            

            

        </div>
    
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
    <!-- Mathjax -->
    
</main>

                <!-- profile -->
                
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
    
        <div class="social">
            
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    


        </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
        <div class="busuanzi-container">
            
             
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
            
        </div>
    	
</footer>

        </div>
        <!-- toc -->
        
            <div class="toc-wrapper toc-wrapper-loding" style=







    top:50vh;

>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">k8s搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s1-20%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">k8s1.20搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.1.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85k8s"><span class="toc-number">1.1.2.</span> <span class="toc-text">主节点安装k8s</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0"><span class="toc-number">1.1.3.</span> <span class="toc-text">工作节点添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">1.1.4.</span> <span class="toc-text">calico网络插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%8F%82%E6%95%B0"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">一些参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Calico%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">Calico组件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s1-26%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">k8s1.26搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85containerd"><span class="toc-number">1.2.2.</span> <span class="toc-text">安装containerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85k8s"><span class="toc-number">1.2.3.</span> <span class="toc-text">安装k8s</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Calico"><span class="toc-number">1.2.4.</span> <span class="toc-text">安装Calico</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ctr%E5%92%8Ccrictl%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.5.</span> <span class="toc-text">ctr和crictl的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.6.</span> <span class="toc-text">扩容k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">添加工作节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s1-28%E9%AB%98%E5%8F%AF%E7%94%A8%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">k8s1.28高可用搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#master1"><span class="toc-number">1.3.1.</span> <span class="toc-text">master1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#master%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5"><span class="toc-number">1.3.2.</span> <span class="toc-text">master节点加入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node%E4%B8%8E%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5"><span class="toc-number">1.3.3.</span> <span class="toc-text">node与节点加入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#calico"><span class="toc-number">1.3.4.</span> <span class="toc-text">calico</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E5%88%86"><span class="toc-number">1.3.5.</span> <span class="toc-text">高可用部分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#keepalive-nginx%E5%81%9Aapiserver%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">keepalive+nginx做apiserver高可用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#etcd%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">etcd数据库高可用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">k8s概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pod%E8%B5%84%E6%BA%90"><span class="toc-number">3.</span> <span class="toc-text">pod资源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">pod概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">3.2.</span> <span class="toc-text">pod的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87kubectl-run%E6%9D%A5%E5%88%9B%E5%BB%BApod"><span class="toc-number">3.2.1.</span> <span class="toc-text">通过kubectl run来创建pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87yaml%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%EF%BC%8Cyaml%E6%96%87%E4%BB%B6%E7%AE%80%E5%8D%95%E5%86%99%E6%B3%95"><span class="toc-number">3.2.2.</span> <span class="toc-text">通过yaml文件创建，yaml文件简单写法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E7%AE%80%E5%8D%95%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">pod简单操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%8E%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">3.4.</span> <span class="toc-text">命名空间与资源配额</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E7%9A%84%E6%A0%87%E7%AD%BE"><span class="toc-number">3.5.</span> <span class="toc-text">pod的标签</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pod%E8%B5%84%E6%BA%90%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text">pod资源亲和性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#node%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5nodeName%E5%92%8CnodeSelector"><span class="toc-number">4.1.</span> <span class="toc-text">node调度策略nodeName和nodeSelector</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9AnodeName"><span class="toc-number">4.1.1.</span> <span class="toc-text">指定nodeName</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9AnodeSelector"><span class="toc-number">4.1.2.</span> <span class="toc-text">指定nodeSelector</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#node%E4%BA%B2%E5%92%8C%E6%80%A7%E3%80%81pod%E4%BA%B2%E5%92%8C%E6%80%A7%E3%80%81pod%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">node亲和性、pod亲和性、pod反亲和性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.2.1.</span> <span class="toc-text">node节点亲和性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.2.2.</span> <span class="toc-text">硬亲和性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.2.3.</span> <span class="toc-text">软亲和性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%8E%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.2.4.</span> <span class="toc-text">pod亲和性与反亲和性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%E4%B8%8E%E5%AE%B9%E5%BF%8D%E5%BA%A6"><span class="toc-number">4.3.</span> <span class="toc-text">污点与容忍度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-pod%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">5.</span> <span class="toc-text">k8s pod重启策略</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E7%8A%B6%E6%80%81%E4%B8%8E%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">5.1.</span> <span class="toc-text">pod状态与重启策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E7%8A%B6%E6%80%81"><span class="toc-number">5.1.1.</span> <span class="toc-text">pod状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">5.1.2.</span> <span class="toc-text">pod重启策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E2%80%94%E2%80%94%E5%AE%B9%E5%99%A8%E9%92%A9%E5%AD%90%E4%B8%8E%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.</span> <span class="toc-text">pod生命周期——容器钩子与容器探测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8"><span class="toc-number">5.2.1.</span> <span class="toc-text">初始化容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E9%92%A9%E5%AD%90"><span class="toc-number">5.2.2.</span> <span class="toc-text">容器钩子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.3.</span> <span class="toc-text">容器探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.4.</span> <span class="toc-text">启动探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E6%B4%BB%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.5.</span> <span class="toc-text">存活探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%B1%E7%BB%AA%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.6.</span> <span class="toc-text">就绪探测</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E6%8E%A7%E5%88%B6%E5%99%A8ReplicaSet%E4%B8%8EDeployment"><span class="toc-number">6.</span> <span class="toc-text">k8s控制器ReplicaSet与Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">6.1.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment"><span class="toc-number">6.2.</span> <span class="toc-text">Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99"><span class="toc-number">6.2.1.</span> <span class="toc-text">yaml文件编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E4%B8%8E%E7%BC%A9%E5%AE%B9"><span class="toc-number">6.2.2.</span> <span class="toc-text">扩容与缩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E4%B8%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AD%96%E7%95%A5"><span class="toc-number">6.2.3.</span> <span class="toc-text">滚动更新与自定义策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Deployment%E8%BF%9B%E8%A1%8C%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2"><span class="toc-number">6.2.4.</span> <span class="toc-text">使用Deployment进行蓝绿部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Deployment%E8%BF%9B%E8%A1%8C%E9%87%91%E4%B8%9D%E9%9B%80%E9%83%A8%E7%BD%B2"><span class="toc-number">6.2.5.</span> <span class="toc-text">使用Deployment进行金丝雀部署</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86service"><span class="toc-number">7.</span> <span class="toc-text">四层代理service</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ClusterIP%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.1.</span> <span class="toc-text">ClusterIP模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodeport%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.2.</span> <span class="toc-text">nodeport模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExternalName%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.3.</span> <span class="toc-text">ExternalName模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87service%E5%92%8Cendpoint%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8mysql%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">7.4.</span> <span class="toc-text">通过service和endpoint引用外部mysql的最佳实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">8.</span> <span class="toc-text">k8s 持久化存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#emptyDir%E4%B8%B4%E6%97%B6%E7%9B%AE%E5%BD%95"><span class="toc-number">8.1.</span> <span class="toc-text">emptyDir临时目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hostpath"><span class="toc-number">8.2.</span> <span class="toc-text">hostpath</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nfs%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">8.3.</span> <span class="toc-text">nfs持久化存储</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8PV%E5%92%8CPVC"><span class="toc-number">9.</span> <span class="toc-text">k8s 持久化存储PV和PVC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PV%E5%92%8CPVC"><span class="toc-number">9.1.</span> <span class="toc-text">PV和PVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%9B%E5%BB%BAPV"><span class="toc-number">9.2.</span> <span class="toc-text">静态创建PV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StorageClass%E5%88%9B%E5%BB%BApv"><span class="toc-number">9.3.</span> <span class="toc-text">StorageClass创建pv</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Statefulset%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">10.</span> <span class="toc-text">Statefulset控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#yaml%E7%BC%96%E5%86%99"><span class="toc-number">10.1.</span> <span class="toc-text">yaml编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#statefulSet%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9%E4%B8%8E%E6%9B%B4%E6%8D%A2%E9%95%9C%E5%83%8F"><span class="toc-number">10.2.</span> <span class="toc-text">statefulSet扩容缩容与更换镜像</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">11.</span> <span class="toc-text">DaemonSet控制器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#job%E4%B8%8Ecronjob%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">12.</span> <span class="toc-text">job与cronjob控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#job%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">12.1.</span> <span class="toc-text">job控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cronjob%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">12.2.</span> <span class="toc-text">Cronjob控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8job"><span class="toc-number">12.3.</span> <span class="toc-text">使用job</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Cronjob"><span class="toc-number">12.4.</span> <span class="toc-text">使用Cronjob</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#configmap%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83"><span class="toc-number">13.</span> <span class="toc-text">configmap配置管理中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="toc-number">13.1.</span> <span class="toc-text">环境介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configmap%E7%9A%84%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-number">13.2.</span> <span class="toc-text">configmap的创建方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configmap%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">13.3.</span> <span class="toc-text">configmap的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8configMapKeyRef"><span class="toc-number">13.3.1.</span> <span class="toc-text">使用configMapKeyRef</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8envFrom"><span class="toc-number">13.3.2.</span> <span class="toc-text">使用envFrom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86cm%E5%88%B6%E4%BD%9C%E6%88%90volume%E8%BF%9B%E8%A1%8C%E6%8C%82%E8%BD%BD"><span class="toc-number">13.3.3.</span> <span class="toc-text">将cm制作成volume进行挂载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configmap%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">13.4.</span> <span class="toc-text">configmap热更新</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#secret%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83"><span class="toc-number">14.</span> <span class="toc-text">secret配置管理中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#secret%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">14.1.</span> <span class="toc-text">secret的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-number">14.1.1.</span> <span class="toc-text">环境变量的引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BAvolume%E6%8C%82%E8%BD%BD-%E5%B8%B8%E7%94%A8"><span class="toc-number">14.1.2.</span> <span class="toc-text">作为volume挂载(常用)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RBAC%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">15.</span> <span class="toc-text">RBAC基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E5%88%86%E7%B1%BB"><span class="toc-number">15.1.</span> <span class="toc-text">账号分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RBAC%E8%B5%84%E6%BA%90%E4%B8%8E%E8%AE%A4%E8%AF%81%E7%AD%96%E7%95%A5"><span class="toc-number">15.2.</span> <span class="toc-text">RBAC资源与认证策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#role"><span class="toc-number">15.3.</span> <span class="toc-text">role</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#clusterrole"><span class="toc-number">15.4.</span> <span class="toc-text">clusterrole</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rilebinding"><span class="toc-number">15.5.</span> <span class="toc-text">rilebinding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8F%92%E4%BB%B6"><span class="toc-number">15.6.</span> <span class="toc-text">准入插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8SA"><span class="toc-number">15.7.</span> <span class="toc-text">使用SA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9A%84%E5%BC%95%E7%94%A8"><span class="toc-number">15.8.</span> <span class="toc-text">资源的引用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RBAC%E5%B8%B8%E7%94%A8%E6%8E%88%E6%9D%83%E6%93%8D%E4%BD%9C"><span class="toc-number">16.</span> <span class="toc-text">RBAC常用授权操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8role%E4%B8%8EclusterRole%E5%AE%9A%E4%B9%89"><span class="toc-number">16.1.</span> <span class="toc-text">常用role与clusterRole定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8rolebinding"><span class="toc-number">16.2.</span> <span class="toc-text">常用rolebinding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%BF%9B%E8%A1%8CroleBinding%E5%92%8CclusterRoleBinding"><span class="toc-number">16.3.</span> <span class="toc-text">使用命令行进行roleBinding和clusterRoleBinding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#User%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E9%99%90%E5%88%B6%E4%BD%BF%E7%94%A8"><span class="toc-number">16.4.</span> <span class="toc-text">User的创建与限制使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ResourceQuota%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">17.</span> <span class="toc-text">ResourceQuota准入控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6cpu-mem-pod-dp%E6%95%B0%E9%87%8F"><span class="toc-number">17.1.</span> <span class="toc-text">限制cpu mem pod dp数量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LimitRanger%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">18.</span> <span class="toc-text">LimitRanger准入控制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ingress%E4%B8%83%E5%B1%82%E4%BB%A3%E7%90%86"><span class="toc-number">19.</span> <span class="toc-text">ingress七层代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress%E8%B5%84%E6%BA%90%E6%A6%82%E8%BF%B0"><span class="toc-number">19.1.</span> <span class="toc-text">ingress资源概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress-controller"><span class="toc-number">19.1.1.</span> <span class="toc-text">ingress controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ingress-controller%E4%BB%A3%E7%90%86%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">19.1.2.</span> <span class="toc-text">使用ingress controller代理的步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress-controller%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">19.2.</span> <span class="toc-text">ingress controller高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2ingress-controller"><span class="toc-number">19.2.1.</span> <span class="toc-text">部署ingress controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress-controller%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">19.2.2.</span> <span class="toc-text">ingress controller的负载均衡和反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">19.2.3.</span> <span class="toc-text">相关配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ehttp%E6%B5%8B%E8%AF%95ingress%E4%BB%A3%E7%90%86"><span class="toc-number">19.3.</span> <span class="toc-text">基于http测试ingress代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ehttps%E6%B5%8B%E8%AF%95ingress%E4%BB%A3%E7%90%86"><span class="toc-number">19.4.</span> <span class="toc-text">基于https测试ingress代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress-controller%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="toc-number">19.5.</span> <span class="toc-text">ingress controller灰度发布</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eheader%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%87%E5%88%86"><span class="toc-number">19.5.1.</span> <span class="toc-text">基于header的流量切分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Cookie-%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%87%E5%88%86"><span class="toc-number">19.5.2.</span> <span class="toc-text">基于 Cookie 的流量切分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%9D%83%E9%87%8D"><span class="toc-number">19.5.3.</span> <span class="toc-text">基于权重</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-number">20.</span> <span class="toc-text">一些新特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PodDisruptionBudget"><span class="toc-number">20.1.</span> <span class="toc-text">PodDisruptionBudget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">20.2.</span> <span class="toc-text">Pod优先级</span></a></li></ol></li></ol>
            </div>
        
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 176
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
        
            
            
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/22</span>
            <a class="archive-post-title" href="/2025/03/22/Cronjob-k8s-check/">使用cronjob自动化巡检k8s告警</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/22</span>
            <a class="archive-post-title" href="/2025/03/22/Systemd-service/">systemd Unit及其配置文件</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/11</span>
            <a class="archive-post-title" href="/2025/03/11/SSL-Encrypt/">通过Let's Encrypt生成免费SSL证书</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/07</span>
            <a class="archive-post-title" href="/2025/03/07/ESXi-Network/">ESXi网络</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/07</span>
            <a class="archive-post-title" href="/2025/03/07/CKS/">CKS认证题目与解法（2025版）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/07</span>
            <a class="archive-post-title" href="/2025/03/07/CKA/">CKA认证题目与解法（2024版）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span>
            <a class="archive-post-title" href="/2025/02/28/Apache-config/">Apache配置文件详解与性能调优</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span>
            <a class="archive-post-title" href="/2025/02/28/Apache-file-server/">使用Apache搭建能够传输大文件的web文件服务器</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span>
            <a class="archive-post-title" href="/2025/02/28/EffcientLinux-RunCommand/">高效使用Linux-执行命令的不同方式</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/26</span>
            <a class="archive-post-title" href="/2025/02/26/EffcientLinux-env/">高效使用Linux-父与子shell环境</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/26</span>
            <a class="archive-post-title" href="/2025/02/26/Git-cherry-pick/">git仓库使用cherry-pick进行单独代码合并</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span>
            <a class="archive-post-title" href="/2025/02/24/Docker-Proxy/">win10使用代理docker拉取外网镜像</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span>
            <a class="archive-post-title" href="/2025/02/24/EffcientLinux-txt/">高效使用Linux-文本处理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/21</span>
            <a class="archive-post-title" href="/2025/02/21/Python-pytest/">Python-pytest框架</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/21</span>
            <a class="archive-post-title" href="/2025/02/21/EffcientLinux-path/">高效使用Linux-文件系统目录</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/20</span>
            <a class="archive-post-title" href="/2025/02/20/OSS-rclone/">使用rclone进行对象存储迁移-R2→OSS</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span>
            <a class="archive-post-title" href="/2025/02/19/RHCA-RHAAP/">RHAAP红帽Ansible自动化平台</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span>
            <a class="archive-post-title" href="/2025/02/19/EffcientLinux-history/">高效使用Linux-历史记录操作</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span>
            <a class="archive-post-title" href="/2025/02/19/Nginx-tune/">基于ECS的网站访问速度与nginx优化</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span>
            <a class="archive-post-title" href="/2025/02/19/EffcientLinux-shell/">高效使用Linux-shell环境与运算</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span>
            <a class="archive-post-title" href="/2025/02/13/SSH-jump/">SSH跳板</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span>
            <a class="archive-post-title" href="/2025/02/13/EffcientLinux-pipe/">高效使用Linux-管道与组合命令</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span>
            <a class="archive-post-title" href="/2025/02/13/Helm-TakeOver/">生产环境数据库pod使用helm接管</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/08</span>
            <a class="archive-post-title" href="/2025/02/08/ifnames/">修改网络接口命名规则</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span>
            <a class="archive-post-title" href="/2025/02/06/K8s-Kind/">使用kind快速部署多节点k8s</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span>
            <a class="archive-post-title" href="/2025/02/06/K8s-Minikube/">使用Minikube快速部署k8s</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span>
            <a class="archive-post-title" href="/2025/02/05/Image-gcr/">docker拉取gcr.io镜像</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span>
            <a class="archive-post-title" href="/2025/02/05/K8s-crt/">k8s证书延长有效期</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/17</span>
            <a class="archive-post-title" href="/2025/01/17/Python-Django/">Python-Django框架入门学习</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/16</span>
            <a class="archive-post-title" href="/2025/01/16/Helm-details/">Helm定义规范与模板全解析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/15</span>
            <a class="archive-post-title" href="/2025/01/15/Gitlab-Jenkins-argo-k8s/">Gitlab+Jenkins+argo+k8s CICD</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/14</span>
            <a class="archive-post-title" href="/2025/01/14/Blog-ECS/">博客从github page迁移到ECS</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/13</span>
            <a class="archive-post-title" href="/2025/01/13/JS/">前端入门--JS</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/13</span>
            <a class="archive-post-title" href="/2025/01/13/Jenkins-Generic-Webhook-Trigger/">jenkins插件Generic Webhook Trigger</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/13</span>
            <a class="archive-post-title" href="/2025/01/13/Jenkins-git/">jenkins流水线与git凭证报错</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/03</span>
            <a class="archive-post-title" href="/2025/01/03/CSS-selector/">前端入门--CSS选择器</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/03</span>
            <a class="archive-post-title" href="/2025/01/03/CSS-style/">前端入门--CSS样式</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2024 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/30</span>
            <a class="archive-post-title" href="/2024/12/30/HTML-tag/">前端入门--HTML基础标签</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/17</span>
            <a class="archive-post-title" href="/2024/12/17/Helm-subChart/">Helm父子chart的关系与实战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/12</span>
            <a class="archive-post-title" href="/2024/12/12/CLI-OSS/">常用的对象存储连接方式</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2024/12/11/Shell-openvpn/">Shell脚本-添加Openvpn账号密码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/10</span>
            <a class="archive-post-title" href="/2024/12/10/Python-Tk-httpd/">Python-tk库—图形化管理httpd服务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/09</span>
            <a class="archive-post-title" href="/2024/12/09/Python-Tk-tomcat/">Python-tk库—图形化管理tomcat服务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/09</span>
            <a class="archive-post-title" href="/2024/12/09/ArgoCD-install/">argoCD介绍，部署与对接代码仓库</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/08</span>
            <a class="archive-post-title" href="/2024/12/08/CRD/">CRD自定义API资源介绍与使用官方案例</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/08</span>
            <a class="archive-post-title" href="/2024/12/08/Image-Repository/">无敌的镜像加速器地址</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/08</span>
            <a class="archive-post-title" href="/2024/12/08/Mongodb-Kubernetes-Operator/">使用Mongodb-Kubernetes-Operator部署mongodb集群</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span>
            <a class="archive-post-title" href="/2024/12/05/OpenVPN/">OpenVPN原理与证书类型</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span>
            <a class="archive-post-title" href="/2024/12/05/Helm-minIO/">Helm部署minIO-单点与分布式</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span>
            <a class="archive-post-title" href="/2024/12/04/Helm-mysql8/">Helm部署mysql8</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span>
            <a class="archive-post-title" href="/2024/12/04/Helm-redis5/">Helm部署redis5与使用local-path-provisioner</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/2024/12/01/K8s-skopeo/">镜像管理工具skopeo部署与实战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/2024/12/01/Python-Tk-nginx/">Python-tk库—图形化管理nginx服务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/2024/12/01/K3s-Install/">k3s两节点测试环境快速部署</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/2024/12/01/K8s-Ubuntu-Install/">ubuntu20.04桌面版快速部署单点k8s</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/19</span>
            <a class="archive-post-title" href="/2024/11/19/Python-check-status/">Python基于多种方式检测linux服务运行状态(进程筛选、systemctl、API)</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/17</span>
            <a class="archive-post-title" href="/2024/11/17/Python-Module-mysql-connector-python/">Python使用mysql-connector-python库实现CRUD</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/16</span>
            <a class="archive-post-title" href="/2024/11/16/Python-Module-kubernetes-2/">Python-kubernetes模块案例—根据不同ns更新pod副本数</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/16</span>
            <a class="archive-post-title" href="/2024/11/16/Python-Module-kubernetes-1/">Python-kubernetes模块—k8s集群资源管理方法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/13</span>
            <a class="archive-post-title" href="/2024/11/13/Python-Module-socket/">Python socket模块案例—简单网络编程</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/13</span>
            <a class="archive-post-title" href="/2024/11/13/Python-boto3/">Python boto3模块—访问S3风格API</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/11</span>
            <a class="archive-post-title" href="/2024/11/11/Python-Flask/">Python Flask框架—快速开发API</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/10</span>
            <a class="archive-post-title" href="/2024/11/10/Python-Module-request/">Python request模块常用方法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/09</span>
            <a class="archive-post-title" href="/2024/11/09/Python-Module-json/">Python json模块案例—提取与交换json数据</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/09</span>
            <a class="archive-post-title" href="/2024/11/09/Python-Module-yaml/">Python yaml模块案例——提取与修改k8s配置文件</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/08</span>
            <a class="archive-post-title" href="/2024/11/08/Python-Module-fabric/">Python fabric模块案例—更方便使用ssh</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/07</span>
            <a class="archive-post-title" href="/2024/11/07/Python-Module-paramiko/">Python paramiko模块案例—创建SSH、SFTP连接</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/07</span>
            <a class="archive-post-title" href="/2024/11/07/Python-Module-logging/">Python logging模块案例—切割日志与告警发送</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/05</span>
            <a class="archive-post-title" href="/2024/11/05/Python-Module-psutil/">Python psutil模块案例—获取系统硬件状态</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/03</span>
            <a class="archive-post-title" href="/2024/11/03/Python-Module-subprocess/">Python subprocess模块案例—执行系统命令与创建子进程</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/2024/11/01/MySQL-Locked-1/">面对锁表，他的选择是……查询锁源</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/2024/11/01/MySQL-Locked-2/">面对锁表，他的选择是……监控锁状态与查看死锁</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/2024/11/01/MySQL-Replication-relay/">面对主从延时，他的选择是……主从性能优化</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/31</span>
            <a class="archive-post-title" href="/2024/10/31/Python-Project-1/">Python案例——备份文件，清理过期日志，批量重命名文件</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/29</span>
            <a class="archive-post-title" href="/2024/10/29/Blog-cloudflare/">博客迁移小记——从github page迁移到cloudflare page</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/16</span>
            <a class="archive-post-title" href="/2024/10/16/Kafka-Install/">Kafka集群搭建</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/15</span>
            <a class="archive-post-title" href="/2024/10/15/Jenkins-Pipeline-k8s/">jenkins构建pipeline项目到k8s</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/13</span>
            <a class="archive-post-title" href="/2024/10/13/K8s-Binary-installation/">K8s二进制安装</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/10</span>
            <a class="archive-post-title" href="/2024/10/10/Jenkins-Pipeline-docker/">Jenkins构建pipeline项目到docker</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span>
            <a class="archive-post-title" href="/2024/10/08/Jenkins-Install/">Jenkins yum部署与k8s容器化部署</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span>
            <a class="archive-post-title" href="/2024/10/08/Jenkins-Master-Slave/">Jenkins主从架构</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span>
            <a class="archive-post-title" href="/2024/10/08/Jenkins-Maven/">Jenkins构建maven项目</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span>
            <a class="archive-post-title" href="/2024/10/08/Jenkins-freestyle/">Jenkins构建自由风格项目——拉取gitlab代码、使用脚本上传代码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/05</span>
            <a class="archive-post-title" href="/2024/10/05/Dockerfile-tomcat/">使用Dockerfile打包与发布一个tomcat博客</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/01</span>
            <a class="archive-post-title" href="/2024/10/01/Git-organize/">Git与Gitlab使用知识整理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/26</span>
            <a class="archive-post-title" href="/2024/09/26/Ansible-Project/">Ansible项目</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span>
            <a class="archive-post-title" href="/2024/09/24/Redis-MS-Optimization/">Redis集群主从关系优化</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span>
            <a class="archive-post-title" href="/2024/09/24/Redis-ASK/">Redis ASK机制、cluster-node-timeout参数</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span>
            <a class="archive-post-title" href="/2024/09/24/Redis-Cluster/">Redis-Cluster集群模式</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span>
            <a class="archive-post-title" href="/2024/09/24/Redis-Scaling/">Redis-Cluster扩容与缩容</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2024/09/22/Redis-Replication/">Redis主从复制</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2024/09/22/Redis-Sentinel/">Redis哨兵模式</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/2024/09/19/Redis-Transactions/">Redis事务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/2024/09/19/Redis-Install/">Redis部署与参数</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/2024/09/19/Redis-Persistence/">Redis持久化</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/2024/09/19/Redis-Type/">Redis数据类型与常用操作</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/18</span>
            <a class="archive-post-title" href="/2024/09/18/Zabbix-Custom-Monitor-2/">zabbix自定义报警——mysql主从复制状态检查</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/17</span>
            <a class="archive-post-title" href="/2024/09/17/Zabbix-Proxy/">Zabbix-Proxy</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/17</span>
            <a class="archive-post-title" href="/2024/09/17/Zabbix-Auto-Registration/">Zabbix自动注册</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/16</span>
            <a class="archive-post-title" href="/2024/09/16/Zabbix-Auto-Discovery/">Zabbix自动发现</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/16</span>
            <a class="archive-post-title" href="/2024/09/16/Zabbix-JMX/">zabbix监控——JMX客户端</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/14</span>
            <a class="archive-post-title" href="/2024/09/14/Zabbix-Weixin/">Zabbix企业微信报警</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span>
            <a class="archive-post-title" href="/2024/09/13/Zabbix-Mail-Alert/">Zabbix邮件报警</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span>
            <a class="archive-post-title" href="/2024/09/12/Zabbix-Custom-Monitor/">Zabbix自定义监控</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span>
            <a class="archive-post-title" href="/2024/09/12/Zabbix-Custom-Template/">Zabbix自定义模板</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span>
            <a class="archive-post-title" href="/2024/09/12/Zabbix-Install/">Zabbix5.0安装与部署</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/10</span>
            <a class="archive-post-title" href="/2024/09/10/MySQL-Mycat-HA/">Mycat与keepalived高可用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/10</span>
            <a class="archive-post-title" href="/2024/09/10/MySQL-Mycat/">Mycat部署与读写分离</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/08</span>
            <a class="archive-post-title" href="/2024/09/08/MySQL-MHA/">MySQL高可用之MHA</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span>
            <a class="archive-post-title" href="/2024/09/05/MySQL-Replication/">MySQL高可用之主从复制(已更新)</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/04</span>
            <a class="archive-post-title" href="/2024/09/04/MySQL-Dual-Master/">MySQL高可用之双主+keepalived</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/03</span>
            <a class="archive-post-title" href="/2024/09/03/MySQL-HA/">MySQL高可用方案介绍</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/03</span>
            <a class="archive-post-title" href="/2024/09/03/MySQL-Metadata/">MySQL元数据与information_schema</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/02</span>
            <a class="archive-post-title" href="/2024/09/02/MySQL-SQL/">SQL语句详解</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/31</span>
            <a class="archive-post-title" href="/2024/08/31/MySQL-Multi-Instances/">MySQL多实例</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/27</span>
            <a class="archive-post-title" href="/2024/08/27/Shell-Project/">Shell实战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/23</span>
            <a class="archive-post-title" href="/2024/08/23/Tomcat-Project/">Tomcat综合案例</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/21</span>
            <a class="archive-post-title" href="/2024/08/21/Tomcat-Base/">Tomcat基础知识</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/18</span>
            <a class="archive-post-title" href="/2024/08/18/Nginx-Project/">Nginx综合案例</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/15</span>
            <a class="archive-post-title" href="/2024/08/15/LNMP/">lnmp搭建笔记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/14</span>
            <a class="archive-post-title" href="/2024/08/14/Nginx-Example/">Nginx案例</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/13</span>
            <a class="archive-post-title" href="/2024/08/13/Linux-logrotate/">logrotate服务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/13</span>
            <a class="archive-post-title" href="/2024/08/13/Mailx/">使用mailx发送到企业邮箱</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/11</span>
            <a class="archive-post-title" href="/2024/08/11/Rsync/">Rsync数据备份工具</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/09</span>
            <a class="archive-post-title" href="/2024/08/09/Linux-Firewall/">Linux系统Firewalld使用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/26</span>
            <a class="archive-post-title" href="/2024/07/26/MySQL-Backup/">Mysql备份</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/26</span>
            <a class="archive-post-title" href="/2024/07/26/MySQL-Federate/">Mysql-Federate远程链接数据库</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/24</span>
            <a class="archive-post-title" href="/2024/07/24/MySQL-Audit/">mysql安全审计之Mcafee Mysql-Audit</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/22</span>
            <a class="archive-post-title" href="/2024/07/22/MySQL-Auth/">Mysql用户权限与密码管理、角色管理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/22</span>
            <a class="archive-post-title" href="/2024/07/22/MySQL-Install/">Mysql-Linux环境部署</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/18</span>
            <a class="archive-post-title" href="/2024/07/18/MySQL-InnoDB/">Mysql-InnoDB存储引擎、InnoDB事务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/15</span>
            <a class="archive-post-title" href="/2024/07/15/Shell/">Shell零碎知识</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span>
            <a class="archive-post-title" href="/2024/06/28/Linux-Iptables/">Iptables使用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span>
            <a class="archive-post-title" href="/2024/06/28/Linux-Tune/">Linux环境初始化</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span>
            <a class="archive-post-title" href="/2024/06/28/Linux-based/">Linux零碎常识</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span>
            <a class="archive-post-title" href="/2024/06/28/Linux-error/">Linux常见报错记录</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span>
            <a class="archive-post-title" href="/2024/06/28/Nginx/">Nginx详解</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span>
            <a class="archive-post-title" href="/2024/06/23/Virtualization/">虚拟化基础知识</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span>
            <a class="archive-post-title" href="/2024/06/18/Docker-compose/">Docker-compose部署lnmp</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span>
            <a class="archive-post-title" href="/2024/06/18/Ephemeralcontainers/">临时容器ephemeralcontainers</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span>
            <a class="archive-post-title" href="/2024/06/13/Kuboard/">k8s可视化UI界面Kuboard</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span>
            <a class="archive-post-title" href="/2024/06/13/Mongo-k8s/">k8s部署MongoDB主从集群</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/12</span>
            <a class="archive-post-title" href="/2024/06/12/K8s-redis-cluster/">k8s部署Redis高可用集群</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/04</span>
            <a class="archive-post-title" href="/2024/06/04/Playbook/">Playbook实战案例</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/04</span>
            <a class="archive-post-title" href="/2024/06/04/Rook/">Rook部署ceph</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span>
            <a class="archive-post-title" href="/2024/06/02/EFK/">EFK日志处理平台-2</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span>
            <a class="archive-post-title" href="/2024/06/01/K8s-Autoscaler/">k8s自动扩缩容HPA VPA KPA</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span>
            <a class="archive-post-title" href="/2024/06/01/Python-k8s/">Python代码封装至k8s中运行</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span>
            <a class="archive-post-title" href="/2024/06/01/SpringCloud-k8s/">将SpringCloud项目迁移至k8s</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/17</span>
            <a class="archive-post-title" href="/2024/05/17/EFK-k8s/">EFK日志处理平台</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/15</span>
            <a class="archive-post-title" href="/2024/05/15/Linux-Monitor/">Linux单机监控</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/14</span>
            <a class="archive-post-title" href="/2024/05/14/Docker/">Docker管理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2024/05/06/tmux/">linux screen与tmux</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2024/05/06/DevOps/">DevOps工具链</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2024/05/06/Helm/">Helm</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2024/05/06/Istio/">Istio微服务网格</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2024/05/06/Prometheus/">Prometheus普罗米修斯</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2024/05/06/Rancher/">k8s可视化UI界面Rancher</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span>
            <a class="archive-post-title" href="/2024/05/01/Gitlab/">Gitlab</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span>
            <a class="archive-post-title" href="/2024/05/01/Ceph-K8s/">ceph对接k8s</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span>
            <a class="archive-post-title" href="/2024/05/01/Git/">Git代码管理工具</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span>
            <a class="archive-post-title" href="/2024/05/01/Go-k8s/">go代码封装到k8s中运行</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span>
            <a class="archive-post-title" href="/2024/05/01/VMware-I2I/">VMware I2I迁移至PVE 小记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/26</span>
            <a class="archive-post-title" href="/2024/04/26/ESXi/">ESXi物理机安装踩坑汇总</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/26</span>
            <a class="archive-post-title" href="/2024/04/26/Ansible/">Ansible笔记集合</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/23</span>
            <a class="archive-post-title" href="/2024/04/23/root-extend/">根分区扩容小记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2024/03/16/Ceph/">CEPH分布式存储</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span>
            <a class="archive-post-title" href="/2024/02/27/Harbor/">本地部署harbor私有镜像仓库</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span>
            <a class="archive-post-title" href="/2024/02/27/K8s/">k8s基础知识</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span>
            <a class="archive-post-title" href="/2024/02/06/Python/">Python学习笔记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span>
            <a class="archive-post-title" href="/2024/02/06/PVE/">虚拟化系统PVE物理机快速安装指南</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/02</span>
            <a class="archive-post-title" href="/2024/02/02/Hexo/">使用1panel搭建Hexo博客</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/24</span>
            <a class="archive-post-title" href="/2023/12/24/PXE/">PXE安装</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/14</span>
            <a class="archive-post-title" href="/2023/12/14/Nginx+keepalived/">Nginx+keepalived</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/12</span>
            <a class="archive-post-title" href="/2023/11/12/DEBD/">DRBD单活分布式存储</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/27</span>
            <a class="archive-post-title" href="/2023/10/27/Linux-Raid/">基于mdadm创建与管理软raid</a>
        </li>
    
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
        
            <span class="sidebar-tag-name" data-tags="Linux">
                <span class="iconfont-archer">&#xe606;</span>
                Linux
            </span>
        
            <span class="sidebar-tag-name" data-tags="云原生">
                <span class="iconfont-archer">&#xe606;</span>
                云原生
            </span>
        
            <span class="sidebar-tag-name" data-tags="云计算">
                <span class="iconfont-archer">&#xe606;</span>
                云计算
            </span>
        
            <span class="sidebar-tag-name" data-tags="开发">
                <span class="iconfont-archer">&#xe606;</span>
                开发
            </span>
        
            <span class="sidebar-tag-name" data-tags="mysql">
                <span class="iconfont-archer">&#xe606;</span>
                mysql
            </span>
        
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://akemi.zj.cn",
        root: siteMetaRoot,
        author: "王盛"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->


        <!-- main func -->
        <script src="/scripts/main.js?v=20211217"></script>
        <!-- dark mode -->
        <script src="/scripts/dark.js?v=20211217"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" defer></script>
        <!-- algolia -->
        
        <!-- busuanzi -->
        
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        
        <!-- CNZZ -->
        
        <!-- async load share.js -->
        
            <script src="/scripts/share.js?v=20211217" async></script>
        
        <!-- mermaid -->
        
    </body>
</html>
